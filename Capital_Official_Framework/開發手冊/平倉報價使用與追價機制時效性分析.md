# å¹³å€‰å ±åƒ¹ä½¿ç”¨èˆ‡è¿½åƒ¹æ©Ÿåˆ¶æ™‚æ•ˆæ€§åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”é‡å°æ‚¨çš„å•é¡Œï¼Œè©³ç´°åˆ†æå¹³å€‰æ™‚å ±åƒ¹çš„ä½¿ç”¨æ©Ÿåˆ¶å’Œè¿½åƒ¹æ™‚å ±åƒ¹çš„æ™‚æ•ˆæ€§ï¼Œç¢ºèªå¹³å€‰ä¸‹å–®å’Œè¿½åƒ¹æ©Ÿåˆ¶ä¸­ bid1/ask1 çš„ä¾†æºå’Œæ™‚é–“é»ã€‚

## ğŸ¯ 1. å¹³å€‰æ™‚å ±åƒ¹ä½¿ç”¨æ©Ÿåˆ¶ç¢ºèª

### 1.1 å¹³å€‰ä¸‹å–®åƒ¹æ ¼é¸æ“‡

**ç¢ºèªï¼šæ˜¯çš„ï¼Œå¹³å€‰æ™‚ä½¿ç”¨ç•¶ä¸‹æ”¶åˆ°å ±åƒ¹çš„ ask1/bid1 é€å‡º FOK**

**VirtualRealOrderManager ä¸­çš„åƒ¹æ ¼é¸æ“‡é‚è¼¯**:

```python
def get_exit_price(self, position_direction: str, product: str) -> Optional[float]:
    """å–å¾—å‡ºå ´åƒ¹æ ¼ - æ ¹æ“šéƒ¨ä½æ–¹å‘é¸æ“‡BID1æˆ–ASK1"""
    try:
        if position_direction.upper() == "LONG":
            # ğŸ”§ å¤šå–®å‡ºå ´ â†’ è³£å‡º â†’ ä½¿ç”¨BID1åƒ¹æ ¼
            price = self.get_bid1_price(product)
            if self.console_enabled and price:
                print(f"[EXIT_PRICE] å¤šå–®å‡ºå ´ä½¿ç”¨BID1: {price}")
            return price

        elif position_direction.upper() == "SHORT":
            # ğŸ”§ ç©ºå–®å‡ºå ´ â†’ è²·å› â†’ ä½¿ç”¨ASK1åƒ¹æ ¼
            price = self.get_ask1_price(product)
            if self.console_enabled and price:
                print(f"[EXIT_PRICE] ç©ºå–®å‡ºå ´ä½¿ç”¨ASK1: {price}")
            return price
    except Exception as e:
        return None
```

**å¹³å€‰åƒ¹æ ¼ä½¿ç”¨è¦å‰‡**:
- **å¤šå–®å¹³å€‰**: ä½¿ç”¨ **BID1** åƒ¹æ ¼ï¼ˆè³£çµ¦å¸‚å ´è²·æ–¹ï¼Œç«‹å³æˆäº¤ï¼‰
- **ç©ºå–®å¹³å€‰**: ä½¿ç”¨ **ASK1** åƒ¹æ ¼ï¼ˆå¾å¸‚å ´è³£æ–¹è²·å›ï¼Œç«‹å³æˆäº¤ï¼‰

### 1.2 å ±åƒ¹å–å¾—æ©Ÿåˆ¶

**å ±åƒ¹ä¾†æº**: `RealTimeQuoteManager`

```python
def get_best_bid_price(self, product_code: str) -> Optional[float]:
    """å–å¾—æœ€ä½³è²·åƒ¹ - å¤šå–®å‡ºå ´ä½¿ç”¨"""
    try:
        with self.data_lock:
            if product_code not in self.quote_data:
                return None

            quote = self.quote_data[product_code]

            # ğŸ• æª¢æŸ¥æ•¸æ“šæ–°é®®åº¦
            if not self.is_quote_fresh(product_code):
                if self.console_enabled:
                    print(f"[QUOTE_MGR] âš ï¸ {product_code} å ±åƒ¹æ•¸æ“šéæœŸ")
                return None

            # è¿”å›æœ€ä½³è²·åƒ¹ (BID1)
            bid1 = quote.bid_prices[0] if quote.bid_prices else None

            if bid1 is not None and bid1 > 0:
                return float(bid1)

            return None
    except Exception as e:
        return None
```

**å ±åƒ¹æ–°é®®åº¦æª¢æŸ¥**:
```python
def is_quote_fresh(self, product_code: str, max_age_seconds: int = None) -> bool:
    """æª¢æŸ¥å ±åƒ¹æ–°é®®åº¦"""
    try:
        if product_code not in self.quote_data:
            return False
        
        quote = self.quote_data[product_code]
        
        if quote.last_update is None:
            return False
        
        max_age = max_age_seconds or self.max_data_age_seconds  # é è¨­10ç§’
        age = (datetime.now() - quote.last_update).total_seconds()
        
        return age <= max_age
    except Exception as e:
        return False
```

## ğŸ”„ 2. è¿½åƒ¹æ©Ÿåˆ¶ä¸­çš„å ±åƒ¹æ™‚æ•ˆæ€§

### 2.1 è¿½åƒ¹è§¸ç™¼æ™‚é–“é»

**è¿½åƒ¹è§¸ç™¼æµç¨‹**:
1. **FOK ä¸‹å–®å¤±æ•—** â†’ æ”¶åˆ°å–æ¶ˆå›å ±
2. **SimplifiedOrderTracker è­˜åˆ¥** â†’ è§¸ç™¼è¿½åƒ¹å›èª¿
3. **è¿½åƒ¹å›èª¿åŸ·è¡Œ** â†’ èª¿ç”¨ `_calculate_exit_retry_price()`
4. **é‡æ–°å–å¾—å ±åƒ¹** â†’ è¨ˆç®—è¿½åƒ¹åƒ¹æ ¼
5. **åŸ·è¡Œè¿½åƒ¹ä¸‹å–®** â†’ ä½¿ç”¨æ–°çš„è¿½åƒ¹åƒ¹æ ¼

### 2.2 è¿½åƒ¹æ™‚å ±åƒ¹å–å¾—

**é—œéµå•é¡Œï¼šè¿½åƒ¹æ™‚çš„ bid1-1 ä¸­çš„ bid1 æ˜¯å¾å“ªä¾†çš„ï¼Ÿ**

**ç­”æ¡ˆï¼šè¿½åƒ¹æ™‚æœƒé‡æ–°å³æ™‚å–å¾—æœ€æ–°çš„ bid1/ask1 å ±åƒ¹**

**è¿½åƒ¹åƒ¹æ ¼è¨ˆç®—å‡½æ•¸**: `_calculate_exit_retry_price()`

```python
def _calculate_exit_retry_price(self, original_direction: str, retry_count: int) -> Optional[float]:
    """è¨ˆç®—å¹³å€‰è¿½åƒ¹åƒ¹æ ¼"""
    try:
        product = "TM0000"  # é è¨­ä½¿ç”¨å¾®å‹å°æŒ‡

        # ğŸ”§ é‡æ–°å–å¾—ç•¶å‰å ±åƒ¹ï¼ˆä¸æ˜¯ä½¿ç”¨èˆŠå ±åƒ¹ï¼‰
        current_ask1 = None
        current_bid1 = None

        # æ–¹æ³•1: å¾ä¸‹å–®ç®¡ç†å™¨å–å¾—å ±åƒ¹
        if hasattr(self, 'virtual_real_order_manager') and self.virtual_real_order_manager:
            try:
                if hasattr(self.virtual_real_order_manager, 'get_ask1_price'):
                    current_ask1 = self.virtual_real_order_manager.get_ask1_price(product)
                if hasattr(self.virtual_real_order_manager, 'get_bid1_price'):
                    current_bid1 = self.virtual_real_order_manager.get_bid1_price(product)
            except:
                pass

        # æª¢æŸ¥æ˜¯å¦æˆåŠŸç²å–å¸‚åƒ¹
        if current_ask1 > 0 and current_bid1 > 0:
            if original_direction.upper() == "LONG":
                # ğŸ”§ å¤šå–®å¹³å€‰ï¼šä½¿ç”¨BID1 - retry_counté» (å‘ä¸‹è¿½åƒ¹)
                retry_price = current_bid1 - retry_count
                if self.console_enabled:
                    print(f"[MAIN] ğŸ”„ å¤šå–®å¹³å€‰è¿½åƒ¹è¨ˆç®—: BID1({current_bid1}) - {retry_count} = {retry_price}")
                return retry_price
            elif original_direction.upper() == "SHORT":
                # ğŸ”§ ç©ºå–®å¹³å€‰ï¼šä½¿ç”¨ASK1 + retry_counté» (å‘ä¸Šè¿½åƒ¹)
                retry_price = current_ask1 + retry_count
                if self.console_enabled:
                    print(f"[MAIN] ğŸ”„ ç©ºå–®å¹³å€‰è¿½åƒ¹è¨ˆç®—: ASK1({current_ask1}) + {retry_count} = {retry_price}")
                return retry_price
        else:
            if self.console_enabled:
                print(f"[MAIN] âŒ ç„¡æ³•ç²å–æœ‰æ•ˆå¸‚åƒ¹: ASK1={current_ask1}, BID1={current_bid1}")

        return None
    except Exception as e:
        return None
```

### 2.3 å ±åƒ¹æ›´æ–°æ©Ÿåˆ¶

**å ±åƒ¹å³æ™‚æ›´æ–°**: é€šé `OnNotifyBest5LONG` äº‹ä»¶

```python
def update_best5_data(self, market_no, stock_idx, 
                     ask1, ask1_qty, ask2, ask2_qty, ask3, ask3_qty,
                     ask4, ask4_qty, ask5, ask5_qty,
                     bid1, bid1_qty, bid2, bid2_qty, bid3, bid3_qty,
                     bid4, bid4_qty, bid5, bid5_qty,
                     product_code=None):
    """æ›´æ–°äº”æª”æ•¸æ“š - å¾OnNotifyBest5LONGäº‹ä»¶èª¿ç”¨"""
    try:
        with self.data_lock:
            # åˆå§‹åŒ–æˆ–å–å¾—å ±åƒ¹æ•¸æ“š
            if product_code not in self.quote_data:
                self.quote_data[product_code] = QuoteData()
            
            quote = self.quote_data[product_code]
            
            # ğŸ”„ æ›´æ–°äº”æª”ASKæ•¸æ“š
            quote.ask_prices = [ask1, ask2, ask3, ask4, ask5]
            quote.ask_quantities = [ask1_qty, ask2_qty, ask3_qty, ask4_qty, ask5_qty]
            
            # ğŸ”„ æ›´æ–°äº”æª”BIDæ•¸æ“š
            quote.bid_prices = [bid1, bid2, bid3, bid4, bid5]
            quote.bid_quantities = [bid1_qty, bid2_qty, bid3_qty, bid4_qty, bid5_qty]
            
            # ğŸ• æ›´æ–°æ™‚é–“æˆ³
            quote.last_update = datetime.now()
            quote.update_count += 1
            
            return True
    except Exception as e:
        return False
```

**å ±åƒ¹æ•¸æ“šçµæ§‹**:
```python
class QuoteData:
    """å ±åƒ¹æ•¸æ“šçµæ§‹"""
    def __init__(self):
        # äº”æª”ASKæ•¸æ“š
        self.ask_prices = [None] * 5      # [ask1, ask2, ask3, ask4, ask5]
        self.ask_quantities = [None] * 5  # [qty1, qty2, qty3, qty4, qty5]
        
        # äº”æª”BIDæ•¸æ“š
        self.bid_prices = [None] * 5      # [bid1, bid2, bid3, bid4, bid5]
        self.bid_quantities = [None] * 5  # [qty1, qty2, qty3, qty4, qty5]
        
        # ğŸ• æ™‚é–“æˆ³
        self.last_update = None           # æœ€å¾Œæ›´æ–°æ™‚é–“
        self.update_count = 0             # æ›´æ–°æ¬¡æ•¸
```

## â° 3. è¿½åƒ¹æ™‚å ±åƒ¹çš„æ™‚æ•ˆæ€§åˆ†æ

### 3.1 å ±åƒ¹æ™‚æ•ˆæ€§ä¿è­‰

**æ™‚æ•ˆæ€§æª¢æŸ¥æ©Ÿåˆ¶**:
- **æœ€å¤§æœ‰æ•ˆæœŸ**: 10ç§’ (`max_data_age_seconds = 10`)
- **å³æ™‚æ›´æ–°**: é€šé COM äº‹ä»¶å³æ™‚æ¥æ”¶å ±åƒ¹
- **æ–°é®®åº¦é©—è­‰**: æ¯æ¬¡å–å¾—å ±åƒ¹éƒ½æœƒæª¢æŸ¥æ™‚æ•ˆæ€§

**æ™‚æ•ˆæ€§æª¢æŸ¥æµç¨‹**:
```python
# 1. è¿½åƒ¹è§¸ç™¼æ™‚é‡æ–°å–å¾—å ±åƒ¹
current_bid1 = self.virtual_real_order_manager.get_bid1_price(product)

# 2. get_bid1_price() å…§éƒ¨æœƒæª¢æŸ¥æ–°é®®åº¦
if not self.is_quote_fresh(product_code):
    print(f"[QUOTE_MGR] âš ï¸ {product_code} å ±åƒ¹æ•¸æ“šéæœŸ")
    return None

# 3. åªæœ‰æ–°é®®çš„å ±åƒ¹æ‰æœƒè¢«ä½¿ç”¨
age = (datetime.now() - quote.last_update).total_seconds()
return age <= max_age  # é è¨­10ç§’
```

### 3.2 è¿½åƒ¹æ™‚é–“é»åˆ†æ

**è¿½åƒ¹åŸ·è¡Œæ™‚åº**:

```
æ™‚é–“é» T0: åˆå§‹å¹³å€‰ä¸‹å–® (ä½¿ç”¨ BID1_T0)
         â†“
æ™‚é–“é» T1: FOK å¤±æ•—ï¼Œæ”¶åˆ°å–æ¶ˆå›å ±
         â†“
æ™‚é–“é» T2: è§¸ç™¼è¿½åƒ¹å›èª¿
         â†“
æ™‚é–“é» T3: é‡æ–°å–å¾—å ±åƒ¹ (ä½¿ç”¨ BID1_T3ï¼Œä¸æ˜¯ BID1_T0)
         â†“
æ™‚é–“é» T4: è¨ˆç®—è¿½åƒ¹åƒ¹æ ¼ (BID1_T3 - retry_count)
         â†“
æ™‚é–“é» T5: åŸ·è¡Œè¿½åƒ¹ä¸‹å–®
```

**é—œéµç™¼ç¾**:
- **è¿½åƒ¹æ™‚çš„ BID1 æ˜¯ T3 æ™‚é–“é»çš„æœ€æ–°å ±åƒ¹ï¼Œä¸æ˜¯ T0 æ™‚é–“é»çš„èˆŠå ±åƒ¹**
- **æ¯æ¬¡è¿½åƒ¹éƒ½æœƒé‡æ–°å–å¾—ç•¶ä¸‹æœ€æ–°çš„å¸‚å ´å ±åƒ¹**
- **å ±åƒ¹æœ‰ 10 ç§’çš„æ–°é®®åº¦ä¿è­·ï¼Œç¢ºä¿ä¸æœƒä½¿ç”¨éæœŸæ•¸æ“š**

### 3.3 å ±åƒ¹æ›´æ–°é »ç‡

**å ±åƒ¹æ›´æ–°ç‰¹é»**:
- **å³æ™‚æ›´æ–°**: é€šé COM äº‹ä»¶å³æ™‚æ¥æ”¶
- **ç·šç¨‹å®‰å…¨**: ä½¿ç”¨ `threading.Lock()` ä¿è­·æ•¸æ“š
- **çµ±è¨ˆè¼¸å‡º**: æ¯ 100 æ¬¡æ›´æ–°è¼¸å‡ºä¸€æ¬¡çµ±è¨ˆ

```python
# çµ±è¨ˆæ›´æ–°
self.total_updates += 1

# Consoleè¼¸å‡º (å¯æ§åˆ¶)
if self.console_enabled and self.total_updates % 100 == 0:  # æ¯100æ¬¡æ›´æ–°è¼¸å‡ºä¸€æ¬¡
    print(f"[QUOTE_MGR] {product_code} äº”æª”æ›´æ–° #{quote.update_count} ASK1:{ask1} BID1:{bid1}")
```

## ğŸ“Š 4. ç¸½çµç¢ºèª

### 4.1 å¹³å€‰å ±åƒ¹ä½¿ç”¨ç¢ºèª

âœ… **ç¢ºèª**ï¼šå¹³å€‰æ™‚ç¢ºå¯¦ä½¿ç”¨ç•¶ä¸‹æ”¶åˆ°å ±åƒ¹çš„ ask1/bid1 é€å‡º FOK
- **å¤šå–®å¹³å€‰**: ä½¿ç”¨ BID1 åƒ¹æ ¼
- **ç©ºå–®å¹³å€‰**: ä½¿ç”¨ ASK1 åƒ¹æ ¼
- **å³æ™‚å–å¾—**: é€šé `RealTimeQuoteManager` å³æ™‚å–å¾—æœ€æ–°å ±åƒ¹

### 4.2 è¿½åƒ¹å ±åƒ¹ä¾†æºç¢ºèª

âœ… **ç¢ºèª**ï¼šè¿½åƒ¹æ™‚çš„ bid1-1 ä¸­çš„ bid1 æ˜¯**é‡æ–°å–å¾—çš„æœ€æ–°å ±åƒ¹**
- **ä¸æ˜¯èˆŠå ±åƒ¹**: è¿½åƒ¹æ™‚æœƒé‡æ–°èª¿ç”¨ `get_bid1_price()` å–å¾—æœ€æ–°å ±åƒ¹
- **æ™‚æ•ˆæ€§ä¿è­‰**: æœ‰ 10 ç§’æ–°é®®åº¦æª¢æŸ¥ï¼Œç¢ºä¿å ±åƒ¹æ™‚æ•ˆæ€§
- **å³æ™‚æ›´æ–°**: å ±åƒ¹é€šé COM äº‹ä»¶å³æ™‚æ›´æ–°åˆ° `RealTimeQuoteManager`

### 4.3 è¿½åƒ¹æ©Ÿåˆ¶æ™‚åº

**è¿½åƒ¹æµç¨‹æ™‚åº**:
1. **T0**: åˆå§‹å¹³å€‰ä¸‹å–® (BID1_T0)
2. **T1**: FOK å¤±æ•—
3. **T2**: è§¸ç™¼è¿½åƒ¹
4. **T3**: **é‡æ–°å–å¾—æœ€æ–° BID1** (BID1_T3)
5. **T4**: è¨ˆç®—è¿½åƒ¹åƒ¹æ ¼ (BID1_T3 - retry_count)
6. **T5**: åŸ·è¡Œè¿½åƒ¹ä¸‹å–®

**é—œéµçµè«–**:
- è¿½åƒ¹æ™‚ä½¿ç”¨çš„æ˜¯**ç•¶ä¸‹æœ€æ–°çš„å¸‚å ´å ±åƒ¹**ï¼Œä¸æ˜¯åˆå§‹ä¸‹å–®æ™‚çš„èˆŠå ±åƒ¹
- ç³»çµ±æœ‰å®Œæ•´çš„å ±åƒ¹æ™‚æ•ˆæ€§ä¿è­·æ©Ÿåˆ¶
- æ¯æ¬¡è¿½åƒ¹éƒ½ç¢ºä¿ä½¿ç”¨æœ€æ–°ã€æœ‰æ•ˆçš„å¸‚å ´åƒ¹æ ¼

é€™å€‹è¨­è¨ˆç¢ºä¿äº†è¿½åƒ¹æ©Ÿåˆ¶çš„æœ‰æ•ˆæ€§å’Œå¸‚å ´é©æ‡‰æ€§ï¼Œé¿å…ä½¿ç”¨éæœŸå ±åƒ¹å°è‡´çš„è¿½åƒ¹å¤±æ•ˆå•é¡Œã€‚
