# 🧹 測試環境清理腳本使用說明

## 📋 概述

為了解決停損問題和確保測試環境乾淨，我們提供了三個清理腳本：

1. **`one_click_cleanup.py`** - 🚀 **推薦使用** - 一鍵徹底清理
2. **`cleanup_test_positions.py`** - 🔧 詳細清理選項
3. **`clear_memory_states.py`** - 🧠 內存狀態清理

## 🚀 推薦使用方法

### 方法1：簡化清理（最穩定）**推薦**

```bash
cd C:\Users\zacip\OneDrive\文件\my-capital-project\capital-futures-docs\Capital_Official_Framework

# 快速狀態檢查
python simple_cleanup.py status

# 互動式清理
python simple_cleanup.py

# 強制清理（不詢問）
python simple_cleanup.py force
```

**特點：**
- ✅ 修復了SQLite Row對象問題
- ✅ 提供多種清理模式
- ✅ 更穩定的錯誤處理
- ✅ 快速狀態檢查功能

### 方法2：緊急清理（如果Python腳本失敗）

```bash
# 雙擊執行批處理文件
run_emergency_cleanup.bat
```

**特點：**
- ✅ 直接使用SQL清理
- ✅ 不依賴Python環境
- ✅ 適合緊急情況使用

### 方法3：一鍵清理（原版）

```bash
python one_click_cleanup.py
```

**特點：**
- ✅ 自動檢測需要清理的數據
- ✅ 一次性清理所有狀態
- ✅ 包含資料庫和內存清理
- ✅ 提供清理結果驗證

### 方法2：詳細清理（可選擇清理方式）

```bash
python cleanup_test_positions.py
```

**清理選項：**
1. **完全重置** - 刪除所有測試數據（推薦）
2. **標記為已出場** - 保留記錄但標記為已平倉
3. **標記為失敗** - 標記為測試失敗數據
4. **徹底清理** - 刪除所有相關記錄

## 🔧 清理內容

### 資料庫清理
- ✅ 活躍部位記錄 (`position_records` 表)
- ✅ 風險管理狀態 (`risk_management_states` 表)
- ✅ 今日策略組 (`strategy_groups` 表)
- ✅ 舊報價數據 (`real_time_quotes` 表)
- ✅ 測試相關記錄

### 內存狀態清理
- ✅ `GlobalExitManager` 鎖定狀態
- ✅ `OptimizedRiskManager` 緩存
- ✅ `SimplifiedOrderTracker` 狀態
- ✅ 追蹤器內存數據

## 🎯 使用時機

### 測試前必須清理
```bash
# 推薦：每次測試前執行
python simple_cleanup.py status  # 先檢查狀態
python simple_cleanup.py force   # 強制清理（如果有數據）
```

### 遇到停損問題時
```bash
# 如果遇到"停損被全局管理器阻止"錯誤
python simple_cleanup.py force
# 然後重啟 simple_integrated.py
```

### 測試環境重置
```bash
# 想要完全重新開始測試
python simple_cleanup.py force
```

### 緊急情況
```bash
# 如果Python腳本都失敗
雙擊 run_emergency_cleanup.bat
```

## 📊 清理效果驗證

清理後應該看到：
```
📊 清理後狀態:
   - 活躍部位: 0
   - 已出場部位: X (保留歷史記錄)
   - 失敗部位: X (保留歷史記錄)
   - 風險管理狀態: 0
   - 今日策略組: 0
```

## ⚠️ 重要注意事項

### 1. 程序狀態
- **建議在 simple_integrated.py 停止時執行清理**
- 如果程序正在運行，清理後需要重啟程序

### 2. 數據備份
- 清理會刪除測試數據，但保留歷史交易記錄
- 如需完全備份，請先複製 `multi_group_strategy.db` 檔案

### 3. 清理順序
```
1. 停止 simple_integrated.py
2. 執行清理腳本
3. 重啟 simple_integrated.py
4. 開始新的測試
```

## 🔍 故障排除

### 問題1：仍然出現停損被阻止
```bash
# 解決方案：
1. python one_click_cleanup.py
2. 重啟 simple_integrated.py
3. 如果仍有問題，刪除 multi_group_strategy.db 檔案
```

### 問題2：清理腳本執行失敗
```bash
# 檢查：
1. 確認在正確目錄執行
2. 確認 Python 環境正確
3. 確認資料庫檔案沒有被其他程序鎖定
```

### 問題3：內存狀態未清除
```bash
# 解決方案：
1. 重啟 simple_integrated.py 程序
2. 或執行 clear_memory_states.py
```

## 💡 最佳實踐

### 測試流程建議
```
1. 停止程序
2. python one_click_cleanup.py
3. 重啟程序
4. 開始測試
5. 測試完成後重複步驟1-2
```

### 定期維護
- 每日測試結束後執行清理
- 遇到異常行為時立即清理
- 重要測試前必須清理

## 📞 技術支援

如果清理後仍有問題：
1. 檢查清理腳本輸出的錯誤信息
2. 確認程序已完全重啟
3. 檢查資料庫檔案權限
4. 考慮手動刪除 `multi_group_strategy.db` 檔案重新開始

---

**記住：乾淨的測試環境是穩定測試的基礎！** 🎯
