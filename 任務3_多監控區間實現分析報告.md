# ä»»å‹™3ï¼šå¤šç›£æ§å€é–“å¯¦ç¾åˆ†æå ±å‘Š

## ğŸ“‹ **è©•ä¼°æ¦‚è¿°**

æœ¬å ±å‘ŠåŸºæ–¼ä»»å‹™1çš„è‡ªå®šç¾©æ™‚é–“ç¯„åœåŠŸèƒ½ï¼Œåˆ†æè™›æ“¬äº¤æ˜“ç³»çµ± `virtual_simple_integrated.py` å¦‚ä½•æ”¯æ´å¤šå€‹ç›£æ§å€é–“çš„å¯¦ç¾ã€‚

**ç›®æ¨™æ ¼å¼**ï¼šç”¨æˆ¶è¼¸å…¥ã€Œ08:58-09:02, 10:15-10:30ã€æ”¯æ´å¤šå€‹åˆ†é›¢çš„ç›£æ§æ™‚æ®µ

---

## ğŸ” **ç•¶å‰å–®ä¸€å€é–“æ©Ÿåˆ¶åˆ†æ**

### **1. ç¾æœ‰å€é–“ç®¡ç†æ¶æ§‹**

#### **å€é–“ç‹€æ…‹è®Šæ•¸**
```python
# ç•¶å‰å–®ä¸€å€é–“ç‹€æ…‹ç®¡ç† (ç¬¬168-178è¡Œ)
self.range_high = 0
self.range_low = 0
self.range_calculated = False
self.in_range_period = False
self.range_prices = []
self.range_start_hour = 8
self.range_start_minute = 46
self._last_range_minute = None
self._range_start_time = ""
```

#### **å€é–“è¨ˆç®—é‚è¼¯**
```python
# å–®ä¸€å€é–“è™•ç†æµç¨‹ (ç¬¬3270-3308è¡Œ)
def update_range_calculation_safe(self, price, time_str):
    # æª¢æŸ¥æ˜¯å¦åœ¨å€é–“æ™‚é–“å…§
    if self.is_in_range_time_safe(time_str):
        if not self.in_range_period:
            # é–‹å§‹æ”¶é›†å€é–“æ•¸æ“š
            self.in_range_period = True
            self.range_prices = []
            self._range_start_time = time_str
        
        # æ”¶é›†åƒ¹æ ¼æ•¸æ“š
        self.range_prices.append(price)
    
    elif self.in_range_period and not self.range_calculated:
        # å€é–“çµæŸï¼Œè¨ˆç®—é«˜ä½é»
        self.range_high = max(self.range_prices)
        self.range_low = min(self.range_prices)
        self.range_calculated = True
        self.in_range_period = False
```

#### **æ™‚é–“æª¢æŸ¥æ©Ÿåˆ¶**
```python
# å–®ä¸€æ™‚é–“ç¯„åœæª¢æŸ¥ (ç¬¬3310-3320è¡Œ)
def is_in_range_time_safe(self, time_str):
    """å®‰å…¨çš„æ™‚é–“æª¢æŸ¥ - ç²¾ç¢º20ç§’å€é–“"""
    hour, minute, second = map(int, time_str.split(':'))
    current_total_seconds = hour * 3600 + minute * 60 + second
    start_total_seconds = self.range_start_hour * 3600 + self.range_start_minute * 60
    end_total_seconds = start_total_seconds + 20  # å›ºå®š20ç§’
    
    return start_total_seconds <= current_total_seconds < end_total_seconds
```

---

## ğŸ¯ **å¤šç›£æ§å€é–“å¯¦ç¾æ–¹æ¡ˆ**

### **æ–¹æ¡ˆ1ï¼šå€é–“é›†åˆç®¡ç†å™¨**

#### **å¤šå€é–“æ•¸æ“šçµæ§‹**
```python
class MultiRangeManager:
    """å¤šå€é–“ç®¡ç†å™¨"""
    
    def __init__(self):
        self.ranges = []  # å€é–“åˆ—è¡¨
        self.current_active_range = None
        self.completed_ranges = []
        
    def add_range(self, start_time, end_time, range_id=None):
        """æ·»åŠ ç›£æ§å€é–“"""
        range_config = {
            'id': range_id or f"range_{len(self.ranges)}",
            'start_time': start_time,
            'end_time': end_time,
            'status': 'PENDING',
            'prices': [],
            'high': None,
            'low': None,
            'calculated': False
        }
        self.ranges.append(range_config)
        return range_config['id']
        
    def get_active_range(self, current_time):
        """å–å¾—ç•¶å‰æ´»èºçš„å€é–“"""
        for range_config in self.ranges:
            if self._is_time_in_range(current_time, range_config):
                return range_config
        return None
        
    def _is_time_in_range(self, current_time, range_config):
        """æª¢æŸ¥æ™‚é–“æ˜¯å¦åœ¨æŒ‡å®šå€é–“å…§"""
        start_seconds = self._time_to_seconds(range_config['start_time'])
        end_seconds = self._time_to_seconds(range_config['end_time'])
        current_seconds = self._time_to_seconds(current_time)
        
        return start_seconds <= current_seconds < end_seconds
```

#### **å¤šå€é–“è§£æé‚è¼¯**
```python
def parse_multiple_ranges(self, time_input):
    """è§£æå¤šå€‹æ™‚é–“å€é–“"""
    # æ”¯æ´æ ¼å¼ï¼š
    # "08:58-09:02, 10:15-10:30"
    # "08:58:30-09:02:15, 10:15:00-10:30:00"
    
    ranges = []
    time_input = time_input.replace(' ', '')  # ç§»é™¤ç©ºæ ¼
    
    # åˆ†å‰²å¤šå€‹å€é–“
    range_parts = time_input.split(',')
    
    for i, range_part in enumerate(range_parts):
        if '-' in range_part:
            start_str, end_str = range_part.split('-', 1)
            start_time = self._parse_single_time(start_str)
            end_time = self._parse_single_time(end_str)
            
            ranges.append({
                'id': f"range_{i+1}",
                'start_time': start_time,
                'end_time': end_time,
                'status': 'PENDING'
            })
        else:
            raise ValueError(f"å€é–“æ ¼å¼éŒ¯èª¤: {range_part}")
    
    return ranges
```

### **æ–¹æ¡ˆ2ï¼šç‹€æ…‹æ©Ÿé©…å‹•çš„å¤šå€é–“è™•ç†**

#### **å€é–“ç‹€æ…‹æ©Ÿ**
```python
class RangeStateMachine:
    """å€é–“ç‹€æ…‹æ©Ÿ"""
    
    STATES = {
        'WAITING': 'ç­‰å¾…é–‹å§‹',
        'COLLECTING': 'æ”¶é›†æ•¸æ“šä¸­',
        'COMPLETED': 'å·²å®Œæˆ',
        'SKIPPED': 'å·²è·³é'
    }
    
    def __init__(self):
        self.ranges = {}
        self.current_range_id = None
        
    def update_range_state(self, range_id, new_state, data=None):
        """æ›´æ–°å€é–“ç‹€æ…‹"""
        if range_id in self.ranges:
            old_state = self.ranges[range_id]['status']
            self.ranges[range_id]['status'] = new_state
            
            if data:
                self.ranges[range_id].update(data)
                
            self._on_state_changed(range_id, old_state, new_state)
            
    def _on_state_changed(self, range_id, old_state, new_state):
        """ç‹€æ…‹è®Šæ›´è™•ç†"""
        if new_state == 'COLLECTING':
            self._start_data_collection(range_id)
        elif new_state == 'COMPLETED':
            self._finalize_range_calculation(range_id)
            self._prepare_next_range()
```

### **æ–¹æ¡ˆ3ï¼šäº‹ä»¶é©…å‹•çš„å¤šå€é–“å”èª¿**

#### **å€é–“äº‹ä»¶ç®¡ç†å™¨**
```python
class RangeEventManager:
    """å€é–“äº‹ä»¶ç®¡ç†å™¨"""
    
    def __init__(self):
        self.event_handlers = {
            'RANGE_START': self._handle_range_start,
            'RANGE_END': self._handle_range_end,
            'RANGE_DATA_COLLECTED': self._handle_data_collected,
            'ALL_RANGES_COMPLETED': self._handle_all_completed
        }
        self.active_ranges = {}
        
    def process_tick(self, price, time_str):
        """è™•ç†å ±åƒ¹tick"""
        current_time = self._parse_time(time_str)
        
        # æª¢æŸ¥æ‰€æœ‰å€é–“
        for range_id, range_config in self.ranges.items():
            if self._should_start_range(range_config, current_time):
                self._emit_event('RANGE_START', {
                    'range_id': range_id,
                    'start_time': current_time,
                    'price': price
                })
            elif self._should_end_range(range_config, current_time):
                self._emit_event('RANGE_END', {
                    'range_id': range_id,
                    'end_time': current_time,
                    'price': price
                })
            elif self._is_range_active(range_config, current_time):
                self._emit_event('RANGE_DATA_COLLECTED', {
                    'range_id': range_id,
                    'price': price,
                    'time': current_time
                })
```

---

## âš ï¸ **é¢¨éšªè©•ä¼°**

### **ğŸ”´ é«˜é¢¨éšªé …ç›®**

#### **1. ç‹€æ…‹ç®¡ç†è¤‡é›œæ€§**
- **é¢¨éšª**ï¼šå¤šå€‹å€é–“åŒæ™‚è™•ç†æ™‚çš„ç‹€æ…‹è¡çª
- **å½±éŸ¿**ï¼šæ•¸æ“šæ··äº‚ï¼Œè¨ˆç®—éŒ¯èª¤
- **æ¡ˆä¾‹**ï¼šå…©å€‹å€é–“æ™‚é–“é‡ç–Šæ™‚çš„è™•ç†é‚è¼¯
- **ç·©è§£**ï¼šå¯¦ç¾åš´æ ¼çš„ç‹€æ…‹éš”é›¢å’Œè¡çªæª¢æ¸¬

#### **2. è¨˜æ†¶é«”ä½¿ç”¨å¢é•·**
- **é¢¨éšª**ï¼šå¤šå€‹å€é–“çš„åƒ¹æ ¼æ•¸æ“šåŒæ™‚å­˜å„²
- **å½±éŸ¿**ï¼šè¨˜æ†¶é«”æ¶ˆè€—å¤§å¹…å¢åŠ 
- **è¨ˆç®—**ï¼š10å€‹å€é–“ Ã— æ¯å€é–“1000ç­†åƒ¹æ ¼ = 10,000ç­†æ•¸æ“š
- **ç·©è§£**ï¼šå¯¦ç¾æ•¸æ“šæ¸…ç†å’Œå£“ç¸®æ©Ÿåˆ¶

#### **3. ç­–ç•¥è§¸ç™¼é‚è¼¯è¡çª**
- **é¢¨éšª**ï¼šå¤šå€‹å€é–“å®Œæˆæ™‚çš„ç­–ç•¥å•Ÿå‹•è¡çª
- **å½±éŸ¿**ï¼šé‡è¤‡ä¸‹å–®æˆ–ç­–ç•¥æ··äº‚
- **ç¾æœ‰å•é¡Œ**ï¼š`_auto_start_triggered` åªæ”¯æ´å–®ä¸€è§¸ç™¼
- **è§£æ±º**ï¼šéœ€è¦é‡æ–°è¨­è¨ˆè§¸ç™¼æ©Ÿåˆ¶

### **ğŸŸ¡ ä¸­é¢¨éšªé …ç›®**

#### **1. æ™‚é–“è§£æè¤‡é›œæ€§**
- **é¢¨éšª**ï¼šè¤‡é›œçš„æ™‚é–“æ ¼å¼è§£æå¯èƒ½å‡ºéŒ¯
- **å½±éŸ¿**ï¼šå€é–“è¨­å®šå¤±æ•—
- **å»ºè­°**ï¼šå¢å¼·è¼¸å…¥é©—è­‰å’ŒéŒ¯èª¤æç¤º

#### **2. UIé¡¯ç¤ºæŒ‘æˆ°**
- **é¢¨éšª**ï¼šå¤šå€‹å€é–“çš„ç‹€æ…‹é¡¯ç¤ºè¤‡é›œ
- **å½±éŸ¿**ï¼šç”¨æˆ¶é«”é©—ä¸‹é™
- **å»ºè­°**ï¼šè¨­è¨ˆæ¸…æ™°çš„å¤šå€é–“é¡¯ç¤ºç•Œé¢

#### **3. æ€§èƒ½å½±éŸ¿**
- **é¢¨éšª**ï¼šæ¯å€‹tickéœ€è¦æª¢æŸ¥å¤šå€‹å€é–“
- **å½±éŸ¿**ï¼šè™•ç†å»¶é²å¢åŠ 
- **è©•ä¼°**ï¼šO(n) è¤‡é›œåº¦ï¼Œnç‚ºå€é–“æ•¸é‡

### **ğŸŸ¢ ä½é¢¨éšªé …ç›®**

#### **1. é…ç½®å­˜å„²**
- **è©•ä¼°**ï¼šå¤šå€é–“é…ç½®å­˜å„²ç›¸å°ç°¡å–®
- **å½±éŸ¿**ï¼šå°ç³»çµ±å½±éŸ¿æœ€å°

#### **2. æ—¥èªŒè¨˜éŒ„**
- **è©•ä¼°**ï¼šå¤šå€é–“æ—¥èªŒè¨˜éŒ„å®¹æ˜“å¯¦ç¾
- **å½±éŸ¿**ï¼šæœ‰åŠ©æ–¼èª¿è©¦å’Œç›£æ§

---

## ğŸ› ï¸ **å¯¦ç¾å»ºè­°**

### **éšæ®µ1ï¼šæ ¸å¿ƒæ¶æ§‹é‡æ§‹**
1. è¨­è¨ˆå¤šå€é–“æ•¸æ“šçµæ§‹
2. é‡æ§‹æ™‚é–“æª¢æŸ¥é‚è¼¯
3. å¯¦ç¾å€é–“ç‹€æ…‹ç®¡ç†

### **éšæ®µ2ï¼šè§£æå’Œé©—è­‰**
1. å¯¦ç¾å¤šå€é–“æ ¼å¼è§£æ
2. å¢å¼·è¼¸å…¥é©—è­‰æ©Ÿåˆ¶
3. æ·»åŠ éŒ¯èª¤è™•ç†å’Œæç¤º

### **éšæ®µ3ï¼šç‹€æ…‹å”èª¿**
1. å¯¦ç¾å€é–“é–“çš„ç‹€æ…‹å”èª¿
2. é‡æ–°è¨­è¨ˆç­–ç•¥è§¸ç™¼æ©Ÿåˆ¶
3. æ·»åŠ è¡çªæª¢æ¸¬å’Œè§£æ±º

### **éšæ®µ4ï¼šæ€§èƒ½å„ªåŒ–**
1. å„ªåŒ–å¤šå€é–“æª¢æŸ¥æ€§èƒ½
2. å¯¦ç¾æ•¸æ“šæ¸…ç†æ©Ÿåˆ¶
3. æ·»åŠ è¨˜æ†¶é«”ç›£æ§

### **éšæ®µ5ï¼šç”¨æˆ¶é«”é©—**
1. è¨­è¨ˆå¤šå€é–“UIé¡¯ç¤º
2. å¯¦ç¾é€²åº¦å’Œç‹€æ…‹åé¥‹
3. æ·»åŠ æ“ä½œä¾¿åˆ©åŠŸèƒ½

---

## ğŸ“Š **ç¸½é«”è©•ä¼°**

| è©•ä¼°é …ç›® | å¯¦ç¾é›£åº¦ | é¢¨éšªç­‰ç´š | æ€§èƒ½å½±éŸ¿ | å»ºè­°å„ªå…ˆç´š |
|---------|---------|---------|---------|-----------|
| å¤šå€é–“è§£æ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | â­â­â­â­ |
| ç‹€æ…‹ç®¡ç† | ğŸ”´ é«˜ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | â­â­â­â­â­ |
| è¨˜æ†¶é«”ç®¡ç† | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | â­â­â­â­â­ |
| ç­–ç•¥å”èª¿ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | â­â­â­â­â­ |
| UIé¡¯ç¤º | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | â­â­â­ |

**çµè«–**ï¼šå¤šç›£æ§å€é–“åŠŸèƒ½å¯¦ç¾å…·æœ‰æŒ‘æˆ°æ€§ï¼Œä¸»è¦é¢¨éšªåœ¨æ–¼ç‹€æ…‹ç®¡ç†è¤‡é›œæ€§å’Œè¨˜æ†¶é«”ä½¿ç”¨ã€‚å»ºè­°æ¡ç”¨æ¼¸é€²å¼å¯¦ç¾ï¼Œå…ˆæ”¯æ´2-3å€‹å€é–“ï¼Œé©—è­‰æ¶æ§‹ç©©å®šæ€§å¾Œå†æ“´å±•ã€‚

**å¯è¡Œæ€§è©•ä¼°**ï¼šğŸŸ¡ **ä¸­ç­‰å¯è¡Œæ€§** - éœ€è¦é‡å¤§æ¶æ§‹èª¿æ•´ï¼Œé¢¨éšªè¼ƒé«˜ä½†å¯æ§

**å»ºè­°å¯¦ç¾é †åº**ï¼š
1. å…ˆå¯¦ç¾ä»»å‹™1çš„è‡ªå®šç¾©æ™‚é–“ç¯„åœ
2. å†å¯¦ç¾ä»»å‹™2çš„é€£çºŒé‹è¡Œæ©Ÿåˆ¶  
3. æœ€å¾Œå¯¦ç¾å¤šç›£æ§å€é–“åŠŸèƒ½

---

*å ±å‘Šç”Ÿæˆæ™‚é–“ï¼š2025-07-18*  
*è©•ä¼°ç³»çµ±ï¼švirtual_simple_integrated.py*  
*é¢¨éšªç­‰ç´šï¼šğŸŸ¡ ä¸­é¢¨éšª - éœ€è¦è¬¹æ…è¨­è¨ˆå’Œå¯¦ç¾*
