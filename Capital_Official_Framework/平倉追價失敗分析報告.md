# 平倉追價失敗分析報告

## 📊 統計結果

### 止損平倉統計
**總計**: **3次** 止損平倉成功
- **部位15**: 止損平倉成功 @23329.0 (損益: -4點)
- **部位16**: 止損平倉成功 @23329.0 (損益: -4點)  
- **部位17**: 止損平倉成功 @23329.0 (損益: -4點)

### 追價失敗統計
**總計**: **3次** 平倉追價失敗
- **部位15**: 追價失敗 (第447-449行)
- **部位16**: 追價失敗 (第499-501行)
- **部位17**: 追價失敗 (第552-554行)

**分析時間**: 2025年7月17日  
**問題嚴重性**: 🔴 高 (影響平倉追價功能)  
**修復緊急度**: ✅ 需要立即修復  

## 🔍 追價失敗根因分析

### 問題1: 無法取得原始部位方向

**錯誤現象** (重複出現3次):
```
[MAIN] 🔄 收到平倉追價回調: 部位15 第0次
[MAIN] ❌ 無法取得原始部位方向
[MAIN] ❌ 部位15無法計算追價價格
```

**問題分析**:
1. **平倉追價回調被觸發**: ✅ 簡化追蹤器正確檢測到平倉取消
2. **回調函數執行**: ✅ 主程式收到追價回調
3. **部位方向獲取失敗**: ❌ 無法從資料庫或內存中獲取部位方向
4. **追價價格計算失敗**: ❌ 因為沒有方向信息，無法計算追價價格

### 問題2: 平倉追價回調參數錯誤

**關鍵線索** (第447行):
```
[MAIN] 🔄 收到平倉追價回調: 部位15 第0次
```

**問題分析**:
- **重試次數顯示為0**: 這表示回調參數可能有問題
- **應該顯示第1次**: 第一次追價應該是第1次，不是第0次

### 問題3: 部位狀態不一致

**時序分析**:
1. **20:00:58**: 部位15停損平倉下單成功
2. **20:00:59**: 收到平倉取消回報 (券商取消FOK訂單)
3. **20:00:59**: 觸發追價回調，但無法獲取部位方向

**問題**: 部位在停損執行後狀態可能已經改變，導致追價時無法正確獲取部位信息。

## 🔍 測試機對比分析

### 測試機的平倉追價機制

**測試機的優勢**:
1. **完整的 exit_group 註冊**: 測試機正確註冊了平倉組，包含 `direction` 信息
2. **正確的回調參數傳遞**: 測試機的 `_trigger_exit_retry_callbacks` 正確傳遞參數
3. **完整的部位方向獲取**: 測試機能從 `exit_group` 中獲取 `original_direction`

### 正式機的問題

**根本原因**: 正式機缺少**平倉組註冊**機制！

**關鍵發現**:
1. **簡化追蹤器調用**: 第1769行 `_trigger_exit_retry_callbacks` 嘗試從 `exit_groups` 獲取信息
2. **exit_groups 為空**: 正式機沒有註冊平倉組，導致 `exit_groups.get(position_id)` 返回 `None`
3. **original_direction 缺失**: 因為沒有平倉組，無法獲取原始部位方向

**測試機的完整流程**:
```python
# 1. 停損觸發時註冊平倉組
exit_group = ExitGroup(
    position_id=position_id,
    total_lots=1,
    direction="SHORT",  # ✅ 原始部位方向
    exit_direction="LONG",  # 平倉方向
    target_price=23329.0,
    product="TM0000"
)
self.exit_groups[position_id] = exit_group

# 2. 追價回調時正確獲取方向
exit_group = self.exit_groups.get(position_id)  # ✅ 找到平倉組
original_direction = exit_group.direction  # ✅ 獲取到 "SHORT"
```

**正式機的缺陷流程**:
```python
# 1. 停損觸發時沒有註冊平倉組 ❌
# self.exit_groups[position_id] = exit_group  # 缺失！

# 2. 追價回調時無法獲取方向
exit_group = self.exit_groups.get(position_id)  # ❌ 返回 None
original_direction = exit_order.get('original_direction')  # ❌ 也是 None
```

## 🔧 修復方向分析

### 修復方案1: 添加平倉組註冊 (推薦)

**在停損執行器中添加平倉組註冊**:
```python
# 在 stop_loss_executor.py 的平倉下單成功後
if hasattr(self, 'simplified_tracker') and self.simplified_tracker:
    # 註冊平倉組
    self.simplified_tracker.register_exit_group(
        position_id=position_id,
        total_lots=1,
        direction=original_direction,  # SHORT
        exit_direction=exit_direction,  # LONG
        target_price=trigger_price,
        product="TM0000"
    )
```

### 修復方案2: 改善回調參數傳遞

**在簡化追蹤器中改善參數構造**:
```python
def _trigger_exit_retry_callbacks(self, exit_order):
    # 🔧 修復：從資料庫獲取部位方向
    position_id = exit_order['position_id']

    # 方法1: 從平倉組獲取
    exit_group = self.exit_groups.get(position_id)
    if exit_group:
        original_direction = exit_group.direction
    else:
        # 方法2: 從資料庫查詢
        original_direction = self._get_position_direction_from_db(position_id)

    # 構造完整的 exit_order
    enhanced_exit_order = {
        **exit_order,
        'original_direction': original_direction
    }

    callback(enhanced_exit_order, retry_count)
```

### 修復方案3: 資料庫查詢備用機制

**添加資料庫查詢作為備用**:
```python
def _get_position_direction_from_db(self, position_id: int) -> str:
    """從資料庫獲取部位方向"""
    try:
        # 查詢部位表獲取方向
        position_info = self.db_manager.get_position_by_id(position_id)
        if position_info:
            return position_info.get('direction', 'UNKNOWN')
    except Exception as e:
        print(f"[TRACKER] ❌ 查詢部位方向失敗: {e}")
    return 'UNKNOWN'
```

## 🎯 推薦修復策略

### 優先級1: 立即修復 (方案1)
**在停損執行器中添加平倉組註冊** - 這是最根本的修復

### 優先級2: 增強穩定性 (方案2+3)
**改善回調參數傳遞 + 資料庫備用查詢** - 提供多層保障

### 預期修復效果
修復後的正常日誌應該是：
```
[MAIN] 🔄 收到平倉追價回調: 部位15 第1次
[MAIN] 🔄 空單平倉追價計算: ASK1(23330) + 1 = 23331
[MAIN] ✅ 部位15第1次追價下單成功
[ORDER_MGR] ⚡ 實際下單: BUY TM0000 1口 @23331
```

## 🎉 結論

**問題根源**: 正式機缺少平倉組註冊機制，導致追價回調無法獲取原始部位方向

**修復重點**:
1. **立即**: 在停損執行器中添加平倉組註冊
2. **增強**: 改善回調參數傳遞機制
3. **備用**: 添加資料庫查詢作為最後保障

**修復後**: 平倉追價功能將完全正常工作，提高平倉成功率


<function_calls>
<invoke name="codebase-retrieval">
<parameter name="information_request">virtual_simple_integrated.py 中的平倉追價回調函數 on_exit_retry 的完整實現，特別是如何獲取原始部位方向和計算追價價格的邏輯
