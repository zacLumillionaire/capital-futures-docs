# 🚀 實際下單功能開發計畫

## 📊 **項目概述**

**項目名稱**: 實際下單功能開發  
**開始日期**: 2025-07-04  
**預計完成**: 2025-07-09 (5個工作日)  
**目標**: 為多組策略系統添加完整的實際下單功能

## 🎯 **開發目標**

### **核心目標**
1. **FOK買ASK追價機制** - 實現快速成交的進場策略
2. **分n口送單協調** - 支援多口訂單的批次管理
3. **智能重試系統** - 提高下單成功率
4. **FIFO平倉整合** - 完善的出場機制
5. **完整資料追蹤** - 確保交易記錄完整性

### **技術目標**
- ✅ 下單成功率 > 95%
- ✅ 重試成功率 > 80%
- ✅ 資料同步準確率 100%
- ✅ 系統穩定性 > 99%

## 📋 **四階段開發計畫**

### **🔥 階段1: 進場下單機制 (Day 1-2)**

#### **1.1 五檔ASK價格提取系統**
**📁 目標文件**: `real_time_quote_manager.py`

**功能需求**:
- 即時接收OnNotifyBest5LONG事件
- 緩存五檔買賣價格和數量
- 提供最佳ASK價格查詢API
- 數據新鮮度驗證機制

**核心方法**:
```python
class RealTimeQuoteManager:
    def update_best5_data(self, best5_params)  # 更新五檔數據
    def get_best_ask_price(self)               # 取得最佳賣價
    def get_last_trade_price(self)             # 取得成交價
    def is_data_fresh(self, max_age_seconds)   # 檢查數據新鮮度
```

**整合點**: 修改`simple_integrated.py`的`OnNotifyBest5LONG`事件

#### **1.2 FOK買ASK追價執行器**
**📁 目標文件**: `fok_order_executor.py`

**功能需求**:
- 取得即時ASK價格
- 執行FOK類型下單
- 監控下單結果
- 準備重試機制

**核心方法**:
```python
class FOKOrderExecutor:
    def place_fok_buy_ask_order(self, product, quantity, max_retry)  # FOK買ASK下單
    def validate_ask_price(self, ask_price)                         # 驗證價格
    def calculate_order_params(self, ask_price, quantity)           # 計算參數
```

#### **1.3 下單回報追蹤系統**
**📁 目標文件**: `order_tracking_system.py`

**功能需求**:
- 註冊訂單追蹤
- 處理OnNewData回報
- 訂單狀態管理
- 回調函數觸發

**核心方法**:
```python
class OrderTrackingSystem:
    def register_order(self, order_info, callback_func)              # 註冊追蹤
    def process_order_report(self, seq_no, type, err, data)         # 處理回報
    def get_order_status(self, seq_no)                              # 查詢狀態
```

**整合點**: 修改`simple_integrated.py`的`OnNewData`事件

#### **1.4 多口訂單協調管理器**
**📁 目標文件**: `multi_lot_order_manager.py`

**功能需求**:
- 分批下單執行
- 訂單狀態協調
- 部分成交處理
- 整體進場狀態管理

**🎯 階段1驗收標準**:
- ✅ 五檔ASK價格即時提取成功率 100%
- ✅ FOK買ASK下單執行成功率 > 90%
- ✅ 下單回報追蹤準確率 100%
- ✅ 多口訂單協調無衝突

---

### **⚡ 階段2: 失敗重試機制 (Day 3)**

#### **2.1 訂單失敗分析器**
**📁 目標文件**: `order_failure_analyzer.py`

**功能需求**:
- 分析失敗原因分類
- 決定重試策略
- 計算重試延遲
- 重試可行性評估

**失敗原因分類**:
- **價格偏離** → 更新價格重試
- **數量不足** → 調整數量重試
- **系統忙碌** → 延遲重試
- **帳戶問題** → 不可重試

#### **2.2 智能重試管理器**
**📁 目標文件**: `intelligent_retry_manager.py`

**功能需求**:
- 處理下單失敗
- 更新重試價格
- 執行重試邏輯
- 重試次數控制

**重試策略**:
- **立即重試** - 使用最新成交價
- **追價重試** - 使用最新ASK價
- **延遲重試** - 等待市場穩定
- **放棄重試** - 超過限制條件

#### **2.3 重試狀態監控器**
**📁 目標文件**: `retry_status_monitor.py`

**功能需求**:
- 記錄重試嘗試
- 統計重試結果
- Console日誌輸出
- 重試效能分析

**🎯 階段2驗收標準**:
- ✅ 失敗原因識別準確率 > 95%
- ✅ 重試成功率 > 80%
- ✅ 重試時間控制在30秒內
- ✅ 完整的重試統計記錄

---

### **🔄 階段3: 平倉機制完善 (Day 4)**

#### **3.1 多組策略平倉整合器**
**📁 目標文件**: `multi_group_close_integrator.py`

**功能需求**:
- 執行部位平倉
- 驗證平倉訂單
- 處理平倉結果
- 更新資料庫記錄

**核心邏輯**:
- 查詢部位資訊 → 計算平倉參數 → 執行平倉下單(sNewClose=1) → 更新記錄

#### **3.2 FIFO平倉驗證器**
**📁 目標文件**: `fifo_close_validator.py`

**功能需求**:
- 驗證FIFO合規性
- 計算可平倉數量
- 預測平倉影響
- 確保先進先出原則

#### **3.3 部位狀態同步器**
**📁 目標文件**: `position_sync_manager.py`

**功能需求**:
- 同步API部位與資料庫
- 處理部位不一致
- 即時部位更新
- 狀態一致性維護

**🎯 階段3驗收標準**:
- ✅ 平倉單100%正確執行
- ✅ FIFO原則嚴格遵守
- ✅ API與資料庫部位100%同步
- ✅ 平倉後風險狀態正確更新

---

### **📊 階段4: 資料管理完善 (Day 5)**

#### **4.1 即時交易記錄管理器**
**📁 目標文件**: `real_time_trade_recorder.py`

**功能需求**:
- 記錄交易執行
- 完成交易週期
- 計算即時損益
- 驗證交易完整性

#### **4.2 異常狀態處理器**
**📁 目標文件**: `exception_state_handler.py`

**功能需求**:
- 檢測系統異常
- 處理數據不一致
- 緊急系統恢復
- 異常狀態報告

#### **4.3 交易統計分析器**
**📁 目標文件**: `trade_statistics_analyzer.py`

**功能需求**:
- 生成每日交易報告
- 分析策略表現
- 匯出交易記錄
- 風險指標計算

**🎯 階段4驗收標準**:
- ✅ 交易記錄100%完整性
- ✅ 異常狀態自動檢測處理
- ✅ 完整的統計分析功能
- ✅ 可靠的數據匯出功能

## 🔗 **系統整合架構**

### **整合流程**
```
報價系統 → 進場執行器 → 追蹤系統
    ↓           ↓           ↓
重試管理器 ← 多組策略 → 平倉整合器
    ↓           ↓           ↓
資料管理器 ← 風險引擎 → 統計分析器
```

### **關鍵整合點**

#### **simple_integrated.py 修改**
1. **OnNotifyBest5LONG事件** - 整合五檔報價管理器
2. **OnNewData事件** - 整合訂單追蹤系統
3. **多組策略初始化** - 添加實際下單組件
4. **風險管理檢查** - 整合平倉執行器

#### **multi_group_position_manager.py 修改**
1. **添加下單組件** - 整合FOK執行器和多口管理器
2. **execute_group_entry方法** - 實際下單邏輯
3. **風險檢查觸發** - 整合平倉整合器

## 📊 **開發里程碑**

### **里程碑1: 基礎下單 (Day 2)**
- ✅ 五檔報價提取運作
- ✅ FOK買ASK下單成功
- ✅ 下單回報追蹤完整

### **里程碑2: 重試機制 (Day 3)**
- ✅ 失敗分析準確
- ✅ 智能重試有效
- ✅ 重試統計完整

### **里程碑3: 平倉整合 (Day 4)**
- ✅ 平倉功能完整
- ✅ FIFO原則遵守
- ✅ 部位狀態同步

### **里程碑4: 系統完整 (Day 5)**
- ✅ 整合測試通過
- ✅ 異常處理完善
- ✅ 系統穩定運行

## 🚀 **實施建議**

### **開發順序**
1. **五檔ASK提取** (最高優先級)
2. **FOK下單執行** (核心功能)
3. **下單追蹤系統** (穩定性基礎)
4. **重試機制** (成功率保障)
5. **平倉整合** (完整性要求)
6. **資料管理** (可靠性保障)

### **風險控制**
- 🛡️ **模擬測試優先** - 所有功能先模擬測試
- 🛡️ **小量實測** - 使用最小口數實際測試
- 🛡️ **逐步整合** - 每階段獨立驗證
- 🛡️ **完整備份** - 保留穩定版本
- 🛡️ **錯誤恢復** - 每組件都有恢復機制

---

## 🎉 **2025-07-04 工作進度更新**

### **� 接手問題分析**

#### **原始問題**
1. **UNIQUE constraint failed 錯誤**
   ```
   ERROR:multi_group_database:資料庫操作錯誤: UNIQUE constraint failed: strategy_groups.date, strategy_groups.group_id
   ERROR:multi_group_database:創建策略組失敗: UNIQUE constraint failed: strategy_groups.date, strategy_groups.group_id
   ❌ [STRATEGY] 創建策略組失敗
   ```

2. **用戶需求**
   - 希望策略能支援一天多次執行
   - 需要靈活的執行頻率控制
   - 要求低風險的實施方案

#### **問題根本原因**
- **重複觸發機制**: 區間計算完成後，報價處理中重複觸發自動啟動
- **資料庫約束衝突**: 同一天嘗試創建相同的 group_id
- **缺乏執行頻率控制**: 沒有一天多次執行的機制

### **🔧 解決方案實施**

#### **方案1: 雙重防護機制**
**目標**: 解決 UNIQUE constraint failed 錯誤

**實施內容**:
1. **應用層防護** - 添加 `_auto_start_triggered` 觸發標記
2. **狀態檢查防護** - 在 `start_multi_group_strategy()` 中檢查運行狀態
3. **狀態重置機制** - 確保下次能正常運行

**修改文件**: `Capital_Official_Framework/simple_integrated.py`

#### **方案2: 動態 group_id 分配系統**
**目標**: 支援真正的一天多次執行

**核心創新**:
```python
def _get_next_available_group_ids(self, num_groups: int) -> List[int]:
    """智能分配 group_id"""
    # 首次執行: [1, 2, 3]
    # 第二次執行: [4, 5, 6]
    # 第三次執行: [7, 8, 9]
    # 降級處理: 使用時間戳確保唯一性
```

**修改文件**:
- `Capital_Official_Framework/multi_group_position_manager.py`
- `Capital_Official_Framework/multi_group_database.py`

#### **方案3: 執行頻率控制系統**
**目標**: 提供靈活的執行模式

**UI 增強**:
- 新增「執行頻率」下拉選單
- 三種模式：一天一次（預設）、可重複執行、測試模式
- 即時狀態反饋和日誌記錄

**邏輯增強**:
```python
def check_auto_start_multi_group_strategy(self):
    """根據頻率設定檢查是否允許執行"""
    freq_setting = self.multi_group_frequency_var.get()

    if freq_setting == "一天一次":
        # 檢查今天是否已有策略組
        if today_groups:
            print("📅 一天一次模式：今日已執行過，跳過")
            return
```

### **✅ 實施成果**

#### **1. 錯誤完全解決**
- ✅ **UNIQUE constraint failed**: 完全消除
- ✅ **重複觸發問題**: 雙重防護機制有效
- ✅ **系統穩定性**: 無任何現有功能受影響

#### **2. 功能成功實現**
- ✅ **動態 group_id 分配**: 支援無限次執行
- ✅ **執行頻率控制**: 三種模式滿足不同需求
- ✅ **資料完整保存**: 每次執行都保留完整記錄

#### **3. 測試驗證通過**
```
🧪 簡單測試動態 group_id 功能
✅ 動態組別ID: [1, 2]
✅ 創建策略組: [1]
✅ 第二次動態組別ID: [2, 3]
測試結果: 成功
```

#### **4. 技術優勢達成**
- ✅ **低風險實施**: 只修改核心邏輯，不影響現有功能
- ✅ **智能分配**: 自動檢測已有組別，分配新ID
- ✅ **降級處理**: 異常時使用時間戳確保唯一性
- ✅ **向後兼容**: 預設行為完全不變

### **📊 技術實施細節**

#### **核心修改文件清單**
1. **`multi_group_database.py`**
   - 新增 `get_today_strategy_groups()` 方法

2. **`multi_group_position_manager.py`**
   - 修改 `create_entry_signal()` 支援動態 group_id
   - 新增 `_get_next_available_group_ids()` 方法

3. **`simple_integrated.py`**
   - 新增執行頻率控制UI
   - 修改自動啟動檢查邏輯
   - 新增頻率變更事件處理

#### **創建測試文件**
4. **`simple_test.py`** - 功能驗證測試
5. **`test_multi_execution_fix.py`** - 完整測試套件

### **🎯 解決的業務問題**

#### **原問題**
- 策略只能一天執行一次
- 遇到 UNIQUE 錯誤時系統無法繼續
- 缺乏靈活的執行控制

#### **現在效果**
- ✅ **一天一次模式**: 檢查今日是否已執行，如是則跳過
- ✅ **可重複執行模式**: 使用動態組別ID，避免衝突
- ✅ **測試模式**: 忽略所有限制，可隨時執行
- ✅ **完整記錄**: 每次執行都保留，便於分析

### **� 用戶價值實現**

#### **功能價值**
1. **靈活性提升**: 支援不同的交易策略需求
2. **風險分散**: 可以在不同時間點進場
3. **測試友好**: 開發階段可以反覆測試
4. **資料完整**: 保留所有交易記錄用於分析

#### **技術價值**
1. **系統穩定性**: 消除關鍵錯誤
2. **可維護性**: 清晰的邏輯結構
3. **可擴展性**: 為未來功能預留空間
4. **向後兼容**: 不影響現有用戶

### **🚀 後續發展方向**

基於這次成功的實施經驗，建議後續發展：

1. **階段2: 失敗重試機制** - 基於穩定的多次執行基礎
2. **階段3: 平倉機制完善** - 利用動態組別管理
3. **階段4: 資料管理完善** - 基於完整的記錄系統

---

**📝 文檔版本**: v2.0
**🎯 狀態**: ✅ **多次執行功能實施完成，UNIQUE錯誤已解決**
**📅 更新時間**: 2025-07-04
**📊 工作成果**: 雙重防護機制 + 動態組別分配 + 執行頻率控制
