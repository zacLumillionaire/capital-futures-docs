# 平倉追價失敗診斷報告

## 📋 問題摘要

基於最新平倉紀錄分析，發現正式機存在多個關鍵問題：

1. **部位21移動停利追價失敗**: 第一次追價成功，第二次追價沒有繼續
2. **部位22停損平倉成交回調失敗**: `'ExitGroup' object has no attribute 'entry_price'`
3. **進場價格無效問題**: `部位 21 進場價格無效 (None)`
4. **實際平倉錯位**: 系統認為平倉部位22，但實際平倉部位21

**分析時間**: 2025年7月17日  
**問題嚴重性**: 🔴 高 (影響追價機制和平倉準確性)  
**修復緊急度**: ✅ 需要立即修復  

## 🔍 問題1：部位21追價失敗分析

### 問題現象
**第一次追價成功**:
```
[SIMPLIFIED_TRACKER] 🔄 平倉組21第1口觸發追價: 第1次, 1口 (口級別鎖定)
[MAIN] 🔄 收到平倉追價回調: 部位21 第0次
[MAIN] 🔄 空單平倉追價計算: ASK1(23311.0) + 0 = 23311.0
[ORDER_MGR] ⚡ 實際下單: BUY TM0000 1口 @23311 API結果:('2796', 0)
[MAIN] ✅ 部位21第0次追價下單成功
```

**第二次追價失敗**:
```
📋 [REPLY] OnNewData: ['', 'TF', 'C', 'N', ...] (第二次取消回報)
[SIMPLIFIED_TRACKER] 📤 收到平倉取消回報:
[SIMPLIFIED_TRACKER]   待匹配平倉訂單: 0個
[SIMPLIFIED_TRACKER] ⚠️ 找不到匹配的平倉取消訂單
```

### 根本原因
**追價訂單註冊問題**: 第一次追價下單成功後，新的追價訂單沒有正確註冊到簡化追蹤器

**時序分析**:
1. **21:30:14**: 第一次FOK取消，觸發追價
2. **21:30:15**: 第一次追價下單成功 @23311
3. **21:30:15**: 第二次FOK取消，但找不到匹配的平倉訂單
4. **結果**: 追價機制中斷，沒有繼續第二次追價

## 🔍 問題2：ExitGroup缺少entry_price屬性

### 問題現象
```
[SIMPLIFIED_TRACKER] ❌ 觸發平倉成交回調失敗: 'ExitGroup' object has no attribute 'entry_price'
```

### 根本原因
**ExitGroup類定義不完整**: 我之前的修復中假設 `ExitGroup` 有 `entry_price` 屬性，但實際上沒有

**檢查ExitGroup類定義**:
根據錯誤信息，`ExitGroup` 類沒有 `entry_price` 屬性，這導致我之前的修復失敗。

## 🔍 問題3：進場價格無效問題

### 問題現象
```
[OPTIMIZED_RISK] ⚠️ 部位 21 進場價格無效 (None)，跳過預計算
[OPTIMIZED_RISK] 🆕 載入新部位: 21
```

### 根本原因
**部位21狀態混亂**: 部位21已經被移動停利平倉，但系統仍嘗試重新載入，且進場價格為None

**時序問題**:
1. **21:30:13**: 部位21移動停利平倉下單成功
2. **21:30:22**: 系統嘗試重新載入部位21，但進場價格為None
3. **結果**: 風險管理器狀態混亂

## 🔍 問題4：實際平倉錯位問題

### 問題現象
**系統記錄**:
- 部位21: 移動停利平倉 @23309 (FOK被取消，追價失敗)
- 部位22: 停損平倉 @23338 (成交 @23331)

**實際情況**:
- 期貨商帳號顯示部位21被平倉
- 部位22仍留在帳號中

### 根本原因
**訂單匹配錯誤**: 簡化追蹤器的FIFO匹配機制可能有問題，導致成交回報匹配到錯誤的部位

## 🔍 測試機對比分析

### 測試機的優勢機制

**測試機追價機制** (`virtual_simple_integrated.py`):
1. **完整的訂單註冊**: 每次追價下單後正確註冊新訂單
2. **正確的ExitGroup屬性**: ExitGroup包含所有必要屬性
3. **穩定的FIFO匹配**: 訂單匹配機制更穩定

**測試機ExitGroup定義**:
```python
class ExitGroup:
    def __init__(self, position_id, total_lots, direction, exit_direction, target_price, product):
        self.position_id = position_id
        self.total_lots = total_lots
        self.direction = direction  # 原始部位方向
        self.exit_direction = exit_direction  # 平倉方向
        self.target_price = target_price
        self.product = product
        self.entry_price = None  # ✅ 測試機有這個屬性
        self.individual_retry_counts = {}
        self.current_lot_index = 0
```

### 正式機的缺陷

**正式機ExitGroup定義** (推測):
```python
class ExitGroup:
    def __init__(self, position_id, total_lots, direction, exit_direction, target_price, product):
        self.position_id = position_id
        self.total_lots = total_lots
        self.direction = direction
        self.exit_direction = exit_direction
        self.target_price = target_price
        self.product = product
        # ❌ 缺少 entry_price 屬性
        self.individual_retry_counts = {}
        self.current_lot_index = 0
```

## 🔧 修復方案

### 方案1: 修復ExitGroup類定義 (緊急)

**添加缺少的屬性**:
```python
class ExitGroup:
    def __init__(self, position_id, total_lots, direction, exit_direction, target_price, product, entry_price=None):
        self.position_id = position_id
        self.total_lots = total_lots
        self.direction = direction
        self.exit_direction = exit_direction
        self.target_price = target_price
        self.product = product
        self.entry_price = entry_price  # ✅ 添加缺少的屬性
        self.individual_retry_counts = {}
        self.current_lot_index = 0
```

### 方案2: 修復平倉組註冊 (緊急)

**在停損執行器中傳遞entry_price**:
```python
# 在 stop_loss_executor.py 中
self.simplified_tracker.register_exit_group(
    position_id=position_id,
    total_lots=1,
    direction=trigger_info.direction,
    exit_direction=exit_direction_for_group,
    target_price=trigger_info.current_price,
    product="TM0000",
    entry_price=trigger_info.entry_price  # ✅ 傳遞進場價格
)
```

### 方案3: 修復追價訂單註冊 (重要)

**確保追價訂單正確註冊**:
```python
# 在平倉追價回調中
def on_exit_retry(exit_order: dict, retry_count: int):
    # ... 追價邏輯 ...

    # 🔧 修復：確保追價訂單正確註冊
    if order_result and order_result.success:
        if hasattr(self, 'multi_group_position_manager') and \
           hasattr(self.multi_group_position_manager, 'simplified_tracker'):
            self.multi_group_position_manager.simplified_tracker.register_exit_order(
                order_id=order_result.order_id,
                position_id=position_id,
                direction=exit_direction,
                quantity=1,
                price=retry_price,
                product="TM0000"
            )
```

### 方案4: 改善FIFO匹配機制 (長期)

**增強訂單匹配邏輯**:
```python
def _find_matching_exit_order(self, price, qty, product):
    """改善的FIFO匹配邏輯"""
    # 1. 精確匹配 (價格 + 數量 + 商品)
    # 2. 部分匹配 (商品 + 數量，忽略價格差異)
    # 3. 時間順序匹配 (最早註冊的訂單)
```

## 🎯 推薦修復順序

### 優先級1: 立即修復 (今天)
1. **修復ExitGroup類定義** - 添加 `entry_price` 屬性
2. **修復平倉組註冊** - 傳遞正確的 `entry_price`

### 優先級2: 重要修復 (明天)
3. **修復追價訂單註冊** - 確保追價訂單正確註冊
4. **改善錯誤處理** - 添加更多調試信息

### 優先級3: 長期改善 (本週)
5. **改善FIFO匹配機制** - 增強訂單匹配準確性
6. **添加狀態驗證** - 防止部位狀態混亂

## 🎉 預期修復效果

### 修復後的正常流程
```
[SIMPLIFIED_TRACKER] 🔄 平倉組21第1口觸發追價: 第1次, 1口
[MAIN] 🔄 收到平倉追價回調: 部位21 第1次
[MAIN] 🔄 空單平倉追價計算: ASK1(23311.0) + 1 = 23312.0
[MAIN] ✅ 部位21第1次追價下單成功
[SIMPLIFIED_TRACKER] 📝 註冊追價訂單: 部位21 LONG 1口 @23312.0

[SIMPLIFIED_TRACKER] 🔄 平倉組21第1口觸發追價: 第2次, 1口
[MAIN] 🔄 收到平倉追價回調: 部位21 第2次
[MAIN] 🔄 空單平倉追價計算: ASK1(23313.0) + 2 = 23315.0
[MAIN] ✅ 部位21第2次追價下單成功

... (最多5次追價)
```

### 修復後的平倉成交
```
[SIMPLIFIED_TRACKER] ✅ 平倉成交確認: 部位21 1口 @23315
[SIMPLIFIED_TRACKER] 🔍 從平倉組獲取部位21信息:
[SIMPLIFIED_TRACKER]   進場價格: 23322.0
[SIMPLIFIED_TRACKER]   原始方向: SHORT
[MAIN] 💰 計算損益: SHORT 23322.0→23315.0 = +7.0點
INFO:multi_group_database:更新部位出場: ID=21, 損益=+7.0點
[MAIN] ✅ 部位21狀態已更新為EXITED
```

## 🎯 結論

**問題根源**:
1. ExitGroup類缺少 `entry_price` 屬性
2. 追價訂單註冊機制不完整
3. FIFO匹配可能有錯位問題

**修復重點**:
1. **立即**: 修復ExitGroup類定義和平倉組註冊
2. **重要**: 完善追價訂單註冊機制
3. **長期**: 改善FIFO匹配準確性

**修復後**: 追價機制將完全正常工作，能夠持續追價最多5次，平倉成交回調也能正確處理

<function_calls>
<invoke name="codebase-retrieval">
<parameter name="information_request">ExitGroup 類的完整定義，包括所有屬性和方法，特別是是否有 entry_price 屬性
