# 🔍 進場建倉運作邏輯完整檢查計畫

## 📋 **檢查目標**

確保進場建倉流程完全使用新的FIFO機制，清除所有舊機制的殘餘污染，包括：
- ❌ 序號匹配邏輯殘餘
- ❌ 方向檢測依賴
- ❌ 重複下單機制
- ❌ 不一致的追蹤器使用
- ❌ 資料庫記錄不同步

---

## 🎯 **檢查流程架構**

```
訊號觸發 → 進場邏輯 → 下單執行 → 回報處理 → 追價機制 → 資料庫追蹤
    ↓         ↓         ↓         ↓         ↓         ↓
  檢查1     檢查2     檢查3     檢查4     檢查5     檢查6
```

---

## 📊 **檢查項目詳細計畫**

### **🔍 檢查1: 訊號觸發機制**

**檢查目標**: 確保訊號觸發邏輯乾淨，沒有舊機制殘餘

**檢查文件**:
- `simple_integrated.py` (主要策略邏輯)
- `multi_group_position_manager.py` (多組部位管理)
- `real_time_quote_manager.py` (報價觸發)

**檢查重點**:
1. **開盤區間策略觸發**
   - 檢查08:46-08:47區間邏輯是否正確
   - 確認LONG/SHORT觸發條件
   - 驗證沒有重複觸發機制

2. **價格突破邏輯**
   - 檢查range_high/range_low計算
   - 確認close_price vs low_price觸發差異
   - 驗證ASK1/BID1價格選擇邏輯

3. **訊號傳遞路徑**
   - 確認訊號如何傳遞到下單模組
   - 檢查是否有多重觸發路徑

**預期發現問題**:
- 可能存在舊的序號生成邏輯
- 可能有重複的訊號觸發機制
- 價格選擇邏輯可能不一致

### **🔍 檢查2: 進場邏輯執行**

**檢查目標**: 確保進場邏輯使用統一的FIFO追蹤器

**檢查文件**:
- `multi_group_position_manager.py` (核心進場邏輯)
- `virtual_real_order_manager.py` (虛實單管理)
- `order_mode_ui_controller.py` (下單模式控制)

**檢查重點**:
1. **下單模式判斷**
   - 檢查虛擬/實際模式切換邏輯
   - 確認模式狀態一致性
   - 驗證UI控制與實際執行同步

2. **多組下單邏輯**
   - 檢查3口分組邏輯是否正確
   - 確認每組1口的執行
   - 驗證組間間隔時間

3. **追蹤器註冊**
   - 確認使用哪個追蹤器(統一/簡化/總量)
   - 檢查是否有重複註冊
   - 驗證追蹤器參數正確性

**預期發現問題**:
- 可能同時使用多個追蹤器
- 可能有舊的序號註冊邏輯
- 虛實單切換可能不完整

### **🔍 檢查3: 下單執行機制**

**檢查目標**: 確保下單執行完全使用FIFO機制

**檢查文件**:
- `order_service/FutureOrder.py` (群益API下單)
- `unified_order_tracker.py` (統一追蹤器)
- `simplified_order_tracker.py` (簡化追蹤器)

**檢查重點**:
1. **API下單調用**
   - 檢查SendFutureOrder參數
   - 確認sNewClose參數設置(0=新倉)
   - 驗證價格類型(FOK)

2. **訂單註冊流程**
   - 確認使用register_order方法
   - 檢查FIFO匹配器註冊
   - 驗證沒有序號依賴

3. **錯誤處理機制**
   - 檢查下單失敗處理
   - 確認重試機制邏輯
   - 驗證錯誤回報處理

**預期發現問題**:
- 可能還有舊的序號註冊邏輯
- 可能有重複的下單調用
- 錯誤處理可能不完整

### **🔍 檢查4: 回報處理機制**

**檢查目標**: 確保回報處理完全使用FIFO匹配

**檢查文件**:
- `Reply_Service/Reply.py` (群益回報接收)
- `unified_order_tracker.py` (回報處理)
- `simplified_order_tracker.py` (簡化回報處理)
- `total_lot_manager.py` (總量回報處理)

**檢查重點**:
1. **OnNewData解析**
   - 檢查fields解析邏輯
   - 確認使用正確的欄位索引
   - 驗證Type/Price/Qty提取

2. **FIFO匹配流程**
   - 確認使用find_match方法
   - 檢查商品映射(TM0000↔TM2507)
   - 驗證價格容差(±5點)

3. **回報分發機制**
   - 檢查是否有重複處理
   - 確認回調函數觸發
   - 驗證狀態更新邏輯

**預期發現問題**:
- 可能還有序號匹配殘餘
- 可能有重複的回報處理
- 回調函數可能不一致

### **🔍 檢查5: 追價機制**

**檢查目標**: 確保追價機制與FIFO匹配器整合

**檢查文件**:
- `multi_group_position_manager.py` (追價邏輯)
- `simplified_order_tracker.py` (追價觸發)
- `unified_order_tracker.py` (取消回調)

**檢查重點**:
1. **取消檢測機制**
   - 檢查Type="C"處理邏輯
   - 確認FIFO匹配取消訂單
   - 驗證追價觸發條件

2. **價格計算邏輯**
   - 檢查ASK1+retry_count邏輯
   - 確認最大重試次數(5次)
   - 驗證滑價限制(3-5點)

3. **重新下單流程**
   - 檢查新訂單註冊
   - 確認FIFO匹配器更新
   - 驗證追價統計記錄

**預期發現問題**:
- 追價可能還依賴序號
- 價格計算可能不一致
- 重試邏輯可能有重複

### **🔍 檢查6: 資料庫追蹤機制**

**檢查目標**: 確保資料庫記錄與FIFO機制同步

**檢查文件**:
- `multi_group_database.py` (SQLite資料庫)
- `multi_group_position_manager.py` (部位記錄)
- `exit_mechanism_database_extension.py` (出場記錄)

**檢查重點**:
1. **進場記錄邏輯**
   - 檢查insert_position_entry方法
   - 確認記錄時機與FIFO匹配同步
   - 驗證價格/數量/時間記錄

2. **部位狀態追蹤**
   - 檢查position_status更新
   - 確認filled_lots統計
   - 驗證與追蹤器狀態一致

3. **資料一致性**
   - 檢查是否有重複記錄
   - 確認事務處理邏輯
   - 驗證錯誤回滾機制

**預期發現問題**:
- 資料庫記錄可能不同步
- 可能有重複的記錄邏輯
- 狀態更新可能不一致

---

## 🔧 **檢查方法**

### **1. 靜態代碼檢查**
- 搜尋關鍵字: `api_seq`, `sequence`, `seq_no`, `key_no`
- 檢查import語句是否有舊模組
- 驗證方法調用是否一致

### **2. 動態流程追蹤**
- 添加詳細日誌輸出
- 追蹤訂單從觸發到完成的完整路徑
- 記錄每個階段的狀態變化

### **3. 整合測試**
- 模擬完整的進場流程
- 測試虛擬和實際模式
- 驗證資料庫記錄正確性

---

## 📋 **檢查清單**

### **Phase 1: 代碼審查** (預估2小時)
- [ ] 檢查1: 訊號觸發機制
- [ ] 檢查2: 進場邏輯執行  
- [ ] 檢查3: 下單執行機制

### **Phase 2: 流程驗證** (預估2小時)
- [ ] 檢查4: 回報處理機制
- [ ] 檢查5: 追價機制
- [ ] 檢查6: 資料庫追蹤機制

### **Phase 3: 整合測試** (預估1小時)
- [ ] 端到端流程測試
- [ ] 虛實單切換測試
- [ ] 資料一致性驗證

---

## 🎯 **預期成果**

1. **清理報告**: 列出所有發現的舊機制殘餘
2. **修正建議**: 提供具體的修正方案
3. **測試驗證**: 確保修正後的流程正常運作
4. **文檔更新**: 更新相關的技術文檔

---

## ⚠️ **風險評估**

**高風險區域**:
- 多重追蹤器並存可能導致重複處理
- 序號匹配殘餘可能導致匹配失敗
- 資料庫記錄不同步可能導致狀態錯誤

**緩解措施**:
- 逐步檢查，確保每個階段都正確
- 保留備份，確保可以回滾
- 充分測試，確保穩定性

這個檢查計畫將確保您的進場建倉機制完全乾淨，沒有任何舊機制的污染！
