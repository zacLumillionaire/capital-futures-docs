# ğŸ”§ UNIQUE constraint failed éŒ¯èª¤ä¿®å¾©æ–¹æ¡ˆ

## ğŸ“‹ **å•é¡Œæè¿°**

**éŒ¯èª¤è¨Šæ¯**:
```
ERROR:multi_group_database:è³‡æ–™åº«æ“ä½œéŒ¯èª¤: UNIQUE constraint failed: strategy_groups.date, strategy_groups.group_id
ERROR:multi_group_database:å‰µå»ºç­–ç•¥çµ„å¤±æ•—: UNIQUE constraint failed: strategy_groups.date, strategy_groups.group_id
ERROR:multi_group_position_manager.MultiGroupPositionManager:å‰µå»ºé€²å ´ä¿¡è™Ÿå¤±æ•—: UNIQUE constraint failed: strategy_groups.date, strategy_groups.group_id
âŒ [STRATEGY] å‰µå»ºç­–ç•¥çµ„å¤±æ•—
```

**ç™¼ç”Ÿæ™‚æ©Ÿ**: å€é–“è¨ˆç®—å®Œæˆå¾Œï¼Œè‡ªå‹•å•Ÿå‹•å¤šçµ„ç­–ç•¥æ™‚

## ğŸ” **æ ¹æœ¬åŸå› åˆ†æ**

### **å•é¡Œæ ¹æº**
1. **é‡è¤‡è§¸ç™¼æ©Ÿåˆ¶**: `update_range_calculation_safe()` åœ¨æ¯æ¬¡å ±åƒ¹è™•ç†æ™‚éƒ½æœƒè¢«èª¿ç”¨
2. **ç‹€æ…‹æª¢æŸ¥æ™‚é–“å·®**: åœ¨è³‡æ–™åº«æ“ä½œå’Œç‹€æ…‹æ›´æ–°ä¹‹é–“å­˜åœ¨æ™‚é–“å·®
3. **ç¼ºä¹é˜²é‡è¤‡æ©Ÿåˆ¶**: æ²’æœ‰é˜²æ­¢åŒä¸€å€‹å€é–“è¨ˆç®—è§¸ç™¼å¤šæ¬¡ç­–ç•¥çµ„å‰µå»º

### **è§¸ç™¼æµç¨‹**
```
å ±åƒ¹è™•ç† â†’ update_range_calculation_safe() â†’ check_auto_start_multi_group_strategy()
    â†“
start_multi_group_strategy() â†’ create_entry_signal() â†’ è³‡æ–™åº«å‰µå»ºç­–ç•¥çµ„
    â†“
å¦‚æœåœ¨ç‹€æ…‹æ›´æ–°å‰å†æ¬¡è§¸ç™¼ â†’ é‡è¤‡å‰µå»º â†’ UNIQUE constraint failed
```

### **è³‡æ–™åº«ç´„æŸ**
```sql
CREATE TABLE strategy_groups (
    ...
    date TEXT NOT NULL,
    group_id INTEGER NOT NULL,
    ...
    UNIQUE(date, group_id)  -- åŒä¸€å¤©ä¸èƒ½æœ‰ç›¸åŒçš„group_id
);
```

## âœ… **ä¿®å¾©æ–¹æ¡ˆ**

### **é›™é‡é˜²è­·æ©Ÿåˆ¶**

#### **1. æ‡‰ç”¨å±¤é˜²è­·** - é˜²æ­¢é‡è¤‡è§¸ç™¼
åœ¨ `simple_integrated.py` ä¸­æ·»åŠ è§¸ç™¼æ¨™è¨˜ï¼š

```python
# åˆå§‹åŒ–æ™‚æ·»åŠ ç‹€æ…‹è®Šæ•¸
self._auto_start_triggered = False  # é˜²æ­¢é‡è¤‡è§¸ç™¼è‡ªå‹•å•Ÿå‹•

# å€é–“è¨ˆç®—å®Œæˆæ™‚æª¢æŸ¥
if not self._auto_start_triggered:
    self.check_auto_start_multi_group_strategy()

# è‡ªå‹•å•Ÿå‹•æª¢æŸ¥æ™‚ç«‹å³è¨­å®šæ¨™è¨˜
def check_auto_start_multi_group_strategy(self):
    if (self.multi_group_prepared and
        self.multi_group_auto_start and
        not self.multi_group_running and
        self.range_calculated and
        not self._auto_start_triggered):  # æ–°å¢æª¢æŸ¥
        
        # ç«‹å³è¨­å®šè§¸ç™¼æ¨™è¨˜ï¼Œé˜²æ­¢é‡è¤‡èª¿ç”¨
        self._auto_start_triggered = True
        
        # åŸ·è¡Œå•Ÿå‹•é‚è¼¯...
```

#### **2. ç‹€æ…‹æª¢æŸ¥é˜²è­·** - é˜²æ­¢é‡è¤‡å•Ÿå‹•
åœ¨ `start_multi_group_strategy()` ä¸­æ·»åŠ é‹è¡Œç‹€æ…‹æª¢æŸ¥ï¼š

```python
def start_multi_group_strategy(self):
    # æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨é‹è¡Œä¸­ï¼ˆé˜²é‡è¤‡å•Ÿå‹•ï¼‰
    if self.multi_group_running:
        print("âš ï¸ [STRATEGY] å¤šçµ„ç­–ç•¥å·²åœ¨é‹è¡Œä¸­")
        return
    
    # åŸ·è¡Œå‰µå»ºé‚è¼¯...
```

#### **3. ç‹€æ…‹é‡ç½®æ©Ÿåˆ¶** - ç¢ºä¿ä¸‹æ¬¡æ­£å¸¸é‹è¡Œ
åœ¨åœæ­¢ç­–ç•¥æ™‚é‡ç½®è§¸ç™¼æ¨™è¨˜ï¼š

```python
def stop_multi_group_strategy(self):
    # é‡ç½®ç‹€æ…‹è®Šæ•¸
    self.multi_group_running = False
    self.multi_group_prepared = False
    self._auto_start_triggered = False  # é‡ç½®è§¸ç™¼æ¨™è¨˜
```

## ğŸ§ª **ä¿®å¾©é©—è­‰**

### **æ¸¬è©¦çµæœ**
```
ğŸ”§ é‡è¤‡å‰µå»ºç­–ç•¥çµ„é˜²è­·æ©Ÿåˆ¶æ¸¬è©¦
================================================================================

ğŸ§ª æ¸¬è©¦1: ç¬¬ä¸€æ¬¡å‰µå»ºç­–ç•¥çµ„
âœ… ç¬¬ä¸€æ¬¡å‰µå»ºæˆåŠŸ: 1 å€‹ç­–ç•¥çµ„

ğŸ§ª æ¸¬è©¦2: é‡è¤‡å‰µå»ºç­–ç•¥çµ„ï¼ˆé æœŸå¤±æ•—ï¼‰
âœ… é‡è¤‡å‰µå»ºè§¸ç™¼ç•°å¸¸ï¼ˆé æœŸçµæœï¼‰: UNIQUE constraint failed

ğŸ“Š æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹:
âœ… é˜²è­·æ©Ÿåˆ¶æœ‰æ•ˆï¼šåªå‰µå»ºäº†1å€‹ç­–ç•¥çµ„

ğŸ§ª æ¸¬è©¦simple_integrated.pyé˜²è­·æ©Ÿåˆ¶
ğŸ“Š èª¿ç”¨çµæœçµ±è¨ˆ:
   ç¸½èª¿ç”¨æ¬¡æ•¸: 5
   æˆåŠŸè§¸ç™¼æ¬¡æ•¸: 1
âœ… é˜²è­·æ©Ÿåˆ¶æœ‰æ•ˆï¼šåªè§¸ç™¼äº†1æ¬¡

ğŸ¯ æ¸¬è©¦ç¸½çµ:
è³‡æ–™åº«å±¤é˜²è­·: âœ… é€šé
æ‡‰ç”¨å±¤é˜²è­·: âœ… é€šé
ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼é˜²è­·æ©Ÿåˆ¶æœ‰æ•ˆ
```

## ğŸ“ **ä¿®æ”¹æ–‡ä»¶æ¸…å–®**

### **ä¸»è¦ä¿®æ”¹**
- **æ–‡ä»¶**: `Capital_Official_Framework/simple_integrated.py`
- **ä¿®æ”¹å…§å®¹**:
  1. æ·»åŠ  `_auto_start_triggered` ç‹€æ…‹è®Šæ•¸
  2. ä¿®æ”¹ `update_range_calculation_safe()` æ·»åŠ è§¸ç™¼æª¢æŸ¥
  3. ä¿®æ”¹ `check_auto_start_multi_group_strategy()` æ·»åŠ é˜²é‡è¤‡é‚è¼¯
  4. ä¿®æ”¹ `start_multi_group_strategy()` æ·»åŠ é‹è¡Œç‹€æ…‹æª¢æŸ¥
  5. ä¿®æ”¹ `stop_multi_group_strategy()` æ·»åŠ ç‹€æ…‹é‡ç½®

### **æ¸¬è©¦æ–‡ä»¶**
- **æ–°å¢**: `Capital_Official_Framework/test_duplicate_prevention.py`
- **æ–°å¢**: `Capital_Official_Framework/check_database_status.py`

## ğŸš€ **ä½¿ç”¨å»ºè­°**

### **æ­£å¸¸ä½¿ç”¨æµç¨‹**
1. **ç›¤å‰æº–å‚™**: é…ç½®ç­–ç•¥ â†’ é»æ“Š"ğŸ“‹ æº–å‚™å¤šçµ„ç­–ç•¥" â†’ å‹¾é¸"ğŸ¤– å€é–“å®Œæˆå¾Œè‡ªå‹•å•Ÿå‹•"
2. **ç›¤ä¸­é‹è¡Œ**: å€é–“è¨ˆç®—å®Œæˆ â†’ ç³»çµ±è‡ªå‹•å•Ÿå‹•ç­–ç•¥ï¼ˆåªè§¸ç™¼ä¸€æ¬¡ï¼‰
3. **ç­–ç•¥ç›£æ§**: ç³»çµ±æ­£å¸¸é‹è¡Œï¼Œä¸æœƒé‡è¤‡å‰µå»ºç­–ç•¥çµ„

### **ç•°å¸¸è™•ç†**
å¦‚æœä»ç„¶é‡åˆ°å•é¡Œï¼š
1. æª¢æŸ¥è³‡æ–™åº«ç‹€æ…‹ï¼š`python check_database_status.py`
2. æ¸…ç†ä»Šå¤©è¨˜éŒ„ï¼šé¸æ“‡é¸é …2ï¼ˆè¬¹æ…ä½¿ç”¨ï¼‰
3. é‡æ–°å•Ÿå‹•ç¨‹å¼

## ğŸ¯ **ä¿®å¾©æ•ˆæœ**

### **è§£æ±ºçš„å•é¡Œ**
- âœ… æ¶ˆé™¤ UNIQUE constraint failed éŒ¯èª¤
- âœ… é˜²æ­¢é‡è¤‡å‰µå»ºç­–ç•¥çµ„
- âœ… ç¢ºä¿è‡ªå‹•å•Ÿå‹•åªè§¸ç™¼ä¸€æ¬¡
- âœ… ä¿æŒç³»çµ±ç©©å®šæ€§

### **ä¿æŒçš„åŠŸèƒ½**
- âœ… æ‰€æœ‰ç¾æœ‰åŠŸèƒ½å®Œå…¨ä¿ç•™
- âœ… è‡ªå‹•å•Ÿå‹•æ©Ÿåˆ¶æ­£å¸¸å·¥ä½œ
- âœ… å¤šçµ„ç­–ç•¥ç³»çµ±æ­£å¸¸é‹è¡Œ
- âœ… å‘å¾Œå…¼å®¹æ€§100%

## ğŸ“Š **æŠ€è¡“ç´°ç¯€**

### **é˜²è­·æ©Ÿåˆ¶å±¤æ¬¡**
1. **ç¬¬ä¸€å±¤**: è§¸ç™¼æ¨™è¨˜é˜²è­·ï¼ˆæ‡‰ç”¨å±¤ï¼‰
2. **ç¬¬äºŒå±¤**: é‹è¡Œç‹€æ…‹æª¢æŸ¥ï¼ˆé‚è¼¯å±¤ï¼‰
3. **ç¬¬ä¸‰å±¤**: è³‡æ–™åº«UNIQUEç´„æŸï¼ˆè³‡æ–™å±¤ï¼‰

### **ç‹€æ…‹ç®¡ç†**
```python
# ç‹€æ…‹è®Šæ•¸
self.multi_group_prepared = False      # ç­–ç•¥æ˜¯å¦å·²æº–å‚™
self.multi_group_auto_start = False    # æ˜¯å¦è‡ªå‹•å•Ÿå‹•
self.multi_group_running = False       # ç­–ç•¥æ˜¯å¦é‹è¡Œä¸­
self._auto_start_triggered = False     # é˜²æ­¢é‡è¤‡è§¸ç™¼ï¼ˆæ–°å¢ï¼‰
```

---

**ğŸ“ ä¿®å¾©å®Œæˆæ™‚é–“**: 2025-07-04  
**ğŸ¯ ç‹€æ…‹**: âœ… **ä¿®å¾©å®Œæˆä¸¦é©—è­‰é€šé**  
**ğŸ“Š æ¸¬è©¦çµæœ**: é›™é‡é˜²è­·æ©Ÿåˆ¶æœ‰æ•ˆï¼Œå•é¡Œå·²è§£æ±º
