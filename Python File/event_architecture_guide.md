# 🏗️ 期貨下單機事件處理架構指南

## 🎯 **正確的事件處理架構**

您的想法完全正確！讓我們明確區分兩種事件的用途：

### ⚡ **OnNewData - 即時推送事件**
```
用途: 接收最新的即時回報
觸發: 當有新的委託、成交、取消等事件發生時自動推送
特點: 即時性、無需主動查詢、自動推送
處理: 專注於即時狀態更新和通知
```

### 📊 **OnData - 查詢結果事件**  
```
用途: 透過主動查詢獲取歷史資料
觸發: 調用查詢API時返回結果
特點: 完整性、可控制查詢範圍、主動觸發
處理: 顯示查詢結果，不需要即時解析
```

## 🔄 **事件分工明確**

### ✅ **OnNewData 負責**
- 🎯 **即時委託狀態** - 新委託、委託成功/失敗
- 🎉 **即時成交回報** - 成交價格、數量、時間
- 🗑️ **即時取消回報** - 委託取消確認
- 📝 **即時改價回報** - 改價成功確認
- ⚠️ **即時動態退單** - 系統自動退單

### 📋 **OnData 負責**
- 📊 **查詢結果回報** - 不需要特殊處理
- 🔍 **歷史資料載入** - 僅作為查詢完成通知
- 📈 **批量資料回傳** - 透過查詢API獲得

## 🎛️ **實際操作分工**

### 🔴 **即時監控 (OnNewData)**
```
啟動方式: 點擊「開始監控」按鈕
監控內容: 
  ✅ 新下單後的委託確認
  ✅ 委託成交的即時通知  
  ✅ 委託取消的即時確認
  ✅ 系統退單的即時通知
顯示位置: 下單回報頁籤
```

### 🔵 **歷史查詢 (透過查詢功能)**
```
查詢方式: 部位查詢頁籤的各種查詢按鈕
查詢內容:
  📊 未平倉部位 (GetOpenInterestGW)
  📋 委託記錄 (GetOrderReport) 
  ⏰ 預約單狀態 (GetStopLossReport)
  🔍 最近委託(20筆) (GetOrderReport限制筆數)
顯示位置: 部位查詢頁籤的表格
```

## 🛠️ **架構優化實施**

### 1. **OnNewData專注即時處理**
```python
def OnNewData(self, bstrUserID, bstrData):
    """專門處理即時推送的委託/成交狀態"""
    # 只處理即時狀態變化
    # 解析關鍵欄位: Type, OrderErr, Price, Qty
    # 提供即時通知和狀態更新
```

### 2. **OnData簡化為查詢通知**
```python
def OnData(self, bstrUserID, bstrData):
    """主要用於查詢結果回報通知"""
    # 不需要複雜解析
    # 僅作為查詢完成的通知
    # 實際資料由查詢API直接返回
```

### 3. **查詢功能獨立處理**
```python
# 部位查詢
GetOpenInterestGW() → 直接處理返回結果

# 委託查詢  
GetOrderReport() → 直接處理返回結果

# 預約單查詢
GetStopLossReport() → 直接處理返回結果
```

## 📊 **用戶操作流程**

### 🎯 **即時監控流程**
```
1. 登入系統
2. 切換到「下單回報」頁籤
3. 點擊「開始監控」
4. 進行下單操作
5. 即時接收OnNewData推送
   ✅ 委託成功 → 立即顯示
   🎉 成交確認 → 立即通知
   🗑️ 取消確認 → 立即更新
```

### 📋 **歷史查詢流程**
```
1. 切換到「部位查詢」頁籤
2. 選擇查詢類型:
   📊 查詢未平倉部位
   📋 查詢預約單
   🔍 查詢最近委託(20筆)
3. 點擊對應查詢按鈕
4. 查看表格中的查詢結果
```

## 🎉 **架構優勢**

### ✅ **清晰分工**
- **即時事件** → OnNewData自動推送
- **歷史資料** → 主動查詢獲取
- **職責明確** → 避免重複處理

### ⚡ **性能優化**
- **減少解析** → OnData不需要複雜處理
- **按需查詢** → 只在需要時查詢歷史資料
- **即時響應** → OnNewData專注即時性

### 🛡️ **穩定可靠**
- **事件分離** → 降低相互影響
- **錯誤隔離** → 查詢失敗不影響即時監控
- **資源節省** → 避免不必要的資料處理

## 📋 **實際使用建議**

### 🎯 **日常交易**
```
1. 啟動程式後立即開啟即時監控
2. 透過OnNewData接收所有即時狀態
3. 需要查看歷史時才使用查詢功能
4. 專注於即時回報，減少主動查詢
```

### 📊 **資料管理**
```
1. 即時資料 → 自動推送，無需操作
2. 歷史資料 → 按需查詢，控制筆數
3. 部位資料 → 定期查詢，確認狀態
4. 預約單 → 必要時查詢，檢查狀態
```

### 🔧 **系統維護**
```
1. OnNewData → 保持連線，確保即時性
2. 查詢功能 → 限制筆數，避免過載
3. 錯誤處理 → 分別處理，互不影響
4. 性能監控 → 關注即時事件響應時間
```

## 🚀 **總結**

您的架構思路完全正確：

### ✅ **OnNewData**
- **專責**: 即時推送處理
- **優勢**: 自動、即時、無需查詢
- **用途**: 交易過程中的狀態監控

### ✅ **查詢功能**  
- **專責**: 歷史資料獲取
- **優勢**: 完整、可控、按需使用
- **用途**: 部位確認、歷史回顧

這樣的架構設計：
- 🎯 **職責清晰** - 各司其職
- ⚡ **性能優化** - 減少不必要處理  
- 🛡️ **穩定可靠** - 降低相互影響
- 🎨 **用戶友好** - 操作邏輯清晰

---

**🎉 完美的事件處理架構！專注即時監控，按需查詢歷史**

*架構設計: 2025-06-30*  
*版本: v2.2 - 事件架構優化版*
