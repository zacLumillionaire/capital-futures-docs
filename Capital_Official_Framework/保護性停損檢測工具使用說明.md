# 🛡️ 保護性停損檢測工具使用說明

## 📋 工具概述

我已經為您創建了兩個保護性停損檢測工具，用於在每次更新功能後驗證保護性停損機制是否正常運作：

### 1. 保護性停損全面檢測工具.py
**功能**: 全面深度檢測保護性停損的各個環節
**適用**: 重大更新後的完整驗證

### 2. 簡化保護性停損檢測.py  
**功能**: 快速檢測核心功能是否正常
**適用**: 日常更新後的快速驗證

## 🎯 檢測範圍

### 📋 1. 配置檢查
- **LotRule配置**: 檢查是否有`protective_stop_multiplier`和`use_protective_stop`欄位
- **資料庫結構**: 驗證保護性停損相關欄位是否存在
- **平倉配置**: 確認每口的保護倍數設定

### 🧮 2. 計算邏輯檢測
- **多單計算**: `entry_price - (profit × multiplier)` 
- **空單計算**: `entry_price + (profit × multiplier)` ✅ 正確邏輯
- **邊界情況**: 零獲利、零倍數、極值測試

### 🎯 3. 觸發機制檢測
- **風險引擎**: 檢查`update_protective_stop_loss`方法
- **觸發條件**: 驗證`if action['pnl'] > 0`邏輯
- **異步支援**: 確認`schedule_protection_update`方法

### 🚪 4. 執行流程檢測
- **統一出場管理器**: 檢查`execute_protective_stop`和`trigger_protective_stop_update`方法
- **資料庫操作**: 驗證`update_protective_stop`方法
- **狀態管理**: 確認資料庫連接和基本操作

### 🧪 5. 模擬測試
- **多單情境**: 模擬2口多單策略的保護性停損
- **空單情境**: 模擬2口空單策略的保護性停損  
- **多口情境**: 模擬3口策略的連續保護觸發

## 🚀 使用方法

### 快速檢測 (推薦日常使用)
```bash
cd Capital_Official_Framework
python "簡化保護性停損檢測.py"
```

### 全面檢測 (重大更新後使用)
```bash
cd Capital_Official_Framework
python "保護性停損全面檢測工具.py"
```

## 📊 檢測結果解讀

### ✅ 通過狀態
- **所有測試通過**: 保護性停損功能完全正常
- **計算邏輯正確**: 多單空單計算都正確
- **配置完整**: 所有必要配置都存在

### ⚠️ 警告狀態  
- **部分配置缺失**: 功能可用但不完整
- **資料庫欄位缺失**: 可能會自動升級
- **非關鍵方法缺失**: 不影響核心功能

### ❌ 失敗狀態
- **計算邏輯錯誤**: 需要立即修復
- **關鍵方法缺失**: 功能無法正常使用
- **模組導入失敗**: 代碼結構問題

## 🔧 常見問題排除

### 問題1: 模組導入失敗
**原因**: Python路徑問題或檔案缺失
**解決**: 確認在正確目錄執行，檢查檔案是否存在

### 問題2: 計算結果錯誤
**原因**: 計算邏輯被意外修改
**解決**: 檢查`risk_management_engine.py`中的計算公式

### 問題3: 配置檢查失敗
**原因**: LotRule類缺少必要欄位
**解決**: 檢查`multi_group_config.py`中的LotRule定義

### 問題4: 資料庫結構不完整
**原因**: 資料庫未升級或升級失敗
**解決**: 重新初始化資料庫或手動執行升級

## 📈 檢測報告

全面檢測工具會生成詳細的JSON報告：
- **檔案名**: `保護性停損檢測報告_YYYYMMDD_HHMMSS.json`
- **內容**: 包含所有檢測結果、問題詳情、建議修復方案

## 🎯 檢測重點

### 核心驗證項目
1. **空單計算邏輯**: 確認使用加法 `entry_price + stop_loss_amount`
2. **第1口配置**: 確認有保護倍數設定
3. **觸發條件**: 確認任何獲利平倉都會觸發保護
4. **執行支援**: 確認統一出場管理器能執行保護性停損

### 關鍵測試案例
```
空單測試案例:
- 進場: 22542
- 第一口獲利: 20點  
- 保護倍數: 2.0倍
- 預期保護價: 22542 + (20 × 2.0) = 22582 ✅
```

## 🔄 定期檢測建議

### 每次代碼更新後
1. 運行簡化檢測工具
2. 確認核心功能正常
3. 檢查計算邏輯無誤

### 重大功能更新後  
1. 運行全面檢測工具
2. 檢查所有配置和方法
3. 執行完整模擬測試
4. 生成並檢視詳細報告

### 部署前驗證
1. 清理測試資料
2. 運行全面檢測
3. 確認所有項目通過
4. 保存檢測報告備查

## 📞 技術支援

如果檢測工具發現問題：
1. 查看具體錯誤訊息
2. 參考本說明的排除方法
3. 檢查相關代碼檔案
4. 必要時重新執行修復步驟

檢測工具會持續更新以適應系統變化，確保保護性停損功能始終穩定可靠。
