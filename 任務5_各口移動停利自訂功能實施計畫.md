# 任務5：各口移動停利自訂功能實施計畫

## 📋 **功能概述**

本計畫設計讓用戶可以自訂各口的移動停利啟動點和回撤百分比，提供靈活的風險管理和獲利策略。基於虛擬交易系統現有的移動停利機制，增加用戶自訂配置功能。

**目標**：實現各口獨立的移動停利參數設定，包括啟動點數和回撤百分比的自訂化

---

## 🔍 **當前系統移動停利機制分析**

### **1. 現有移動停利架構**

#### **核心計算邏輯**
```python
# 當前移動停利計算公式 (回測系統)
# LONG部位
if peak_price_after_entry >= entry_price + trailing_activation_points:
    trailing_stop_activated = True
    stop_price = peak_price_after_entry - (peak_price_after_entry - entry_price) * trailing_pullback_percent

# SHORT部位  
if peak_price_after_entry <= entry_price - trailing_activation_points:
    trailing_stop_activated = True
    stop_price = peak_price_after_entry + (entry_price - peak_price_after_entry) * trailing_pullback_percent
```

#### **現有配置結構**
```python
# 當前預設配置 (StrategyConfig)
trailing_activation_points: Decimal = Decimal(25)    # 啟動點數
trailing_pullback_percent: Decimal = Decimal('0.20') # 回撤百分比 (20%)
```

### **2. 各口獨立配置現況**

#### **多口配置範例 (回測系統)**
```python
# 3口獨立配置範例
lot1_exit_config: dict = {
    "use_trailing_stop": False,
    "fixed_tp_points": Decimal(20),
    "trailing_activation": Decimal(25), 
    "trailing_pullback": Decimal('0.5')
}
lot2_exit_config: dict = {
    "use_trailing_stop": True,
    "trailing_activation": Decimal(40), 
    "trailing_pullback": Decimal('0.3')
}
lot3_exit_config: dict = {
    "use_trailing_stop": True,
    "trailing_activation": Decimal(65), 
    "trailing_pullback": Decimal('0.2')
}
```

---

## 🎯 **自訂功能設計方案**

### **方案1：UI配置面板設計**

#### **移動停利配置面板**
```python
class TrailingStopConfigPanel:
    """移動停利自訂配置面板"""
    
    def __init__(self, parent_frame, max_lots=3):
        self.parent_frame = parent_frame
        self.max_lots = max_lots
        self.lot_configs = {}  # 各口配置
        
    def create_ui(self):
        """創建UI元件"""
        # 主框架
        self.config_frame = ttk.LabelFrame(
            self.parent_frame, 
            text="🎯 各口移動停利自訂設定", 
            padding=10
        )
        self.config_frame.pack(fill="x", pady=5)
        
        # 全局控制
        self.create_global_controls()
        
        # 各口獨立設定
        self.create_lot_specific_controls()
        
        # 預設值和重置按鈕
        self.create_action_buttons()
```

#### **各口設定控制項**
```python
def create_lot_specific_controls(self):
    """創建各口獨立設定控制項"""
    
    for lot_id in range(1, self.max_lots + 1):
        # 口數框架
        lot_frame = ttk.LabelFrame(
            self.config_frame, 
            text=f"第{lot_id}口設定", 
            padding=5
        )
        lot_frame.pack(fill="x", pady=2)
        
        # 啟用移動停利
        enable_var = tk.BooleanVar(value=True)
        enable_check = ttk.Checkbutton(
            lot_frame,
            text="啟用移動停利",
            variable=enable_var
        )
        enable_check.grid(row=0, column=0, sticky="w", padx=5)
        
        # 啟動點數設定
        ttk.Label(lot_frame, text="啟動點數:").grid(row=0, column=1, padx=5)
        activation_var = tk.StringVar(value=str(self.get_default_activation(lot_id)))
        activation_entry = ttk.Entry(lot_frame, textvariable=activation_var, width=8)
        activation_entry.grid(row=0, column=2, padx=2)
        ttk.Label(lot_frame, text="點").grid(row=0, column=3, padx=2)
        
        # 回撤百分比設定
        ttk.Label(lot_frame, text="回撤比例:").grid(row=0, column=4, padx=5)
        pullback_var = tk.StringVar(value="20")
        pullback_entry = ttk.Entry(lot_frame, textvariable=pullback_var, width=8)
        pullback_entry.grid(row=0, column=5, padx=2)
        ttk.Label(lot_frame, text="%").grid(row=0, column=6, padx=2)
        
        # 儲存配置
        self.lot_configs[lot_id] = {
            'enabled': enable_var,
            'activation_points': activation_var,
            'pullback_percent': pullback_var
        }
```

### **方案2：數據結構設計**

#### **移動停利配置類**
```python
@dataclass
class LotTrailingStopConfig:
    """單口移動停利配置"""
    lot_id: int
    enabled: bool = True
    activation_points: float = 25.0      # 啟動點數
    pullback_percent: float = 20.0       # 回撤百分比
    min_activation: float = 5.0          # 最小啟動點數
    max_activation: float = 200.0        # 最大啟動點數
    min_pullback: float = 5.0            # 最小回撤百分比
    max_pullback: float = 80.0           # 最大回撤百分比
    
    def validate(self) -> tuple[bool, str]:
        """驗證配置參數"""
        if not self.min_activation <= self.activation_points <= self.max_activation:
            return False, f"啟動點數必須在{self.min_activation}-{self.max_activation}之間"
        
        if not self.min_pullback <= self.pullback_percent <= self.max_pullback:
            return False, f"回撤百分比必須在{self.min_pullback}-{self.max_pullback}%之間"
            
        return True, "配置有效"

@dataclass  
class MultiLotTrailingStopConfig:
    """多口移動停利配置管理器"""
    lot_configs: Dict[int, LotTrailingStopConfig] = field(default_factory=dict)
    global_enabled: bool = True
    
    def add_lot_config(self, lot_id: int, config: LotTrailingStopConfig):
        """添加口數配置"""
        self.lot_configs[lot_id] = config
        
    def get_lot_config(self, lot_id: int) -> Optional[LotTrailingStopConfig]:
        """取得指定口數配置"""
        return self.lot_configs.get(lot_id)
        
    def validate_all(self) -> tuple[bool, List[str]]:
        """驗證所有配置"""
        errors = []
        for lot_id, config in self.lot_configs.items():
            valid, message = config.validate()
            if not valid:
                errors.append(f"第{lot_id}口: {message}")
        
        return len(errors) == 0, errors
```

### **方案3：配置持久化機制**

#### **配置保存和載入**
```python
class TrailingStopConfigManager:
    """移動停利配置管理器"""
    
    def __init__(self, config_file="trailing_stop_config.json"):
        self.config_file = config_file
        self.current_config = MultiLotTrailingStopConfig()
        
    def save_config(self, config: MultiLotTrailingStopConfig) -> bool:
        """保存配置到文件"""
        try:
            config_dict = {
                'global_enabled': config.global_enabled,
                'lot_configs': {
                    str(lot_id): {
                        'lot_id': lot_config.lot_id,
                        'enabled': lot_config.enabled,
                        'activation_points': lot_config.activation_points,
                        'pullback_percent': lot_config.pullback_percent
                    }
                    for lot_id, lot_config in config.lot_configs.items()
                }
            }
            
            with open(self.config_file, 'w', encoding='utf-8') as f:
                json.dump(config_dict, f, indent=2, ensure_ascii=False)
                
            return True
        except Exception as e:
            print(f"保存配置失敗: {e}")
            return False
            
    def load_config(self) -> MultiLotTrailingStopConfig:
        """從文件載入配置"""
        try:
            if not os.path.exists(self.config_file):
                return self.get_default_config()
                
            with open(self.config_file, 'r', encoding='utf-8') as f:
                config_dict = json.load(f)
                
            config = MultiLotTrailingStopConfig()
            config.global_enabled = config_dict.get('global_enabled', True)
            
            for lot_id_str, lot_data in config_dict.get('lot_configs', {}).items():
                lot_id = int(lot_id_str)
                lot_config = LotTrailingStopConfig(
                    lot_id=lot_id,
                    enabled=lot_data.get('enabled', True),
                    activation_points=lot_data.get('activation_points', 25.0),
                    pullback_percent=lot_data.get('pullback_percent', 20.0)
                )
                config.add_lot_config(lot_id, lot_config)
                
            return config
        except Exception as e:
            print(f"載入配置失敗: {e}")
            return self.get_default_config()
```

---

## ⚠️ **風險評估**

### **🔴 高風險項目**

#### **1. 參數驗證風險**
- **風險**：用戶輸入無效參數導致系統錯誤
- **影響**：移動停利失效，可能造成重大損失
- **緩解**：實現嚴格的參數驗證和範圍限制

#### **2. 配置同步風險**
- **風險**：UI配置與實際執行配置不同步
- **影響**：用戶以為設定生效但實際未生效
- **緩解**：實現配置變更即時生效機制

### **🟡 中風險項目**

#### **1. 用戶操作複雜性**
- **風險**：配置選項過多導致用戶操作錯誤
- **影響**：設定錯誤的移動停利參數
- **緩解**：提供預設值和配置模板

#### **2. 性能影響**
- **風險**：各口獨立計算增加系統負載
- **影響**：報價處理延遲
- **評估**：影響有限，可接受

### **🟢 低風險項目**

#### **1. UI響應性**
- **評估**：配置UI對系統性能影響最小
- **影響**：幾乎無影響

#### **2. 配置存儲**
- **評估**：JSON文件存儲簡單可靠
- **影響**：最小風險

---

## 🛠️ **實施步驟**

### **階段1：核心數據結構 (1週)**
1. 實現 `LotTrailingStopConfig` 類
2. 實現 `MultiLotTrailingStopConfig` 類
3. 實現參數驗證邏輯
4. 建立單元測試

### **階段2：配置管理系統 (1週)**
1. 實現 `TrailingStopConfigManager` 類
2. 實現配置保存和載入功能
3. 建立預設配置模板
4. 實現配置遷移機制

### **階段3：UI界面開發 (1.5週)**
1. 實現 `TrailingStopConfigPanel` 類
2. 建立各口設定控制項
3. 實現即時參數驗證
4. 添加預設值和重置功能

### **階段4：系統整合 (1週)**
1. 整合到虛擬交易系統主界面
2. 實現配置變更即時生效
3. 更新移動停利執行邏輯
4. 建立配置同步機制

### **階段5：測試驗證 (1週)**
1. 功能測試：各口獨立配置
2. 邊界測試：參數極值驗證
3. 整合測試：與現有系統整合
4. 用戶體驗測試：操作流程驗證

---

## 📊 **預設配置建議**

### **保守型配置**
```python
conservative_config = {
    1: LotTrailingStopConfig(1, True, 15.0, 15.0),  # 第1口：15點啟動，15%回撤
    2: LotTrailingStopConfig(2, True, 30.0, 20.0),  # 第2口：30點啟動，20%回撤  
    3: LotTrailingStopConfig(3, True, 50.0, 25.0),  # 第3口：50點啟動，25%回撤
}
```

### **積極型配置**
```python
aggressive_config = {
    1: LotTrailingStopConfig(1, True, 10.0, 10.0),  # 第1口：10點啟動，10%回撤
    2: LotTrailingStopConfig(2, True, 25.0, 15.0),  # 第2口：25點啟動，15%回撤
    3: LotTrailingStopConfig(3, True, 40.0, 20.0),  # 第3口：40點啟動，20%回撤
}
```

### **平衡型配置 (預設)**
```python
balanced_config = {
    1: LotTrailingStopConfig(1, True, 20.0, 20.0),  # 第1口：20點啟動，20%回撤
    2: LotTrailingStopConfig(2, True, 40.0, 20.0),  # 第2口：40點啟動，20%回撤
    3: LotTrailingStopConfig(3, True, 65.0, 20.0),  # 第3口：65點啟動，20%回撤
}
```

---

## 🎯 **總體評估**

| 評估項目 | 實現難度 | 風險等級 | 開發時間 | 建議優先級 |
|---------|---------|---------|---------|-----------|
| 數據結構設計 | 🟢 低 | 🟢 低 | 1週 | ⭐⭐⭐⭐⭐ |
| 配置管理系統 | 🟡 中 | 🟡 中 | 1週 | ⭐⭐⭐⭐⭐ |
| UI界面開發 | 🟡 中 | 🟡 中 | 1.5週 | ⭐⭐⭐⭐ |
| 系統整合 | 🟡 中 | 🔴 高 | 1週 | ⭐⭐⭐⭐⭐ |
| 測試驗證 | 🟢 低 | 🟡 中 | 1週 | ⭐⭐⭐⭐⭐ |

**結論**：各口移動停利自訂功能具有**高實現可行性**，基於現有系統的良好架構，可以安全地實現此功能。

**總開發時間**：預估 5.5 週  
**風險等級**：🟡 **中等風險 - 可控制實現**  
**建議執行**：✅ **建議實施，能顯著提升交易策略靈活性**

---

*報告生成時間：2025-07-18*  
*評估系統：virtual_simple_integrated.py*  
*功能類型：移動停利自訂化增強*
