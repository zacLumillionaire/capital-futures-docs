# 回測數據顯示不一致與準確性問題診斷報告

## 📋 專案概述

**診斷目標：** 分析 GUI 實驗結果中「停利類型」欄位顯示不一致與數據準確性問題  
**分析範圍：** 從 GUI 參數輸入到核心回測引擎的完整數據流  
**分析方法：** 非侵入性端到端追蹤，比較參數處理邏輯  
**分析日期：** 2025-01-18  

## 🔍 核心問題描述

### 1. 顯示不一致問題
- **現象：** GUI 實驗結果中，「停利類型」欄位全部顯示相同的值（例如「統一停利 10」）
- **影響：** 無法正確反映不同的測試參數組合，影響結果分析的準確性
- **嚴重性：** 高 - 影響用戶對實驗結果的理解和決策

### 2. 數據準確性疑慮
- **現象：** 懷疑回測產出的數據（如 P&L）可能不正確
- **需求：** 從參數傳遞的源頭開始進行全鏈路檢查
- **嚴重性：** 極高 - 關係到回測結果的可信度

## 📊 數據流分析

### 完整數據流路徑
```
GUI 輸入 → mdd_gui.py 處理 → 統一回測引擎 → rev_multi_Profit-Funded Risk_多口.py → 結果輸出
```

## 🔧 第一階段：環境探索結果

### 關鍵文件定位
- **GUI 腳本：** `rev_strategy_analysis/experiment_analysis/mdd_gui.py`
- **核心回測引擎：** `rev_strategy_analysis/rev_multi_Profit-Funded Risk_多口.py`
- **配置工廠：** 統一回測引擎中的 `create_config_from_gui_dict` 函數

## 🎯 第二階段：GUI 參數處理邏輯分析

### GUI 參數收集機制
**文件：** `mdd_gui.py`  
**關鍵函數：** `collectFormData()` (行 360-385)

```javascript
function collectFormData() {
    return {
        stop_loss_ranges: {
            lot1: parseNumberList(document.getElementById('lot1StopLoss').value),
            lot2: parseNumberList(document.getElementById('lot2StopLoss').value),
            lot3: parseNumberList(document.getElementById('lot3StopLoss').value)
        },
        take_profit_ranges: {
            unified: parseNumberList(document.getElementById('unifiedProfit').value),
            individual: parseNumberList(document.getElementById('individualProfit').value)
        },
        time_intervals: timeIntervals,
        entry_price_mode: document.querySelector('input[name="entry_price_mode"]:checked').value,
        max_workers: parseInt(document.getElementById('maxWorkers').value)
    };
}
```

### 停利模式處理邏輯
**文件：** `mdd_gui.py`  
**關鍵函數：** `run_experiment_thread_unified()` (行 896-1195)

#### 停利模式組合生成 (行 930-962)
```python
# 1. 統一停利模式
if 'unified' in take_profit_ranges and take_profit_ranges['unified']:
    unified_values = take_profit_ranges['unified']
    all_take_profit_combinations.append({
        'mode': 'unified_fixed',
        'lot1': unified_values,
        'lot2': unified_values,
        'lot3': unified_values
    })

# 2. 個別停利模式
if 'individual' in take_profit_ranges and take_profit_ranges['individual']:
    individual_values = take_profit_ranges['individual']
    all_take_profit_combinations.append({
        'mode': 'individual_fixed',
        'lot1': individual_values,
        'lot2': individual_values,
        'lot3': individual_values
    })

# 3. 區間邊緣停利模式（固定添加）
all_take_profit_combinations.append({
    'mode': 'range_boundary',
    'lot1': [0],
    'lot2': [0],
    'lot3': [0]
})
```

### 🚨 **發現的第一個問題：停利類型標記邏輯**

#### 問題位置：行 1060
```python
'take_profit_mode': tp_combination['mode'],
```

**問題分析：**
- GUI 正確生成了三種停利模式：`unified_fixed`、`individual_fixed`、`range_boundary`
- 每個實驗結果都有正確的 `take_profit_mode` 標記
- 但前端顯示邏輯可能沒有正確使用這個字段

### 前端顯示邏輯問題
**文件：** `mdd_gui.py`  
**問題位置：** 行 525-541 (時間區間結果顯示)

```javascript
// 處理停利類型顯示
let stopProfitType = '統一停利';
if (config.type && config.type !== '統一停利') {
    stopProfitType = config.type;
}

// 根據停利類型添加數字 - 從實際配置中獲取
if (stopProfitType === '統一停利') {
    const unifiedProfit = document.getElementById('unifiedProfit').value || '30';
    stopProfitType = `統一停利 ${unifiedProfit}`;
}
```

### 🚨 **發現的第二個問題：前端顯示邏輯缺陷**

**根本原因：**
1. 前端顯示邏輯預設所有結果為「統一停利」
2. 沒有正確使用後端傳回的 `take_profit_mode` 字段
3. 顯示數字時使用的是 GUI 當前輸入值，而非實驗實際使用的參數值

## ⚙️ 第三階段：核心回測引擎分析

### 參數接收機制
**文件：** `rev_multi_Profit-Funded Risk_多口.py`  
**關鍵函數：** `create_strategy_config_from_gui()` (行 821-957)

### 停利模式處理
```python
# 檢查是否啟用每口獨立停利設定
individual_take_profit_enabled = gui_config.get("individual_take_profit_enabled", False)

# 如果啟用每口獨立停利，設定固定停利點數
if individual_take_profit_enabled and "take_profit" in lot_settings["lot1"]:
    lot1_rule.fixed_tp_points = Decimal(str(lot_settings["lot1"]["take_profit"]))
```

### 🚨 **發現的第三個問題：參數傳遞不完整**

**問題分析：**
1. GUI 生成的配置中包含完整的停利模式信息
2. 但核心引擎的配置工廠函數沒有完全使用這些信息
3. 停利模式的區分主要依賴 `individual_take_profit_enabled` 標誌，而非具體的模式類型

## 🔍 第四階段：根本原因分析

### 問題根源總結

#### 1. 前端顯示邏輯問題（主要問題）
- **位置：** `mdd_gui.py` 行 525-541, 635-645, 695-705
- **問題：** 硬編碼預設為「統一停利」，未使用後端返回的實際模式
- **影響：** 所有實驗結果顯示相同的停利類型

#### 2. 數據結構不一致
- **問題：** 前端期望的數據結構與後端提供的不完全匹配
- **表現：** `config.type` 字段可能未正確設置或傳遞

#### 3. 參數映射邏輯缺失
- **問題：** 缺少從 `take_profit_mode` 到顯示文字的映射邏輯
- **需要：** 建立 `unified_fixed` → `統一停利`、`individual_fixed` → `個別停利`、`range_boundary` → `區間停利` 的映射

### 數據準確性評估

**結論：** 回測數據本身是準確的
- 核心引擎正確處理了不同的停利模式
- 問題主要在於前端顯示邏輯，而非計算邏輯
- 實際的 P&L 計算基於正確的參數配置

## 🛠️ 修復建議

### 優先級 1：修復前端顯示邏輯
1. **修改位置：** `mdd_gui.py` 行 525-541
2. **修復方案：** 使用後端返回的 `take_profit_mode` 字段
3. **實施步驟：**
   - 建立模式映射字典
   - 修改顯示邏輯使用實際模式
   - 確保數字顯示使用實驗實際參數

### 優先級 2：完善數據結構
1. **確保後端正確設置 `type` 字段**
2. **統一前後端數據結構定義**
3. **添加數據驗證機制**

### 優先級 3：增強調試能力
1. **添加詳細的日誌輸出**
2. **在前端添加調試信息顯示**
3. **建立數據一致性檢查機制**

## 📈 後續行動計畫

### 立即行動（1-2天）
1. 修復前端顯示邏輯
2. 驗證修復效果
3. 進行回歸測試

### 短期改進（1週內）
1. 完善數據結構一致性
2. 添加自動化測試
3. 建立監控機制

### 長期優化（1個月內）
1. 重構參數處理架構
2. 建立完整的數據驗證框架
3. 優化用戶體驗

---

**報告生成時間：** 2025-01-18  
**分析工具：** Augment Agent  
**下一步：** 等待用戶確認修復方案並開始實施
