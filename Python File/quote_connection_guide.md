# 🔗 報價連線與商品查詢完整指南

## 🎯 **問題解決**

根據你的發現，錯誤1095 `SK_ERROR_QUOTE_CONNECT_FIRST` 表示需要先建立報價連線。我已經實現了完整的連線流程！

### ✅ **已實現的正確連線順序**

根據群益官方文件和案例，正確的順序是：

```
1. 初始化 SKQuoteLib 物件
2. 註冊 OnConnection 事件處理
3. 呼叫 SKQuoteLib_EnterMonitorLONG() 連線
4. 等待 OnConnection(3003) - Stocks ready!
5. 查詢期貨商品清單 SKQuoteLib_RequestStockList(2)
```

## 📋 **連線狀態代碼說明**

### OnConnection 事件的 nKind 值
- **3001**: Connected! 已連線到報價主機
- **3002**: DisConnected! 已斷線
- **3003**: Stocks ready! 商品資料已準備完成 ⭐ **關鍵狀態**
- **3021**: Connect Error! 連線錯誤

### 重要提醒
**只有收到 nKind = 3003 (Stocks ready!) 後，才能安全地查詢商品清單！**

## 🧪 **測試步驟**

### 步驟1: 啟動程式並登入
```bash
cd "Python File"
python OrderTester.py
```

1. **登入**: `E123354882` / `kkd5ysUCC`
2. **確認登入成功** (狀態變綠色)

### 步驟2: 連線報價主機
1. **切換到「期貨報價查詢」頁籤**
2. **點擊「連線報價主機」按鈕** (藍色按鈕)
3. **觀察連線過程**

#### 預期看到的連線訊息：
```
【連線】開始連線報價主機...
【API調用】SKQuoteLib_EnterMonitorLONG() - SK_SUCCESS (代碼: 0)
【成功】連線請求已送出，等待連線完成...
【連線狀態】Connected! 已連線到報價主機
【連線狀態】Stocks ready! 商品資料已準備完成
【準備完成】商品資料已下載完成，可以開始查詢商品清單
【自動查詢】開始自動查詢期貨商品清單...
```

### 步驟3: 自動查詢期貨商品
**系統會在收到 Stocks ready! 後自動查詢期貨商品清單**

#### 預期看到的查詢訊息：
```
【查詢】開始查詢期貨商品清單...
【API調用】SKQuoteLib_RequestStockList(2) - SK_SUCCESS (代碼: 0)
【回報】收到市場 2 的商品清單回報
【發現】小台指合約: MXFR1
【統計】共找到 XXX 個期貨商品，其中 X 個小台指合約
```

### 步驟4: 查詢小台指近月合約
1. **點擊「查詢小台指近月合約」按鈕**
2. **系統自動分析並找出近月合約**

#### 預期結果：
```
【分析】開始分析小台指近月合約...
【成功】找到小台指近月合約: MXFR1
```

### 步驟5: 應用到下單頁面
1. **切換到「期貨下單」頁籤**
2. **點擊「查詢近月」按鈕** (綠色)
3. **商品自動更新為API查詢的近月合約**

## 🔧 **UI界面變化**

### 連線前
- **「連線報價主機」按鈕**: 可用 (藍色)
- **「查詢期貨商品清單」按鈕**: 禁用 (灰色)
- **「查詢小台指近月合約」按鈕**: 禁用 (灰色)
- **狀態**: "準備查詢" (藍色)

### 連線中
- **「連線報價主機」按鈕**: 禁用 (防止重複連線)
- **狀態**: "連線中..." (橙色)

### 連線完成且商品資料準備完成
- **「查詢期貨商品清單」按鈕**: 可用
- **「查詢小台指近月合約」按鈕**: 可用
- **狀態**: "已連線 - 商品資料準備完成" (綠色)

## 📊 **技術實現細節**

### 1. **連線狀態管理**
```python
# 連線狀態追蹤
self.is_connected = False      # 是否已連線
self.stocks_ready = False      # 商品資料是否準備完成

# 只有兩個狀態都為True才能查詢商品
if not self.is_connected or not self.stocks_ready:
    return  # 拒絕查詢
```

### 2. **事件處理 (參考官方案例)**
```python
def OnConnection(self, nKind, nCode):
    if nKind == 3001:      # Connected
        self.parent.is_connected = True
    elif nKind == 3003:    # Stocks ready
        self.parent.stocks_ready = True
        self.parent.on_stocks_ready()  # 觸發準備完成事件
```

### 3. **自動化流程**
```python
def on_stocks_ready(self):
    # 啟用查詢按鈕
    self.btn_query_futures.config(state=tk.NORMAL)
    
    # 自動查詢期貨商品清單
    self.query_future_products()
```

## 🎯 **故障排除**

### 如果連線失敗
1. **檢查登入狀態** - 確認已成功登入
2. **檢查網路連線** - 確認網路正常
3. **重新啟動程式** - 重新登入並連線

### 如果一直沒有收到 Stocks ready!
1. **等待更長時間** - 商品資料下載可能需要時間
2. **檢查防火牆** - 確認沒有阻擋API連線
3. **重新連線** - 重新啟動程式並重新連線

### 如果查詢商品清單失敗
1. **確認已收到 Stocks ready!** - 檢查訊息區域
2. **檢查連線狀態** - 確認狀態顯示為綠色
3. **手動點擊查詢** - 如果自動查詢失敗，手動點擊按鈕

## 🎉 **完整的交易流程**

### 現在的完整流程
1. ✅ **登入** (`E123354882`)
2. ✅ **連線報價主機** (SKQuoteLib_EnterMonitorLONG)
3. ✅ **等待商品資料準備** (OnConnection 3003)
4. ✅ **動態查詢期貨商品** (SKQuoteLib_RequestStockList)
5. ✅ **自動找出近月合約** (智能分析)
6. ✅ **更新下單商品** (一鍵操作)
7. ✅ **期貨下單** (使用正確的近月合約)
8. ✅ **回報接收** (委託/成交回報)

## 🚀 **測試檢查清單**

### 連線測試
- [ ] 程式啟動並登入成功
- [ ] 切換到期貨報價查詢頁籤
- [ ] 點擊「連線報價主機」
- [ ] 看到 "Connected!" 訊息
- [ ] 看到 "Stocks ready!" 訊息
- [ ] 狀態變為綠色

### 查詢測試
- [ ] 自動查詢期貨商品清單
- [ ] 找到小台指合約
- [ ] 成功識別近月合約
- [ ] 商品清單表格顯示正常

### 下單測試
- [ ] 切換到期貨下單頁籤
- [ ] 點擊「查詢近月」按鈕
- [ ] 商品自動更新
- [ ] 下單測試成功

**🎯 目標：建立完整的報價連線，實現動態商品查詢功能！**

---
*報價連線與商品查詢完整指南*
*時間: 2025-06-29*
*狀態: 實現正確的連線流程，解決1095錯誤*
