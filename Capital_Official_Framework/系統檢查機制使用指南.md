# 🔍 系統檢查機制完整使用指南

## 📋 概述
為了解決您擔心的緩存命中增加但失敗任務也增加的問題，我們建立了完整的三層檢查機制。

## 🛠️ 三層檢查工具

### 🔍 第一層：快速異步檢查 (quick_async_check.py)
**用途：** 快速診斷異步系統狀態，適合日常檢查

**檢查項目：**
- ✅ AsyncUpdater狀態和統計信息
- ✅ 工作線程活躍狀態  
- ✅ 任務隊列大小和積壓情況
- ✅ 數據庫連接健康狀態
- ✅ 緩存狀態和命中率
- ✅ 鎖定狀態和過期檢查

**使用方法：**
```python
# 方法1：在程序中調用
self.quick_async_check()

# 方法2：點擊UI按鈕
# 點擊 "🔍 快速診斷" 按鈕

# 方法3：直接調用
from quick_async_check import quick_async_check
quick_async_check(main_app_instance)
```

**預期輸出：**
```
🔍 快速異步檢查開始...
📋 步驟1: 檢查異步更新器...
   ✅ 異步更新器存在
   📊 統計信息:
      - 總任務: 150
      - 完成任務: 142
      - 失敗任務: 8
      - 緩存命中: 95
      - 成功率: 94.7%
      - 失敗率: 5.3%
   ✅ 失敗率正常 (5.3%)

📊 檢查結果總結:
   ✅ async_updater_status: 正常
   ✅ database_connection: 正常
   ✅ worker_thread_status: 正常
   ✅ queue_status: 正常
   ✅ cache_status: 正常
   ✅ lock_status: 正常

🎯 總體狀態: 6/6 項檢查通過
✅ 系統狀態良好
```

### 🔬 第二層：異步失敗診斷 (async_failure_diagnostic.py)
**用途：** 深度分析失敗原因和性能瓶頸，適合問題排查

**檢查項目：**
- 🔍 數據庫深度分析（事務時間、鎖定衝突、表大小）
- 🧠 內存使用分析（緩存大小、內存洩漏、垃圾回收）
- 🧵 線程狀態分析（死鎖風險、線程效率、活躍線程）
- ⚡ 性能瓶頸分析（隊列延遲、響應時間、瓶頸源）
- 🚨 錯誤模式分析（失敗頻率、錯誤趨勢、關鍵錯誤）

**使用方法：**
```python
# 在程序中調用
self.run_full_diagnostic()

# 直接調用
from async_failure_diagnostic import run_diagnostic_on_simple_integrated
run_diagnostic_on_simple_integrated(main_app_instance)
```

**預期輸出：**
```
🔬 異步失敗深度診斷開始...
📋 步驟1: 數據庫深度分析...
   📊 數據庫表數量: 8
   ⏱️ 事務時間: 0.025秒

📋 步驟2: 內存使用分析...
   📊 緩存統計:
      - risk_manager_position_cache: 12 項
      - async_position_cache: 8 項
   🗑️ 總緩存項目: 20

📋 步驟3: 線程狀態分析...
   🧵 總線程數: 8
   ✅ 活躍線程: 8
   🔧 AsyncWorker: active

📊 診斷報告總結
⚠️ 高優先級問題:
   - 數據庫事務時間過長
     解決方案: 調整數據庫超時設置，優化查詢語句

📋 總計發現 1 個問題需要處理
```

### 🏥 第三層：系統健康監控 (system_health_monitor.py)
**用途：** 全面系統健康檢查和監控，適合定期維護

**檢查項目：**
- 💻 系統資源（CPU、內存、磁盤使用率、進程內存）
- 🗃️ 數據庫健康（文件大小、完整性、響應時間、活躍部位）
- 🧠 內存健康（緩存大小、垃圾回收統計、內存洩漏檢測）
- 🧵 線程健康（線程數量、AsyncWorker狀態、守護線程）
- 📊 緩存健康（命中率、緩存效率、過期條目）
- 🔒 鎖定健康（鎖定數量、過期鎖定、鎖定詳情）
- ⚡ 性能健康（隊列大小、失敗率、瓶頸識別）

**使用方法：**
```python
# 方法1：在程序中調用
self.run_health_check()

# 方法2：點擊UI按鈕
# 點擊 "🏥 健康檢查" 按鈕

# 方法3：直接調用
from system_health_monitor import run_health_check_on_simple_integrated
run_health_check_on_simple_integrated(main_app_instance)
```

**預期輸出：**
```
🏥 系統健康檢查開始...
📋 檢查系統資源...
   💻 CPU使用率: 15.2%
   🧠 內存使用率: 45.8%
   💾 磁盤使用率: 67.3%
   🔧 進程內存: 156.7MB

📋 檢查數據庫健康...
   📊 數據庫大小: 2.3MB
   📋 表數量: 8
   🛡️ 完整性: ok
   📈 活躍部位: 0
   ⚡ 響應時間: 0.015秒

🏥 系統健康報告
📊 總體健康分數: 90/100
✅ 系統健康狀態優秀

💡 建議:
   - 定期清理緩存
```

## 🎯 使用場景和時機

### 🔍 日常檢查 - 快速診斷
**時機：**
- 每次啟動程序後
- 發現異常行為時
- 定期維護檢查

**操作：**
```python
# 點擊 "🔍 快速診斷" 按鈕
# 或在Console中執行
self.quick_async_check()
```

### 🔬 問題排查 - 深度診斷
**時機：**
- 快速診斷發現問題時
- 系統性能下降時
- 失敗率異常增高時

**操作：**
```python
# 在Console中執行
self.run_full_diagnostic()
```

### 🏥 定期維護 - 健康檢查
**時機：**
- 每日開始交易前
- 每週定期維護
- 長時間運行後

**操作：**
```python
# 點擊 "🏥 健康檢查" 按鈕
# 或在Console中執行
self.run_health_check()
```

## 🚨 警報和建議處理

### 關鍵問題 (Critical)
- 🚨 立即停止交易
- 🔧 執行建議的修復措施
- 🔄 重啟相關組件

### 高優先級問題 (High)
- ⚠️ 密切監控
- 🔧 計劃修復時間
- 📊 增加檢查頻率

### 中優先級問題 (Medium)
- 💡 記錄問題
- 🔧 安排維護時間
- 📈 監控趨勢

## 🔧 自動化檢查

系統已配置自動檢查：
- **定期健康檢查：** 每30分鐘自動執行
- **過期鎖定清理：** 每5分鐘自動清理
- **內存緩存清理：** 每1小時自動清理

## 💡 最佳實踐

### 檢查順序建議
1. **啟動時：** 快速診斷
2. **發現問題：** 深度診斷
3. **定期維護：** 健康檢查
4. **問題解決後：** 再次快速診斷確認

### 日誌監控
- 關注Console輸出的警告信息
- 監控失敗率變化趨勢
- 注意內存和緩存使用情況

### 預防措施
- 定期執行清理腳本
- 監控系統資源使用
- 及時處理警報建議

---

**記住：預防勝於治療，定期檢查確保系統穩定運行！** 🎯
