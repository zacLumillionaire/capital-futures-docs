# 反轉策略未來路徑分析器 - 使用說明

## 📋 概述

這個工具能夠分析反轉策略的未來可能路徑，使用蒙地卡羅模擬方法預測未來資金曲線變化。

**版本 2.0 新功能：**
- ✅ 支援外部 YAML 配置文件
- ✅ 命令列參數支援
- ✅ 多種預設配置範例
- ✅ 完全可配置的參數系統

## 🚀 快速開始

```bash
cd /Users/z/big/my-capital-project/quan_rev_strategy_analysis/rev_rev_future_path_analyzer

# 使用預設配置
python rev_future_path_analyzer.py

# 使用快速測試配置
python rev_future_path_analyzer.py --config quick_test_config.yml

# 使用保守型配置
python rev_future_path_analyzer.py --config conservative_config.yml

# 使用積極型配置
python rev_future_path_analyzer.py --config aggressive_config.yml
```

## 📁 配置文件說明

### 可用的配置文件

1. **`config.yml`** - 預設配置（標準設定）
2. **`quick_test_config.yml`** - 快速測試配置（500次模擬，20天預測）
3. **`conservative_config.yml`** - 保守型配置（降低風險）
4. **`aggressive_config.yml`** - 積極型配置（追求更高收益）

### 自定義配置

您可以複製任一配置文件並修改參數來創建自己的配置：

```bash
cp config.yml my_custom_config.yml
# 編輯 my_custom_config.yml
python rev_future_path_analyzer.py --config my_custom_config.yml
```

## ⚙️ 參數配置說明

### 1. 蒙地卡羅分析參數

在 `rev_future_path_analyzer.py` 文件的第 237-241 行：

```python
# === 分析參數設定 ===
NUM_SIMULATIONS = 2000      # 模擬次數
NUM_FUTURE_DAYS = 60        # 未來預測天數
PROFIT_TARGET_PCT = 0.20    # 獲利目標 20%
RISK_LIMIT_PCT = 0.15       # 風險底線 15%
INITIAL_CAPITAL = 100000    # 起始資金 100,000 點
```

**修改說明：**
- `NUM_SIMULATIONS`: 模擬路徑數量，建議 1000-5000
- `NUM_FUTURE_DAYS`: 預測天數，建議 30-120 天
- `PROFIT_TARGET_PCT`: 獲利目標百分比 (0.20 = 20%)
- `RISK_LIMIT_PCT`: 風險底線百分比 (0.15 = 15%)
- `INITIAL_CAPITAL`: 模擬起始資金

### 2. 回測時間區段

在 `rev_future_path_analyzer.py` 文件的第 307-315 行：

```python
# 執行回測（使用最近的交易數據）
backtest_results = run_rev_backtest(
    config=strategy_config,
    start_date="2024-11-04",  # 開始日期
    end_date="2025-06-28",    # 結束日期
    silent=False,             # 顯示回測過程
    range_start_time="08:46", # 開盤區間開始時間
    range_end_time="08:47",   # 開盤區間結束時間
    enable_console_log=True   # 啟用控制台日誌
)
```

**修改說明：**
- `start_date`: 回測開始日期 (格式: "YYYY-MM-DD")
- `end_date`: 回測結束日期 (格式: "YYYY-MM-DD")
- `range_start_time`: 開盤區間開始時間 (格式: "HH:MM")
- `range_end_time`: 開盤區間結束時間 (格式: "HH:MM")

### 3. 策略交易參數

在 `rev_future_path_analyzer.py` 文件的第 255-287 行：

```python
strategy_config = StrategyConfig(
    trade_size_in_lots=3,                    # 交易口數
    stop_loss_type=StopLossType.RANGE_BOUNDARY,  # 停損類型
    lot_rules=[
        # 第1口：15點觸發，10%回檔
        LotRule(
            use_trailing_stop=True,
            trailing_activation=Decimal(15),      # 觸發點數
            trailing_pullback=Decimal('0.10')    # 回檔比例 10%
        ),
        # 第2口：40點觸發，10%回檔，2倍保護性停損
        LotRule(
            use_trailing_stop=True,
            trailing_activation=Decimal(40),      # 觸發點數
            trailing_pullback=Decimal('0.10'),   # 回檔比例 10%
            protective_stop_multiplier=Decimal('2.0')  # 保護性停損倍數
        ),
        # 第3口：41點觸發，20%回檔，2倍保護性停損
        LotRule(
            use_trailing_stop=True,
            trailing_activation=Decimal(41),      # 觸發點數
            trailing_pullback=Decimal('0.20'),   # 回檔比例 20%
            protective_stop_multiplier=Decimal('2.0')  # 保護性停損倍數
        )
    ],
    # 啟用160點區間過濾
    range_filter=RangeFilter(
        use_range_size_filter=True,
        max_range_points=Decimal(160)             # 區間大小上限
    ),
    # 交易方向：多空都做
    trading_direction="BOTH"                      # "LONG_ONLY", "SHORT_ONLY", "BOTH"
)
```

## 📊 詳細參數說明

### 交易口數設定
- `trade_size_in_lots`: 同時交易的口數 (1-5)

### 停損類型
- `StopLossType.RANGE_BOUNDARY`: 區間邊緣停損 (預設)
- `StopLossType.FIXED_POINTS`: 固定點數停損
- `StopLossType.OPENING_PRICE`: 開盤價停損

### 各口停損停利設定

每口可以獨立設定以下參數：

#### 移動停損模式 (use_trailing_stop=True)
- `trailing_activation`: 觸發點數 (例如: 15 = 15點)
- `trailing_pullback`: 回檔比例 (例如: 0.10 = 10%)
- `protective_stop_multiplier`: 保護性停損倍數 (可選)

#### 固定停損模式 (use_trailing_stop=False)
- `fixed_stop_loss_points`: 固定停損點數
- `fixed_tp_points`: 固定停利點數 (可選)

### 區間過濾設定
```python
range_filter=RangeFilter(
    use_range_size_filter=True,    # 是否啟用區間過濾
    max_range_points=Decimal(160)  # 區間大小上限 (點)
)
```

### 風險管理設定
```python
risk_config=RiskConfig(
    use_risk_filter=False,              # 是否啟用風險管理
    daily_loss_limit=Decimal(150),     # 每日虧損限制 (點)
    profit_target=Decimal(200)         # 每日獲利目標 (點)
)
```

### 交易方向設定
- `"BOTH"`: 多空都做 (預設)
- `"LONG_ONLY"`: 只做多
- `"SHORT_ONLY"`: 只做空

## 🔧 常用配置範例

### 範例1: 保守型配置
```python
strategy_config = StrategyConfig(
    trade_size_in_lots=2,
    lot_rules=[
        LotRule(trailing_activation=Decimal(10), trailing_pullback=Decimal('0.15')),
        LotRule(trailing_activation=Decimal(25), trailing_pullback=Decimal('0.15'))
    ],
    range_filter=RangeFilter(use_range_size_filter=True, max_range_points=Decimal(100)),
    trading_direction="BOTH"
)
```

### 範例2: 積極型配置
```python
strategy_config = StrategyConfig(
    trade_size_in_lots=3,
    lot_rules=[
        LotRule(trailing_activation=Decimal(20), trailing_pullback=Decimal('0.05')),
        LotRule(trailing_activation=Decimal(50), trailing_pullback=Decimal('0.05')),
        LotRule(trailing_activation=Decimal(60), trailing_pullback=Decimal('0.10'))
    ],
    range_filter=RangeFilter(use_range_size_filter=True, max_range_points=Decimal(200)),
    trading_direction="BOTH"
)
```

### 範例3: 只做多配置
```python
strategy_config = StrategyConfig(
    trade_size_in_lots=2,
    lot_rules=[
        LotRule(trailing_activation=Decimal(15), trailing_pullback=Decimal('0.10')),
        LotRule(trailing_activation=Decimal(35), trailing_pullback=Decimal('0.15'))
    ],
    trading_direction="LONG_ONLY"
)
```

## 📈 輸出結果說明

### 生成的文件
- `future_paths_spaghetti_chart_YYYYMMDD_HHMMSS.png`: 義大利麵圖
- `analysis_summary.txt`: 分析總結報告

### 關鍵指標解釋
- **觸及獲利目標的路徑**: 在模擬期間達到獲利目標的路徑百分比
- **觸及風險底線的路徑**: 在模擬期間觸及風險底線的路徑百分比
- **最終資金分位數**: 
  - 5%分位數: 悲觀情境
  - 50%分位數: 中位數情境
  - 95%分位數: 樂觀情境

## ⚠️ 注意事項

1. **數據要求**: 至少需要10天的歷史交易數據
2. **模擬次數**: 建議使用1000-5000次模擬以獲得穩定結果
3. **參數調整**: 修改參數後需要重新運行整個分析
4. **結果解釋**: 模擬結果基於歷史數據，實際結果可能有差異

## 🛠️ 故障排除

### 常見問題
1. **ModuleNotFoundError**: 確保在正確的目錄下運行
2. **數據不足**: 調整日期範圍增加歷史數據
3. **記憶體不足**: 減少模擬次數或預測天數

### 聯繫支援
如有問題，請檢查控制台輸出的錯誤訊息，並確保所有依賴項目正確安裝。
