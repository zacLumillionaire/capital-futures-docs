# åœæå¹³å€‰è¿½åƒ¹æ©Ÿåˆ¶èª¿æŸ¥å ±å‘Š

## ğŸ“‹ å•é¡Œæè¿°

æ ¹æ“šå¹³å€‰ç´€éŒ„.mdçš„åˆ†æï¼Œç™¼ç¾å…©å£éƒ¨ä½ï¼ˆ36å’Œ37ï¼‰é€²å…¥åœæå¹³å€‰å¾Œï¼Œé›–ç„¶ä¸‹å–®æˆåŠŸä½†æ²’æœ‰æˆåŠŸç¹¼çºŒè¿½åƒ¹ã€‚æŒ‰ç…§ç©ºå–®å¹³å€‰é‚è¼¯ï¼Œå¦‚æœå¹³å€‰å¤±æ•—æ‡‰è©²è¦ç”¨æ–°å ±åƒ¹çš„ASK1é€²è¡Œé‡æ–°é€å‡ºå¹³å€‰ï¼Œä½†ç³»çµ±æ²’æœ‰æ­£å¸¸åŸ·è¡Œè¿½åƒ¹æ©Ÿåˆ¶ã€‚

### é—œéµç¾è±¡
- âœ… åœæè§¸ç™¼æ­£å¸¸ï¼šéƒ¨ä½36å’Œ37éƒ½æ­£ç¢ºè§¸ç™¼åœæ
- âœ… å¹³å€‰ä¸‹å–®æˆåŠŸï¼šå…©å€‹éƒ¨ä½éƒ½æˆåŠŸä¸‹å–®ï¼ˆè¨‚å–®ID: 2b34205f, 8c64721fï¼‰
- âŒ è¿½åƒ¹æ©Ÿåˆ¶å¤±æ•ˆï¼šåªæœ‰éƒ¨ä½36åŸ·è¡Œäº†ä¸€æ¬¡è¿½åƒ¹ï¼Œéƒ¨ä½37å®Œå…¨æ²’æœ‰è¿½åƒ¹
- âŒ å›å ±è™•ç†ç•°å¸¸ï¼šLOGé¡¯ç¤ºã€Œæ‰€æœ‰è¿½è¹¤å™¨éƒ½æœªè™•ç†æ­¤å›å ±ã€

## ğŸ” æŠ€è¡“åˆ†æ

### Task 1: åœæå¹³å€‰é‹ä½œæ©Ÿåˆ¶åˆ†æ

#### æ ¸å¿ƒæ¨¡çµ„äº¤äº’æµç¨‹
```
OptimizedRiskManager â†’ StopExecutor â†’ SimplifiedTracker
     â†“                      â†“               â†“
  è§¸ç™¼æª¢æ¸¬              åŸ·è¡Œå¹³å€‰         è¿½åƒ¹å›èª¿
```

**é—œéµç™¼ç¾**ï¼š
1. **OptimizedRiskManager**: æ­£å¸¸æª¢æ¸¬åˆ°åœæè§¸ç™¼æ¢ä»¶
2. **StopExecutor**: æˆåŠŸåŸ·è¡Œå¹³å€‰ä¸‹å–®ä¸¦è¨»å†Šåˆ°SimplifiedTracker
3. **SimplifiedTracker**: è¿½åƒ¹å›èª¿æ©Ÿåˆ¶å­˜åœ¨å•é¡Œ

### Task 2: LOGåˆ†æèˆ‡ä»£ç¢¼æ¯”å°

#### é—œéµLOGåˆ†æ
```
ç¬¬147è¡Œ: âš ï¸ [REPLY] æ‰€æœ‰è¿½è¹¤å™¨éƒ½æœªè™•ç†æ­¤å›å ±
ç¬¬149è¡Œ: [FIFO_MATCHER] âš ï¸ ç´”FIFOæ‰¾ä¸åˆ°åŒ¹é…: TM0000 1å£ @23304.0
ç¬¬179è¡Œ: [SIMPLIFIED_TRACKER] ğŸ”„ å¹³å€‰çµ„36ç¬¬1å£è§¸ç™¼è¿½åƒ¹: ç¬¬1æ¬¡, 1å£
```

**å•é¡Œè­˜åˆ¥**ï¼š
1. **å›å ±è™•ç†éˆæ–·è£‚**ï¼šSimplifiedTrackerç„¡æ³•è™•ç†å–æ¶ˆå›å ±
2. **FIFOåŒ¹é…å¤±æ•—**ï¼šå•†å“ä»£ç¢¼åŒ¹é…é‚è¼¯æœ‰å•é¡Œ
3. **éƒ¨åˆ†è¿½åƒ¹åŸ·è¡Œ**ï¼šåªæœ‰éƒ¨ä½36è§¸ç™¼è¿½åƒ¹ï¼Œéƒ¨ä½37è¢«å¿½ç•¥

### Task 3: åœævsç§»å‹•åœåˆ©è¿½åƒ¹æ©Ÿåˆ¶æ¯”è¼ƒ

#### è¿½åƒ¹æ©Ÿåˆ¶å°æ¯”
| é …ç›® | åœæå¹³å€‰ | ç§»å‹•åœåˆ©å¹³å€‰ | ä¸€è‡´æ€§ |
|------|----------|--------------|--------|
| åŸ·è¡Œå™¨ | StopExecutor | StopExecutor | âœ… ç›¸åŒ |
| è¨»å†Šæ–¹å¼ | register_exit_group | register_exit_group | âœ… ç›¸åŒ |
| è¿½åƒ¹å›èª¿ | SimplifiedTracker | SimplifiedTracker | âœ… ç›¸åŒ |
| å•†å“ä»£ç¢¼ | "TM0000" | "TM0000" | âœ… ç›¸åŒ |
| åƒ¹æ ¼è¨ˆç®— | ASK1+retry_count | ASK1+retry_count | âœ… ç›¸åŒ |

**çµè«–**ï¼šå…©ç¨®å¹³å€‰æ©Ÿåˆ¶ä½¿ç”¨å®Œå…¨ç›¸åŒçš„è¿½åƒ¹é‚è¼¯ï¼Œå•é¡Œä¸åœ¨æ©Ÿåˆ¶è¨­è¨ˆå·®ç•°ã€‚

## ğŸ¯ æ ¹å› åˆ†æ

### æ ¸å¿ƒå•é¡Œï¼šå•†å“ä»£ç¢¼åŒ¹é…å¤±æ•ˆ

#### å•é¡Œ1: è¨»å†Švså›å ±çš„å•†å“ä»£ç¢¼ä¸åŒ¹é…
```python
# StopExecutorè¨»å†Šæ™‚ä½¿ç”¨
product="TM0000"

# å›å ±è™•ç†æ™‚æ”¶åˆ°
product="TM2508"  # å¯¦éš›åˆç´„ä»£ç¢¼

# SimplifiedTrackeræ¨™æº–åŒ–é‚è¼¯
def _normalize_product_code(self, product: str) -> str:
    if product.startswith("TM") and len(product) == 6:
        return "TM0000"  # TM2508 â†’ TM0000
```

**åˆ†æ**ï¼šé›–ç„¶æœ‰æ¨™æº–åŒ–é‚è¼¯ï¼Œä½†åœ¨æŸäº›æƒ…æ³ä¸‹åŒ¹é…ä»ç„¶å¤±æ•—ã€‚

#### å•é¡Œ2: FIFOåŒ¹é…æ™‚é–“çª—å£å•é¡Œ
```python
# æ™‚é–“çª—å£æª¢æŸ¥ï¼ˆ30ç§’å…§ï¼‰
if current_time - exit_info['submit_time'] > 30:
    continue
```

**åˆ†æ**ï¼šå¦‚æœç³»çµ±è™•ç†å»¶é²ï¼Œå¯èƒ½å°è‡´è¨‚å–®è¶…å‡ºæ™‚é–“çª—å£ã€‚

#### å•é¡Œ3: å›å ±è™•ç†å„ªå…ˆç´šå•é¡Œ
```python
# å›å ±è™•ç†é †åº
1. SimplifiedTracker.process_order_reply()
2. TotalLotTracker (å¦‚æœSimplifiedTrackerå¤±æ•—)
3. UnifiedOrderTracker (å¦‚æœå‰å…©è€…éƒ½å¤±æ•—)
```

**åˆ†æ**ï¼šç•¶SimplifiedTrackerè™•ç†å¤±æ•—æ™‚ï¼Œå…¶ä»–è¿½è¹¤å™¨ç„¡æ³•è§¸ç™¼å¹³å€‰è¿½åƒ¹ã€‚

## ğŸ’¡ è§£æ±ºæ–¹æ¡ˆå»ºè­°

### æ–¹æ¡ˆ1: å¢å¼·å•†å“ä»£ç¢¼åŒ¹é…é‚è¼¯
```python
def _normalize_product_code(self, product: str) -> str:
    """å¢å¼·ç‰ˆå•†å“ä»£ç¢¼æ¨™æº–åŒ–"""
    # è¨˜éŒ„åŸå§‹ä»£ç¢¼ç”¨æ–¼èª¿è©¦
    if self.console_enabled:
        print(f"[SIMPLIFIED_TRACKER] ğŸ” æ¨™æº–åŒ–å•†å“ä»£ç¢¼: {product}")
    
    if product.startswith("TM") and len(product) >= 4:
        normalized = "TM0000"
        if self.console_enabled:
            print(f"[SIMPLIFIED_TRACKER] ğŸ“ {product} â†’ {normalized}")
        return normalized
    
    return product
```

### æ–¹æ¡ˆ2: æ”¹å–„FIFOåŒ¹é…å®¹éŒ¯æ€§
```python
def _find_matching_exit_order(self, price: float, qty: int, product: str, for_cancel=False):
    """å¢å¼·ç‰ˆFIFOåŒ¹é…"""
    # 1. æ”¾å¯¬æ™‚é–“çª—å£ï¼ˆ60ç§’ï¼‰
    time_window = 60
    
    # 2. å¢åŠ èª¿è©¦ä¿¡æ¯
    if self.console_enabled:
        print(f"[SIMPLIFIED_TRACKER] ğŸ” æœå°‹å¹³å€‰è¨‚å–®:")
        print(f"  æ¢ä»¶: å•†å“={product}, åƒ¹æ ¼={price}, æ•¸é‡={qty}")
        print(f"  ç¾æœ‰è¨‚å–®æ•¸é‡: {len(self.exit_orders)}")
    
    # 3. å¦‚æœç²¾ç¢ºåŒ¹é…å¤±æ•—ï¼Œå˜—è©¦æ¨¡ç³ŠåŒ¹é…
    if not candidates and for_cancel:
        # å–æ¶ˆå›å ±ç‰¹æ®Šè™•ç†ï¼šåªåŒ¹é…å•†å“å’Œæ™‚é–“
        for order_id, exit_info in self.exit_orders.items():
            if (self._normalize_product_code(exit_info['product']) == normalized_product and
                current_time - exit_info['submit_time'] <= time_window):
                candidates.append((exit_info['submit_time'], order_id, exit_info))
```

### æ–¹æ¡ˆ3: å¢åŠ å›å ±è™•ç†å‚™æ´æ©Ÿåˆ¶
```python
def process_order_reply(self, reply_data: str) -> bool:
    """å¢å¼·ç‰ˆå›å ±è™•ç†"""
    try:
        # åŸæœ‰è™•ç†é‚è¼¯
        processed = self._handle_original_logic(reply_data)
        
        # å¦‚æœè™•ç†å¤±æ•—ï¼Œå˜—è©¦å‚™æ´é‚è¼¯
        if not processed and order_type == "C":  # å–æ¶ˆå›å ±
            processed = self._handle_cancel_fallback(reply_data)
            
        return processed
    except Exception as e:
        if self.console_enabled:
            print(f"[SIMPLIFIED_TRACKER] âŒ å›å ±è™•ç†ç•°å¸¸: {e}")
            print(f"[SIMPLIFIED_TRACKER] ğŸ“‹ å›å ±å…§å®¹: {reply_data}")
        return False
```

### æ–¹æ¡ˆ4: å¢å¼·èª¿è©¦å’Œç›£æ§
```python
def _trigger_exit_retry_callbacks(self, exit_order):
    """å¢å¼·ç‰ˆè¿½åƒ¹å›èª¿è§¸ç™¼"""
    if self.console_enabled:
        print(f"[SIMPLIFIED_TRACKER] ğŸ”„ è§¸ç™¼å¹³å€‰è¿½åƒ¹å›èª¿:")
        print(f"  éƒ¨ä½ID: {exit_order['position_id']}")
        print(f"  è¨»å†Šçš„å›èª¿æ•¸é‡: {len(self.exit_retry_callbacks)}")
        print(f"  å›èª¿å‡½æ•¸åˆ—è¡¨: {[str(cb) for cb in self.exit_retry_callbacks]}")
    
    for i, callback in enumerate(self.exit_retry_callbacks):
        try:
            if self.console_enabled:
                print(f"[SIMPLIFIED_TRACKER] ğŸ“ åŸ·è¡Œå›èª¿{i+1}...")
            callback(exit_order)
            if self.console_enabled:
                print(f"[SIMPLIFIED_TRACKER] âœ… å›èª¿{i+1}åŸ·è¡ŒæˆåŠŸ")
        except Exception as e:
            if self.console_enabled:
                print(f"[SIMPLIFIED_TRACKER] âŒ å›èª¿{i+1}åŸ·è¡Œå¤±æ•—: {e}")
```

## ğŸš€ å¯¦æ–½å»ºè­°

### å„ªå…ˆç´š1: ç«‹å³ä¿®å¾©ï¼ˆé«˜é¢¨éšªï¼‰
1. **å¢å¼·å•†å“ä»£ç¢¼åŒ¹é…é‚è¼¯**ï¼šç¢ºä¿TM2508èƒ½æ­£ç¢ºåŒ¹é…åˆ°TM0000
2. **å¢åŠ èª¿è©¦æ—¥èªŒ**ï¼šåœ¨é—œéµç¯€é»å¢åŠ è©³ç´°æ—¥èªŒè¼¸å‡º

### å„ªå…ˆç´š2: çŸ­æœŸæ”¹å–„ï¼ˆä¸­é¢¨éšªï¼‰
1. **æ”¹å–„FIFOåŒ¹é…å®¹éŒ¯æ€§**ï¼šæ”¾å¯¬æ™‚é–“çª—å£å’ŒåŒ¹é…æ¢ä»¶
2. **å¢åŠ å›å ±è™•ç†å‚™æ´æ©Ÿåˆ¶**ï¼šç¢ºä¿å–æ¶ˆå›å ±èƒ½è¢«æ­£ç¢ºè™•ç†

### å„ªå…ˆç´š3: é•·æœŸå„ªåŒ–ï¼ˆä½é¢¨éšªï¼‰
1. **é‡æ§‹å›å ±è™•ç†æ¶æ§‹**ï¼šçµ±ä¸€å›å ±è™•ç†é‚è¼¯
2. **å¢å¼·ç›£æ§å’Œå‘Šè­¦**ï¼šå¯¦æ™‚ç›£æ§è¿½åƒ¹æ©Ÿåˆ¶é‹è¡Œç‹€æ…‹

## ğŸ“Š é æœŸæ•ˆæœ

å¯¦æ–½ä¸Šè¿°ä¿®å¾©æ–¹æ¡ˆå¾Œï¼Œé æœŸèƒ½å¤ ï¼š
- âœ… è§£æ±ºå•†å“ä»£ç¢¼åŒ¹é…å•é¡Œï¼Œç¢ºä¿100%çš„åœæå¹³å€‰èƒ½è¢«æ­£ç¢ºè­˜åˆ¥
- âœ… æé«˜FIFOåŒ¹é…æˆåŠŸç‡ï¼Œæ¸›å°‘ã€Œæ‰¾ä¸åˆ°åŒ¹é…è¨‚å–®ã€çš„æƒ…æ³
- âœ… ç¢ºä¿æ‰€æœ‰åœæå¹³å€‰éƒ½èƒ½æ­£å¸¸è§¸ç™¼è¿½åƒ¹æ©Ÿåˆ¶
- âœ… æä¾›è©³ç´°çš„èª¿è©¦ä¿¡æ¯ï¼Œä¾¿æ–¼å¾ŒçºŒå•é¡Œæ’æŸ¥

---

**å ±å‘Šæ’°å¯«æ™‚é–“**: 2025-07-18  
**èª¿æŸ¥ç¯„åœ**: Capital_Official_Framework åœæå¹³å€‰è¿½åƒ¹æ©Ÿåˆ¶  
**å•é¡Œåš´é‡ç¨‹åº¦**: é«˜ï¼ˆå½±éŸ¿äº¤æ˜“ç³»çµ±æ ¸å¿ƒåŠŸèƒ½ï¼‰  
**å»ºè­°è™•ç†æ™‚é–“**: 24å°æ™‚å…§å®Œæˆå„ªå…ˆç´š1ä¿®å¾©
