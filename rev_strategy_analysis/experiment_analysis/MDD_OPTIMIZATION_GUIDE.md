# 🎯 MDD最小化參數優化系統使用指南

## 📋 系統概述

**MDD最小化參數優化系統**專門設計用於尋找**最小最大回撤(Maximum Drawdown)**的最佳參數組合，支援**三口獨立停損停利設定**。

### 🔧 核心特色

✅ **三口獨立設定**: 每口可設定不同的停損點數  
✅ **MDD專門優化**: 重點關注風險控制而非單純收益  
✅ **風險調整收益**: 計算收益/回撤比例找出最佳平衡  
✅ **多場景測試**: 模擬各種市場條件  
✅ **可視化分析**: 生成熱力圖和散點圖  

## 📊 參數設定範圍

### 停損設定 (三口獨立)
- **第1口**: 10-30點 (步長5點)
- **第2口**: 20-50點 (步長5點)  
- **第3口**: 30-60點 (步長5點)

### 停利設定 (全局)
- **停利點數**: 30-100點 (步長10點)

### 時間區間
- **10:30-10:31**: 早盤活躍期
- **11:30-11:31**: 中午震盪期
- **12:30-12:31**: 午後時段

### 📈 實驗規模
- **總組合數**: 約 **2,520** 個實驗
  - 5個第1口選項 × 7個第2口選項 × 7個第3口選項 × 8個停利選項 × 3個時間區間
  - 實際數量會因停損遞增約束而略少

## 🚀 快速開始

### 1. 系統測試
```bash
# 進入實驗目錄
cd rev_strategy_analysis/experiment_analysis

# 運行系統測試
python test_mdd_optimizer.py
```

### 2. 快速測試 (推薦新手)
```bash
# 測試20個隨機樣本
python mdd_optimizer.py --sample-size 20

# 測試50個樣本並生成圖表
python mdd_optimizer.py --sample-size 50 --create-viz
```

### 3. 完整優化
```bash
# 運行所有2,520個實驗 (需要較長時間)
python mdd_optimizer.py

# 使用多進程加速
python mdd_optimizer.py --max-workers 4
```

## 📊 結果分析

### 輸出文件
```
results/
├── mdd_optimization_results_YYYYMMDD_HHMMSS.csv  # 詳細實驗數據
├── mdd_optimization.log                          # 執行日誌
└── mdd_visualization/                             # 可視化圖表
    ├── mdd_vs_pnl_scatter.png                    # MDD vs 收益散點圖
    └── mdd_heatmap_lot1_lot2.png                 # 停損參數熱力圖
```

### 關鍵指標

#### 🎯 主要優化目標
- **max_drawdown**: 最大回撤 (越接近0越好)
- **risk_adjusted_return**: 風險調整收益 (總收益/|MDD|)

#### 📈 輔助指標
- **total_pnl**: 總損益
- **win_rate**: 勝率
- **lot1_pnl, lot2_pnl, lot3_pnl**: 各口損益

### 結果解讀範例

```
🏆 MDD最小 TOP 10:
 1. MDD:   -15.20 | 總P&L:  245.60 | L1SL:15 L2SL:25 L3SL:35 | TP: 80 | 10:30-10:31
 2. MDD:   -18.40 | 總P&L:  198.30 | L1SL:10 L2SL:30 L3SL:40 | TP: 70 | 10:30-10:31
 3. MDD:   -22.10 | 總P&L:  312.80 | L1SL:20 L2SL:35 L3SL:45 | TP: 90 | 11:30-11:31
```

**解讀說明**:
- **MDD: -15.20**: 最大回撤15.20點 (風險較小)
- **L1SL:15 L2SL:25 L3SL:35**: 三口停損分別為15、25、35點
- **TP: 80**: 停利目標80點
- **10:30-10:31**: 最佳時間區間

## 🔍 高級分析

### 1. 風險調整收益分析
```
💎 風險調整收益 TOP 10 (總收益/|MDD|):
 1. 風險調整收益: 16.15 | MDD:  -15.20 | 總P&L:  245.60 | L1SL:15 L2SL:25 L3SL:35
```

**說明**: 風險調整收益越高，表示在相同風險下獲得更高收益

### 2. 參數模式分析

#### 🎯 最佳停損模式
- **遞增停損**: L1 < L2 < L3 (風險分散)
- **緊密停損**: 三口停損差距較小 (集中風險)
- **寬鬆停損**: 三口停損差距較大 (階梯風險)

#### ⏰ 最佳時間區間
- **早盤優勢**: 10:30-10:31 通常表現最佳
- **震盪適應**: 11:30-11:31 適合震盪策略
- **午後謹慎**: 12:30-12:31 需要更保守設定

## 🛠️ 自定義設定

### 修改參數範圍
編輯 `mdd_optimizer.py` 中的參數設定:

```python
# 停損點數範圍 (每口獨立)
self.stop_loss_ranges = {
    'lot1': range(5, 26, 5),     # 第1口: 5-25點
    'lot2': range(15, 41, 5),    # 第2口: 15-40點  
    'lot3': range(25, 56, 5)     # 第3口: 25-55點
}

# 停利點數範圍
self.take_profit_range = range(40, 121, 20)  # 40-120點，步長20
```

### 添加約束條件
```python
# 確保停損遞增且差距合理
if lot1_sl <= lot2_sl <= lot3_sl and (lot3_sl - lot1_sl) <= 30:
    # 添加到實驗組合
```

## 🎯 實戰應用建議

### 1. 保守型策略
- **目標**: MDD < -20點
- **特徵**: 較小停損差距，中等停利目標
- **適用**: 風險厭惡投資者

### 2. 平衡型策略  
- **目標**: 風險調整收益 > 10
- **特徵**: 適中的停損設定，合理的停利目標
- **適用**: 大多數投資者

### 3. 積極型策略
- **目標**: 總收益最大化，MDD可接受
- **特徵**: 較大停損差距，高停利目標
- **適用**: 風險承受能力強的投資者

## 🔧 故障排除

### 常見問題

#### 1. 執行緩慢
```bash
# 使用更多進程
python mdd_optimizer.py --max-workers 6

# 或先用小樣本測試
python mdd_optimizer.py --sample-size 100
```

#### 2. 記憶體不足
```bash
# 減少並行進程數
python mdd_optimizer.py --max-workers 1
```

#### 3. 結果異常
```bash
# 檢查系統測試
python test_mdd_optimizer.py

# 查看詳細日誌
tail -f results/mdd_optimization.log
```

## 📈 後續擴展

### 1. 真實數據整合
- 替換模擬引擎為真實歷史數據回測
- 整合現有的反轉策略回測系統

### 2. 更多優化目標
- 夏普比率最大化
- 最大連續虧損最小化
- 收益穩定性優化

### 3. 機器學習整合
- 使用遺傳算法優化參數
- 貝葉斯優化加速搜索
- 強化學習動態調整

---

## 🎊 總結

MDD最小化參數優化系統為您提供了一個強大的工具來尋找**風險最小**的交易參數組合。通過系統性地測試三口獨立停損設定，您可以找到最適合您風險偏好的策略配置。

**記住**: 最小的回撤不一定意味著最高的收益，但它能幫您在市場波動中保持更穩定的表現！

🎯 **開始您的MDD優化之旅吧！**
