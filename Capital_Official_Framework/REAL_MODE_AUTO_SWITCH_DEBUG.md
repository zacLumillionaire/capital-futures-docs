# 🔍 **實單模式自動切換調試說明**

## 📊 **當前狀況分析**

根據您的日誌，系統已經：
- ✅ API登入成功：`🔧 [Global] SetID called: E123354882`
- ✅ 下單模組初始化：`📋 [INIT] SKOrderLib初始化: SK_SUCCESS`
- ✅ 開始接收報價數據
- ❌ **沒有看到自動切換實單模式的日誌**

## 🎯 **預期的自動切換時機**

自動切換應該在**OnConnect事件**觸發時執行，您應該會看到：
```
[DEBUG] OnConnect觸發: UserID=E123354882, ErrorCode=0
[API_CONNECT] 🚀 API連線成功，已自動切換到實單模式
```

## 🔧 **可能的原因**

### **原因1：OnConnect事件未觸發**
- 某些API連線方式可能不會觸發OnConnect事件
- 或者事件處理器沒有正確註冊

### **原因2：虛實單管理器狀態問題**
- 虛實單管理器可能已經是實單模式
- 或者虛實單管理器未正確初始化

### **原因3：事件處理順序問題**
- OnConnect事件可能在虛實單管理器初始化之前觸發

## 🛠️ **調試和解決方案**

### **方案1：手動檢查模式**
我已經添加了一個**檢查實單模式**按鈕到GUI中：

1. 在系統狀態監控頁面找到 `🔍 檢查實單模式` 按鈕
2. 點擊按鈕查看當前模式狀態
3. 如果是虛擬模式，會自動嘗試切換到實單模式

### **方案2：查看調試日誌**
下次啟動系統時，注意查看是否有以下調試日誌：
```
[DEBUG] OnConnect觸發: UserID=..., ErrorCode=...
[DEBUG] 檢查虛實單管理器: True/False
[DEBUG] 當前模式: True/False (True=實單, False=虛擬)
```

### **方案3：手動調用檢查方法**
您也可以在Console中手動調用：
```python
# 在系統運行時執行
self.check_and_switch_to_real_mode()
```

## 📋 **檢查步驟**

### **步驟1：確認當前模式**
點擊 `🔍 檢查實單模式` 按鈕，查看輸出：
- `當前模式: 實單` → 已經是實單模式
- `當前模式: 虛擬` → 需要切換

### **步驟2：確認切換結果**
如果是虛擬模式，系統會自動嘗試切換：
- `🚀 已成功切換到實單模式` → 切換成功
- `⚠️ 實單模式切換失敗` → 需要檢查API狀態

### **步驟3：驗證功能**
切換成功後，可以測試：
- 建倉功能是否使用實單
- 停損平倉是否使用實單

## 🎯 **最可能的情況**

根據您的系統狀態，最可能的情況是：

1. **系統已經是實單模式**：
   - 虛實單管理器預設已設為實單模式
   - OnConnect事件檢測到已經是實單模式，所以顯示 `✅ 實單模式已啟用`
   - 但這個日誌可能沒有顯示出來

2. **OnConnect事件沒有觸發**：
   - 某些連線方式不會觸發OnConnect事件
   - 需要手動檢查和切換

## 💡 **建議操作**

1. **立即檢查**：點擊 `🔍 檢查實單模式` 按鈕
2. **確認狀態**：查看當前是實單還是虛擬模式
3. **測試功能**：如果是實單模式，可以測試建倉功能
4. **回報結果**：告訴我檢查的結果

## 🔍 **調試信息收集**

下次啟動時，請注意收集以下信息：
1. 是否看到 `[DEBUG] OnConnect觸發` 日誌
2. 是否看到 `[API_CONNECT]` 相關日誌
3. 點擊檢查按鈕後的輸出結果

這樣我們就能確定自動切換機制是否正常工作，或者需要進一步調整。
