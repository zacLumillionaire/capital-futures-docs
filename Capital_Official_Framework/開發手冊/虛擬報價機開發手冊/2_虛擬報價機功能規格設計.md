# è™›æ“¬å ±åƒ¹æ©ŸåŠŸèƒ½è¦æ ¼è¨­è¨ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æª”è¨­è¨ˆè™›æ“¬å ±åƒ¹æ©Ÿçš„æ ¸å¿ƒåŠŸèƒ½è¦æ ¼ï¼Œç›®æ¨™æ˜¯æ›¿ä»£ç¾¤ç›ŠAPIç‚ºsimple_integrated.pyæä¾›æ¸¬è©¦ç’°å¢ƒã€‚

## ğŸ¯ 1. è¨­è¨ˆç›®æ¨™

### 1.1 ä¸»è¦ç›®æ¨™
- **å®Œå…¨æ›¿ä»£ç¾¤ç›ŠAPI**: è®“simple_integrated.pyç„¡éœ€ä¿®æ”¹å³å¯é‹è¡Œ
- **ç©©å®šå ±åƒ¹æ¨é€**: æ¯0.5ç§’æä¾›ç©©å®šçš„å ±åƒ¹æ•¸æ“š
- **ç°¡åŒ–æˆäº¤æ¨¡æ“¬**: æä¾›åŸºæœ¬çš„ä¸‹å–®æˆäº¤å›å ±
- **æ¸¬è©¦ç’°å¢ƒéš”é›¢**: é¿å…å½±éŸ¿çœŸå¯¦äº¤æ˜“ç’°å¢ƒ

### 1.2 è¨­è¨ˆåŸå‰‡
- **æœ€å°åŒ–ä¿®æ”¹**: simple_integrated.pyæ”¹å‹•è¶Šå°‘è¶Šå¥½
- **åŠŸèƒ½å°å‘**: é‡é»å¯¦ç¾æ ¸å¿ƒåŠŸèƒ½ï¼Œç°¡åŒ–éå¿…è¦åŠŸèƒ½
- **ç©©å®šå„ªå…ˆ**: ç¢ºä¿å ±åƒ¹æ¨é€å’Œå›å ±è™•ç†çš„ç©©å®šæ€§
- **æ˜“æ–¼èª¿è©¦**: æä¾›æ¸…æ™°çš„æ—¥èªŒå’Œç‹€æ…‹ç›£æ§

## ğŸ—ï¸ 2. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 2.1 æ•´é«”æ¶æ§‹
```
è™›æ“¬å ±åƒ¹æ©Ÿ (Virtual Quote Machine)
â”œâ”€â”€ å ±åƒ¹ç”Ÿæˆå™¨ (Quote Generator)
â”‚   â”œâ”€â”€ åƒ¹æ ¼æ¨¡æ“¬å¼•æ“
â”‚   â”œâ”€â”€ äº”æª”æ•¸æ“šç”Ÿæˆ
â”‚   â””â”€â”€ æ™‚é–“æˆ³ç®¡ç†
â”œâ”€â”€ APIæ¨¡æ“¬å™¨ (API Simulator)
â”‚   â”œâ”€â”€ SKQuoteLibæ¨¡æ“¬
â”‚   â”œâ”€â”€ SKOrderLibæ¨¡æ“¬
â”‚   â”œâ”€â”€ SKReplyLibæ¨¡æ“¬
â”‚   â””â”€â”€ SKCenterLibæ¨¡æ“¬
â”œâ”€â”€ äº‹ä»¶åˆ†ç™¼å™¨ (Event Dispatcher)
â”‚   â”œâ”€â”€ å ±åƒ¹äº‹ä»¶æ¨é€
â”‚   â”œâ”€â”€ å›å ±äº‹ä»¶æ¨é€
â”‚   â””â”€â”€ é€£ç·šäº‹ä»¶ç®¡ç†
â””â”€â”€ é…ç½®ç®¡ç†å™¨ (Config Manager)
    â”œâ”€â”€ å ±åƒ¹åƒæ•¸è¨­å®š
    â”œâ”€â”€ æˆäº¤è¦å‰‡è¨­å®š
    â””â”€â”€ æ™‚é–“æ§åˆ¶è¨­å®š
```

### 2.2 æ¨¡çµ„è·è²¬

#### **å ±åƒ¹ç”Ÿæˆå™¨ (Quote Generator)**
- ç”Ÿæˆæ¨¡æ“¬çš„å°æŒ‡æœŸè²¨åƒ¹æ ¼æ•¸æ“š
- ç¶­è­·è²·è³£ä¸€åƒ¹å’Œäº”æª”æ·±åº¦
- æ§åˆ¶å ±åƒ¹æ¨é€é »ç‡ (0.5ç§’)
- æ¨¡æ“¬çœŸå¯¦å¸‚å ´æ³¢å‹•

#### **APIæ¨¡æ“¬å™¨ (API Simulator)**
- æä¾›èˆ‡ç¾¤ç›ŠAPIç›¸åŒçš„ä»‹é¢
- è™•ç†ä¸‹å–®è«‹æ±‚ä¸¦ç”Ÿæˆå›å ±
- æ¨¡æ“¬é€£ç·šç‹€æ…‹ç®¡ç†
- è¿”å›æ¨™æº–çš„APIå›æ‡‰æ ¼å¼

#### **äº‹ä»¶åˆ†ç™¼å™¨ (Event Dispatcher)**
- æ¨é€å ±åƒ¹äº‹ä»¶åˆ°ä¸‹å–®æ©Ÿ
- æ¨é€å§”è¨—å›å ±äº‹ä»¶
- ç®¡ç†äº‹ä»¶è™•ç†å™¨è¨»å†Š
- ç¢ºä¿äº‹ä»¶æ¨é€çš„æ™‚åºæ­£ç¢º

## ğŸ“Š 3. æ ¸å¿ƒåŠŸèƒ½è¦æ ¼

### 3.1 å ±åƒ¹æ¨é€åŠŸèƒ½

#### **åŸºæœ¬å ±åƒ¹æ•¸æ“š**
```python
class QuoteData:
    def __init__(self):
        self.market_no = 1          # å¸‚å ´ä»£è™Ÿ
        self.stock_idx = 0          # å•†å“ç´¢å¼•
        self.date = 20250113        # æ—¥æœŸ (YYYYMMDD)
        self.time_hms = 134500      # æ™‚é–“ (HHMMSS)
        self.time_ms = 500          # æ¯«ç§’
        self.bid_price = 21490      # è²·ä¸€åƒ¹ (*100)
        self.ask_price = 21500      # è³£ä¸€åƒ¹ (*100)
        self.close_price = 21495    # æˆäº¤åƒ¹ (*100)
        self.quantity = 1           # æˆäº¤é‡
        self.simulate = 0           # æ¨¡æ“¬æ¨™è¨˜
```

#### **å ±åƒ¹ç”Ÿæˆç­–ç•¥**
- **åŸºæº–åƒ¹æ ¼**: 21500é» (å¯é…ç½®)
- **æ³¢å‹•ç¯„åœ**: Â±50é»éš¨æ©Ÿæ³¢å‹•
- **è²·è³£åƒ¹å·®**: å›ºå®š5é»åƒ¹å·® (è³£ä¸€ = è²·ä¸€ + 5)
- **æ›´æ–°é »ç‡**: æ¯500æ¯«ç§’æ¨é€ä¸€æ¬¡
- **æ™‚é–“åŒæ­¥**: ä½¿ç”¨ç³»çµ±æ™‚é–“ç”Ÿæˆæ™‚é–“æˆ³

#### **äº”æª”æ•¸æ“šç”Ÿæˆ**
```python
class Best5Data:
    def __init__(self):
        # è²·æ–¹äº”æª” (ç”±é«˜åˆ°ä½)
        self.bid_prices = [21490, 21485, 21480, 21475, 21470]
        self.bid_qtys = [10, 15, 20, 25, 30]
        
        # è³£æ–¹äº”æª” (ç”±ä½åˆ°é«˜)  
        self.ask_prices = [21495, 21500, 21505, 21510, 21515]
        self.ask_qtys = [12, 18, 22, 28, 32]
```

### 3.2 ä¸‹å–®è™•ç†åŠŸèƒ½

#### **ä¸‹å–®è«‹æ±‚è™•ç†**
```python
def SendFutureOrderCLR(self, user_id, async_flag, order_obj):
    """æ¨¡æ“¬æœŸè²¨ä¸‹å–®API"""
    
    # 1. è§£æä¸‹å–®åƒæ•¸
    account = order_obj.bstrFullAccount
    product = order_obj.bstrStockNo
    buy_sell = order_obj.sBuySell
    price = int(order_obj.bstrPrice)
    quantity = order_obj.nQty
    
    # 2. ç”Ÿæˆå§”è¨—åºè™Ÿ
    order_id = f"VQ{int(time.time() * 1000) % 100000000}"
    
    # 3. ç«‹å³è¿”å›ä¸‹å–®çµæœ
    return (order_id, 0)  # (å§”è¨—åºè™Ÿ, æˆåŠŸä»£ç¢¼)
```

#### **æˆäº¤æ¨¡æ“¬è¦å‰‡**
- **FOKå–®è™•ç†**: ç«‹å³å…¨éƒ¨æˆäº¤æˆ–å…¨éƒ¨å–æ¶ˆ
- **æˆäº¤åƒ¹æ ¼**: ä½¿ç”¨ç•¶å‰è²·ä¸€/è³£ä¸€åƒ¹æ ¼
- **æˆäº¤æ™‚é–“**: ä¸‹å–®å¾Œ100-300æ¯«ç§’å…§æˆäº¤
- **æˆäº¤æ©Ÿç‡**: 95%æˆäº¤ç‡ (æ¨¡æ“¬å¶ç™¼çš„æœªæˆäº¤)

### 3.3 å›å ±æ¨é€åŠŸèƒ½

#### **å§”è¨—å›å ±æ ¼å¼**
```python
def generate_order_reply(self, order_id, status, fill_price=0, fill_qty=0):
    """ç”Ÿæˆå§”è¨—å›å ±æ•¸æ“š"""
    
    reply_data = [
        order_id,                    # [0] å§”è¨—åºè™Ÿ
        "F0200006363839",           # [1] å¸³è™Ÿ
        "MTX00",                    # [2] å•†å“ä»£ç¢¼
        "0",                        # [3] è²·è³£åˆ¥ (0=è²·, 1=è³£)
        "21500",                    # [4] å§”è¨—åƒ¹æ ¼
        "1",                        # [5] å§”è¨—æ•¸é‡
        str(fill_price),            # [6] æˆäº¤åƒ¹æ ¼
        str(fill_qty),              # [7] æˆäº¤æ•¸é‡
        status,                     # [8] å§”è¨—ç‹€æ…‹ (N=æ–°å–®, D=æˆäº¤)
        "134500",                   # [9] å§”è¨—æ™‚é–“
        # ... å…¶ä»–æ¬„ä½
    ]
    
    return ",".join(reply_data)
```

#### **å›å ±æ¨é€æ™‚åº**
1. **æ–°å–®å›å ±**: ä¸‹å–®å¾Œ50æ¯«ç§’å…§æ¨é€
2. **æˆäº¤å›å ±**: æ–°å–®å¾Œ100-200æ¯«ç§’å…§æ¨é€
3. **ç‹€æ…‹æ›´æ–°**: ç¢ºä¿å›å ±é †åºæ­£ç¢º

### 3.4 é€£ç·šç‹€æ…‹ç®¡ç†

#### **é€£ç·šäº‹ä»¶æ¨¡æ“¬**
```python
class ConnectionManager:
    def __init__(self):
        self.is_connected = False
        self.connection_handlers = []
    
    def simulate_connect(self):
        """æ¨¡æ“¬é€£ç·šæˆåŠŸ"""
        self.is_connected = True
        for handler in self.connection_handlers:
            handler.OnConnect("test_user", 0)  # æˆåŠŸä»£ç¢¼
    
    def simulate_disconnect(self):
        """æ¨¡æ“¬æ–·ç·š"""
        self.is_connected = False
        for handler in self.connection_handlers:
            handler.OnDisconnect("test_user", 3002)  # æ–·ç·šä»£ç¢¼
```

## âš™ï¸ 4. æŠ€è¡“å¯¦ç¾è¦æ ¼

### 4.1 å¤šç·šç¨‹è¨­è¨ˆ
- **å ±åƒ¹ç·šç¨‹**: ç¨ç«‹ç·šç¨‹è² è²¬å ±åƒ¹ç”Ÿæˆå’Œæ¨é€
- **å›å ±ç·šç¨‹**: ç¨ç«‹ç·šç¨‹è™•ç†ä¸‹å–®å›å ±
- **ä¸»ç·šç¨‹**: è™•ç†APIèª¿ç”¨å’Œäº‹ä»¶è¨»å†Š
- **ç·šç¨‹åŒæ­¥**: ä½¿ç”¨Queueç¢ºä¿ç·šç¨‹å®‰å…¨

### 4.2 äº‹ä»¶è™•ç†æ©Ÿåˆ¶
```python
class EventHandler:
    def __init__(self):
        self.quote_handlers = []    # å ±åƒ¹äº‹ä»¶è™•ç†å™¨
        self.reply_handlers = []    # å›å ±äº‹ä»¶è™•ç†å™¨
    
    def register_quote_handler(self, handler):
        """è¨»å†Šå ±åƒ¹äº‹ä»¶è™•ç†å™¨"""
        self.quote_handlers.append(handler)
    
    def dispatch_quote_event(self, quote_data):
        """åˆ†ç™¼å ±åƒ¹äº‹ä»¶"""
        for handler in self.quote_handlers:
            handler.OnNotifyTicksLONG(*quote_data.to_params())
```

### 4.3 é…ç½®ç®¡ç†
```python
class VirtualQuoteConfig:
    def __init__(self):
        self.base_price = 21500         # åŸºæº–åƒ¹æ ¼
        self.price_range = 50           # æ³¢å‹•ç¯„åœ
        self.spread = 5                 # è²·è³£åƒ¹å·®
        self.quote_interval = 0.5       # å ±åƒ¹é–“éš”(ç§’)
        self.fill_probability = 0.95    # æˆäº¤æ©Ÿç‡
        self.fill_delay_ms = 200        # æˆäº¤å»¶é²(æ¯«ç§’)
```

## ğŸ”§ 5. ä»‹é¢å…¼å®¹æ€§

### 5.1 APIä»‹é¢ä¿æŒ
- **å‡½æ•¸åç¨±**: èˆ‡ç¾¤ç›ŠAPIå®Œå…¨ç›¸åŒ
- **åƒæ•¸æ ¼å¼**: ä¿æŒåŸæœ‰åƒæ•¸çµæ§‹
- **è¿”å›å€¼**: ç¶­æŒåŸæœ‰è¿”å›æ ¼å¼
- **äº‹ä»¶ç°½å**: äº‹ä»¶è™•ç†å™¨ç°½åä¸è®Š

### 5.2 Globalæ¨¡çµ„æ›¿æ›
```python
# åŸæœ‰Globalæ¨¡çµ„å°å…¥
import order_service.Global as Global

# æ›¿æ›ç‚ºè™›æ“¬å ±åƒ¹æ©Ÿ
import virtual_quote_machine.Global as Global
```

## ğŸ“ˆ 6. æ€§èƒ½è¦æ±‚

### 6.1 éŸ¿æ‡‰æ™‚é–“
- **å ±åƒ¹å»¶é²**: < 10æ¯«ç§’
- **ä¸‹å–®éŸ¿æ‡‰**: < 50æ¯«ç§’  
- **å›å ±æ¨é€**: < 200æ¯«ç§’

### 6.2 ç©©å®šæ€§è¦æ±‚
- **é€£çºŒé‹è¡Œ**: æ”¯æŒ8å°æ™‚é€£çºŒé‹è¡Œ
- **è¨˜æ†¶é«”ä½¿ç”¨**: < 100MB
- **CPUä½¿ç”¨**: < 5%

---
*è¨­è¨ˆç‰ˆæœ¬: v1.0*  
*æœ€å¾Œæ›´æ–°: 2025-01-13*
