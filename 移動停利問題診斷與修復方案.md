# 移動停利問題診斷與修復方案

## 🎯 問題根本原因確認

通過全流程診斷，我發現了移動停利平倉機制失效的**根本原因**：

### 📋 關鍵問題

1. **❌ 移動停利參數未設置**
   - 部位創建時 `trailing_activation_points` 為 `None`
   - 部位確認成交時沒有設置移動停利參數
   - 導致移動停利啟動條件檢查失敗

2. **❌ 資料庫結構不一致**
   - `risk_management_states` 表缺少 `current_price` 欄位
   - 診斷工具查詢失敗

3. **❌ 移動停利啟動狀態不同步**
   - 日誌顯示移動停利已啟動，但資料庫記錄為 `trailing_activated = 0`
   - 風險引擎計數器顯示 `移停:0/2`

---

## 🔍 詳細分析

### 問題1: 部位創建時缺少移動停利參數

**位置**: `multi_group_database.py` 第368-374行

**當前代碼**:
```python
cursor.execute('''
    INSERT INTO position_records
    (group_id, lot_id, direction, entry_price, entry_time, rule_config,
     order_id, api_seq_no, order_status)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
''', (group_id, lot_id, direction, entry_price, entry_time, rule_config,
      order_id, api_seq_no, order_status))
```

**問題**: 缺少移動停利相關字段的設置：
- `trailing_activation_points`
- `trailing_pullback_ratio`
- `trailing_activated`

### 問題2: 部位確認成交時未設置移動停利參數

**位置**: `multi_group_database.py` 第725-730行

**當前代碼**:
```python
cursor.execute('''
    UPDATE position_records
    SET entry_price = ?, entry_time = ?, status = 'ACTIVE',
        order_status = ?, updated_at = CURRENT_TIMESTAMP
    WHERE id = ?
''', (actual_fill_price, fill_time, order_status, position_id))
```

**問題**: 確認成交時沒有設置移動停利參數

### 問題3: 移動停利配置獲取邏輯

**位置**: `multi_group_position_manager.py` 第1034-1058行

**現有邏輯**:
```python
def _get_group_trailing_config(self, group_id: int, lot_id: int) -> dict:
    if lot_id == 1:
        return {'activation_points': 15.0, 'pullback_percent': 0.2}
    elif lot_id == 2:
        return {'activation_points': 40.0, 'pullback_percent': 0.2}
    elif lot_id == 3:
        return {'activation_points': 65.0, 'pullback_percent': 0.2}
```

**問題**: 配置邏輯存在但沒有在部位創建時應用

---

## 🛠️ 修復方案

### 修復1: 更新部位創建邏輯

**文件**: `multi_group_database.py`

**修改 `create_position_record` 方法**:
```python
def create_position_record(self, group_id: int, lot_id: int, direction: str,
                         entry_price: Optional[float] = None, entry_time: Optional[str] = None,
                         rule_config: Optional[str] = None, order_id: Optional[str] = None,
                         api_seq_no: Optional[str] = None, order_status: str = 'PENDING',
                         trailing_activation_points: Optional[float] = None,
                         trailing_pullback_ratio: float = 0.2) -> int:
    """創建部位記錄 - 支援移動停利參數設置"""
    
    # 如果沒有提供移動停利參數，使用預設配置
    if trailing_activation_points is None:
        trailing_config = self._get_default_trailing_config(lot_id)
        trailing_activation_points = trailing_config['activation_points']
        trailing_pullback_ratio = trailing_config['pullback_ratio']
    
    cursor.execute('''
        INSERT INTO position_records
        (group_id, lot_id, direction, entry_price, entry_time, rule_config,
         order_id, api_seq_no, order_status, trailing_activation_points, 
         trailing_pullback_ratio, trailing_activated)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (group_id, lot_id, direction, entry_price, entry_time, rule_config,
          order_id, api_seq_no, order_status, trailing_activation_points,
          trailing_pullback_ratio, False))
```

### 修復2: 添加預設配置方法

**文件**: `multi_group_database.py`

**新增方法**:
```python
def _get_default_trailing_config(self, lot_id: int) -> dict:
    """獲取預設移動停利配置"""
    if lot_id == 1:
        return {'activation_points': 15.0, 'pullback_ratio': 0.2}
    elif lot_id == 2:
        return {'activation_points': 40.0, 'pullback_ratio': 0.2}
    elif lot_id == 3:
        return {'activation_points': 65.0, 'pullback_ratio': 0.2}
    else:
        return {'activation_points': 15.0, 'pullback_ratio': 0.2}
```

### 修復3: 更新部位管理器調用

**文件**: `multi_group_position_manager.py`

**修改第209-216行**:
```python
# 獲取移動停利配置
trailing_config = self._get_group_trailing_config(group_info['group_id'], lot_rule.lot_id)

position_id = self.db_manager.create_position_record(
    group_id=group_info['group_id'],
    lot_id=lot_rule.lot_id,
    direction=group_info['direction'],
    entry_time=actual_time,
    rule_config=lot_rule.to_json(),
    order_status='PENDING',
    trailing_activation_points=trailing_config['activation_points'],
    trailing_pullback_ratio=trailing_config['pullback_percent']
)
```

### 修復4: 修復現有部位的移動停利參數

**創建修復腳本**:
```python
def fix_existing_positions():
    """修復現有部位的移動停利參數"""
    with sqlite3.connect("multi_group_strategy.db") as conn:
        cursor = conn.cursor()
        
        # 獲取所有缺少移動停利參數的活躍部位
        cursor.execute("""
            SELECT id, lot_id FROM position_records 
            WHERE status = 'ACTIVE' AND trailing_activation_points IS NULL
        """)
        
        positions = cursor.fetchall()
        
        for pos_id, lot_id in positions:
            # 設置預設移動停利參數
            if lot_id == 1:
                activation_points = 15.0
            elif lot_id == 2:
                activation_points = 40.0
            elif lot_id == 3:
                activation_points = 65.0
            else:
                activation_points = 15.0
            
            cursor.execute("""
                UPDATE position_records 
                SET trailing_activation_points = ?, 
                    trailing_pullback_ratio = 0.2
                WHERE id = ?
            """, (activation_points, pos_id))
        
        conn.commit()
        print(f"修復了 {len(positions)} 個部位的移動停利參數")
```

---

## 🧪 驗證步驟

### 1. 立即修復現有部位
```bash
cd Capital_Official_Framework
python 修復現有部位移動停利參數.py
```

### 2. 驗證修復效果
```bash
python 移動停利平倉診斷工具.py
```

### 3. 測試新建倉流程
- 重啟交易系統
- 執行新的建倉操作
- 確認移動停利參數正確設置

---

## 📊 預期修復效果

### 修復前
```
部位 1: trailing_activation_points=None, trailing_activated=0
部位 2: trailing_activation_points=None, trailing_activated=0
[RISK_ENGINE] 移停:0/2
```

### 修復後
```
部位 1: trailing_activation_points=15.0, trailing_activated=1 (當獲利>=15點)
部位 2: trailing_activation_points=40.0, trailing_activated=1 (當獲利>=40點)
[RISK_ENGINE] 移停:2/2
```

---

## 🎯 優先級

### 🔴 立即執行 (Critical)
1. **修復現有部位參數** - 讓當前部位能正常啟動移動停利
2. **更新部位創建邏輯** - 確保新部位有正確的移動停利參數

### 🟡 後續優化 (Important)
1. **完善資料庫結構** - 添加缺少的欄位
2. **改進診斷工具** - 修復查詢錯誤
3. **加強測試覆蓋** - 防止類似問題再次發生

---

## 📝 總結

**根本原因**: 部位創建時沒有設置移動停利參數，導致啟動條件檢查失敗。

**解決方案**: 
1. 立即修復現有部位的移動停利參數
2. 更新部位創建邏輯，確保新部位有正確的參數設置
3. 完善移動停利配置的應用邏輯

**預期效果**: 修復後，移動停利機制將正常工作，第二口部位在獲利40點時啟動移動停利，並在觸發平倉條件時正確執行平倉。
