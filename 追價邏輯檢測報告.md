# è¿½åƒ¹é‚è¼¯æª¢æ¸¬å ±å‘Š

## ğŸ” å•é¡Œåˆ†æ

æ ¹æ“šæ‚¨æä¾›çš„æ—¥èªŒè¨˜éŒ„ï¼Œç™¼ç¾äº†ä¸€å€‹åš´é‡çš„è¿½åƒ¹é‚è¼¯éŒ¯èª¤ï¼š

### å•é¡Œç¾è±¡
```
INFO:multi_group_position_manager.MultiGroupPositionManager:ğŸ” [è¿½åƒ¹] ç²å–çµ„6ä¿¡æ¯: SHORT @22363.0-22368.0
INFO:multi_group_position_manager.MultiGroupPositionManager:ğŸ”„ [è¿½åƒ¹] SHORTè¿½åƒ¹è¨ˆç®—: BID1(22654.0) - 1 = 22653.0
INFO:multi_group_position_manager.MultiGroupPositionManager:ğŸ”„ [ç°¡åŒ–è¿½è¹¤] çµ„6è¿½åƒ¹åƒæ•¸: SHORT 1å£ @22653.0 (ç¬¬1æ¬¡)
[ORDER_MGR] âš¡ å¯¦éš›ä¸‹å–®: SELL TM0000 1å£ @22653 APIçµæœ:('4020', 0)
```

**éŒ¯èª¤åˆ†æ**ï¼š
- çµ„6çš„ä¿¡æ¯é¡¯ç¤ºç‚º `SHORT @22363.0-22368.0`ï¼Œé€™è¡¨ç¤ºé€™æ˜¯ä¸€å€‹**ç©ºå–®ç­–ç•¥çµ„**
- ä½†æ˜¯è¿½åƒ¹è¨ˆç®—ä½¿ç”¨äº† `SHORTè¿½åƒ¹è¨ˆç®—: BID1(22654.0) - 1 = 22653.0`
- æœ€çµ‚ä¸‹å–®æ˜¯ `SELL TM0000 1å£ @22653`ï¼Œé€™æ˜¯**è³£å‡ºæ“ä½œ**

**å•é¡Œæ ¸å¿ƒ**ï¼šç©ºå–®ç­–ç•¥çµ„åœ¨è¿½åƒ¹æ™‚ï¼Œæ‡‰è©²æ˜¯**è²·å›å¹³å€‰**æˆ–**ç¹¼çºŒåšç©º**ï¼Œä½†ç³»çµ±éŒ¯èª¤åœ°åŸ·è¡Œäº†**è³£å‡º**æ“ä½œã€‚

## ğŸ”§ ä»£ç¢¼æª¢æ¸¬çµæœ

### 1. MultiGroupPositionManager è¿½åƒ¹é‚è¼¯

**æ–‡ä»¶**: `multi_group_position_manager.py` ç¬¬1031-1040è¡Œ

<augment_code_snippet path="Capital_Official_Framework/multi_group_position_manager.py" mode="EXCERPT">
````python
if direction == "LONG":
    # ğŸ”§ ä¿®å¾©ï¼šå¤šå–®ä½¿ç”¨ASK1+è¿½åƒ¹é»æ•¸ (å‘ä¸Šè¿½åƒ¹)
    retry_price = current_ask1 + retry_count
    self.logger.info(f"ğŸ”„ [è¿½åƒ¹] LONGè¿½åƒ¹è¨ˆç®—: ASK1({current_ask1}) + {retry_count} = {retry_price}")
    return retry_price
elif direction == "SHORT":
    # ğŸ”§ ä¿®å¾©ï¼šç©ºå–®ä½¿ç”¨BID1-è¿½åƒ¹é»æ•¸ (å‘ä¸‹è¿½åƒ¹ï¼Œæ›´å®¹æ˜“æˆäº¤)
    retry_price = current_bid1 - retry_count
    self.logger.info(f"ğŸ”„ [è¿½åƒ¹] SHORTè¿½åƒ¹è¨ˆç®—: BID1({current_bid1}) - {retry_count} = {retry_price}")
    return retry_price
````
</augment_code_snippet>

**æª¢æ¸¬çµæœ**: âœ… **è¿½åƒ¹åƒ¹æ ¼è¨ˆç®—é‚è¼¯æ­£ç¢º**
- LONG: ASK1 + retry_count (å‘ä¸Šè¿½åƒ¹ï¼Œè²·å…¥æ›´å®¹æ˜“æˆäº¤)
- SHORT: BID1 - retry_count (å‘ä¸‹è¿½åƒ¹ï¼Œè³£å‡ºæ›´å®¹æ˜“æˆäº¤)

### 2. è¿½åƒ¹åŸ·è¡Œé‚è¼¯

**æ–‡ä»¶**: `multi_group_position_manager.py` ç¬¬910-940è¡Œ

<augment_code_snippet path="Capital_Official_Framework/multi_group_position_manager.py" mode="EXCERPT">
````python
def _execute_group_retry(self, group_id: int, qty: int, price: float, retry_count: int):
    """åŸ·è¡Œçµ„è¿½åƒ¹é‡è©¦"""
    try:
        self.logger.info(f"ğŸ”„ [ç°¡åŒ–è¿½è¹¤] çµ„{group_id}è§¸ç™¼è¿½åƒ¹é‡è©¦: "
                       f"{qty}å£ @{price}, ç¬¬{retry_count}æ¬¡")

        # ğŸ”§ å¯¦éš›è¿½åƒ¹ä¸‹å–®é‚è¼¯
        # 1. ç²å–çµ„çš„åŸºæœ¬ä¿¡æ¯
        group_info = self._get_group_info_by_id(group_id)
        if not group_info:
            self.logger.error(f"æ‰¾ä¸åˆ°çµ„{group_id}çš„ä¿¡æ¯")
            return

        direction = group_info.get('direction')
        # ğŸ”§ ä¿®å¾©ï¼šå•†å“ä»£ç¢¼å¾é…ç½®æˆ–é è¨­å€¼ç²å–
        product = getattr(self, 'current_product', 'TM0000')

        # 2. è¨ˆç®—è¿½åƒ¹åƒ¹æ ¼
        retry_price = self._calculate_retry_price_for_group(direction, retry_count)
````
</augment_code_snippet>

**æª¢æ¸¬çµæœ**: âš ï¸ **æ–¹å‘åˆ¤æ–·é‚è¼¯å­˜åœ¨å•é¡Œ**

### 3. ä¸‹å–®åŸ·è¡Œé‚è¼¯

**é—œéµå•é¡Œ**: åœ¨ `_execute_group_retry` æ–¹æ³•ä¸­ï¼Œç³»çµ±æ­£ç¢ºç²å–äº† `direction = "SHORT"`ï¼Œä½†åœ¨å¯¦éš›ä¸‹å–®æ™‚ï¼Œå¯èƒ½å­˜åœ¨æ–¹å‘è½‰æ›éŒ¯èª¤ã€‚

## ğŸš¨ æ ¹æœ¬åŸå› åˆ†æ

### å•é¡Œç¢ºèªï¼šæ•¸æ“šåº«æŸ¥è©¢éŒ¯èª¤

æ ¹æ“šå®Œæ•´æ—¥èªŒåˆ†æï¼Œç™¼ç¾äº†çœŸæ­£çš„å•é¡Œï¼š

**æ­£ç¢ºçš„æµç¨‹**ï¼š
1. **çªç ´ä¿¡è™Ÿ**: `LONGçªç ´ä¿¡è™Ÿå·²è§¸ç™¼` âœ…
2. **å‰µå»ºç­–ç•¥çµ„**: `å‰µå»ºç­–ç•¥çµ„: ID=34, çµ„åˆ¥=6, æ–¹å‘=LONG` âœ…
3. **é€²å ´ä¸‹å–®**: `BUY TM0000 1å£ @22655` (å…±3å£) âœ…
4. **æ”¶åˆ°å–æ¶ˆå›å ±**: ç¬¬ä¸€å£è¢«å–æ¶ˆ âœ…
5. **è¿½åƒ¹æŸ¥è©¢**: `ğŸ” [è¿½åƒ¹] ç²å–çµ„6ä¿¡æ¯: SHORT @22363.0-22368.0` âŒ

**éŒ¯èª¤æ ¹æº**ï¼š
- çµ„6æ˜æ˜æ˜¯ `LONG` ç­–ç•¥çµ„ï¼ˆDB_ID=34ï¼‰
- ä½†è¿½åƒ¹æ™‚æŸ¥è©¢è¿”å›äº† `SHORT` ä¿¡æ¯
- é€™å°è‡´è¿½åƒ¹è®Šæˆäº† `SELL` æ“ä½œ

### æ•¸æ“šåº«æŸ¥è©¢é‚è¼¯éŒ¯èª¤

**å•é¡Œä»£ç¢¼**ï¼š
```python
def get_strategy_group_info(self, group_id: int) -> Optional[Dict]:
    cursor.execute('''
        SELECT * FROM strategy_groups WHERE id = ?
    ''', (group_id,))
```

**éŒ¯èª¤åˆ†æ**ï¼š
- å‚³å…¥åƒæ•¸ï¼š`group_id = 6`ï¼ˆçµ„åˆ¥ç·¨è™Ÿï¼‰
- æŸ¥è©¢æ¢ä»¶ï¼š`WHERE id = 6`ï¼ˆä¸»éµIDï¼‰
- å¯¦éš›æ‡‰è©²ï¼š`WHERE group_id = 6`ï¼ˆçµ„åˆ¥ç·¨è™Ÿï¼‰

**çµæœ**ï¼š
- æŸ¥è©¢ `id = 6` å¯èƒ½è¿”å›äº†æ­·å²ä¸Šçš„å…¶ä»–çµ„ï¼ˆå¯èƒ½æ˜¯SHORTçµ„ï¼‰
- è€Œä¸æ˜¯ç•¶å‰çš„çµ„6ï¼ˆ`id = 34, group_id = 6, direction = LONG`ï¼‰

## ğŸ” é€²ä¸€æ­¥æª¢æ¸¬å»ºè­°

### æª¢æŸ¥é»1: ç¢ºèªç­–ç•¥çµ„çš„åŸå§‹æ–¹å‘

è«‹æª¢æŸ¥çµ„6çš„å‰µå»ºæ—¥èªŒï¼Œç¢ºèªï¼š
1. çµ„6æœ€åˆæ˜¯å¦‚ä½•å‰µå»ºçš„ï¼Ÿ
2. åŸå§‹ä¿¡è™Ÿæ˜¯LONGé‚„æ˜¯SHORTï¼Ÿ
3. æ˜¯å¦åœ¨æŸå€‹ç’°ç¯€ç™¼ç”Ÿäº†æ–¹å‘è½‰æ›ï¼Ÿ

### æª¢æŸ¥é»2: æª¢æŸ¥é€²å ´é‚è¼¯

**æ–‡ä»¶**: `simple_integrated.py` ç¬¬4771-4782è¡Œ

<augment_code_snippet path="Capital_Official_Framework/simple_integrated.py" mode="EXCERPT">
````python
if original_direction.upper() == "LONG":
    # ğŸ”§ å¤šå–®å¹³å€‰ï¼šä½¿ç”¨BID1 - retry_counté» (å‘ä¸‹è¿½åƒ¹)
    retry_price = current_bid1 - retry_count
    if self.console_enabled:
        print(f"[MAIN] ğŸ”„ å¤šå–®å¹³å€‰è¿½åƒ¹è¨ˆç®—: BID1({current_bid1}) - {retry_count} = {retry_price}")
    return retry_price
elif original_direction.upper() == "SHORT":
    # ğŸ”§ ç©ºå–®å¹³å€‰ï¼šä½¿ç”¨ASK1 + retry_counté» (å‘ä¸Šè¿½åƒ¹)
    retry_price = current_ask1 + retry_count
````
</augment_code_snippet>

**æ³¨æ„**: é€™æ˜¯**å¹³å€‰è¿½åƒ¹é‚è¼¯**ï¼Œèˆ‡é€²å ´è¿½åƒ¹ä¸åŒï¼

## ğŸ”§ ä¿®å¾©æ–¹æ¡ˆ

### âœ… å·²ä¿®å¾©ï¼šæ•¸æ“šåº«æŸ¥è©¢é‚è¼¯

**ä¿®å¾©æ–‡ä»¶**: `multi_group_database.py` ç¬¬499-516è¡Œ

```python
def get_strategy_group_info(self, group_id: int) -> Optional[Dict]:
    """å–å¾—ç­–ç•¥çµ„è³‡è¨Š - ğŸ”§ ä¿®å¾©ï¼šæ ¹æ“šgroup_idæŸ¥è©¢ï¼Œä¸æ˜¯ä¸»éµid"""
    try:
        with self.get_connection() as conn:
            cursor = conn.cursor()
            # ğŸ”§ ä¿®å¾©ï¼šæŸ¥è©¢æ¢ä»¶æ”¹ç‚º group_idï¼Œä¸¦é™åˆ¶ç‚ºä»Šæ—¥è¨˜éŒ„
            cursor.execute('''
                SELECT * FROM strategy_groups
                WHERE group_id = ? AND date = ?
                ORDER BY id DESC LIMIT 1
            ''', (group_id, date.today().isoformat()))

            row = cursor.fetchone()
            return dict(row) if row else None
```

**ä¿®å¾©èªªæ˜**ï¼š
1. **æŸ¥è©¢æ¢ä»¶ä¿®æ­£**ï¼šå¾ `WHERE id = ?` æ”¹ç‚º `WHERE group_id = ?`
2. **æ·»åŠ æ—¥æœŸé™åˆ¶**ï¼šç¢ºä¿æŸ¥è©¢ä»Šæ—¥çš„ç­–ç•¥çµ„
3. **æ’åºå–æœ€æ–°**ï¼š`ORDER BY id DESC LIMIT 1` ç¢ºä¿å–å¾—æœ€æ–°è¨˜éŒ„

### å»ºè­°2: æ·»åŠ èª¿è©¦æ—¥èªŒ

åœ¨ `_execute_group_retry` æ–¹æ³•ä¸­æ·»åŠ æ›´è©³ç´°çš„æ—¥èªŒï¼š

```python
self.logger.info(f"ğŸ” [è¿½åƒ¹èª¿è©¦] çµ„{group_id}è©³ç´°ä¿¡æ¯:")
self.logger.info(f"  - æŸ¥è©¢åƒæ•¸: group_id={group_id}")
self.logger.info(f"  - ç­–ç•¥æ–¹å‘: {direction}")
self.logger.info(f"  - DBè¨˜éŒ„ID: {group_info.get('id')}")
self.logger.info(f"  - ä¸‹å–®æ“ä½œ: {'SELL' if direction == 'SHORT' else 'BUY'}")
```

## ğŸ¯ çµè«–

**å•é¡Œæ ¹æº**ï¼šæ•¸æ“šåº«æŸ¥è©¢é‚è¼¯éŒ¯èª¤
- å‚³å…¥ `group_id = 6`ï¼Œä½†æŸ¥è©¢ `WHERE id = 6`
- æ‡‰è©²æŸ¥è©¢ `WHERE group_id = 6`

**ä¿®å¾©æ•ˆæœ**ï¼š
- âœ… çµ„6è¿½åƒ¹æ™‚å°‡æ­£ç¢ºæŸ¥è©¢åˆ° `LONG` æ–¹å‘
- âœ… è¿½åƒ¹å°‡åŸ·è¡Œæ­£ç¢ºçš„ `BUY` æ“ä½œ
- âœ… å¤šå–®è¿½åƒ¹ä¸å†è®Šæˆç©ºå–®

**æ¸¬è©¦å»ºè­°**ï¼š
1. é‡æ–°é‹è¡Œç³»çµ±
2. è§€å¯Ÿè¿½åƒ¹æ™‚çš„æ—¥èªŒè¼¸å‡º
3. ç¢ºèªçµ„ä¿¡æ¯æŸ¥è©¢æ­£ç¢º
